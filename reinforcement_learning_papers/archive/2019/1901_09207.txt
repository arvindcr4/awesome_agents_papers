Published as a conference paper at ICLR 2019

P ROBABILISTIC R ECURSIVE R EASONING FOR
M ULTI -AGENT R EINFORCEMENT L EARNING

arXiv:1901.09207v2 [cs.LG] 1 Mar 2019

Ying Wen§∗ , Yaodong Yang§∗, Rui Luo§ , Jun Wang§ , Wei Pan\
§
University College London, \ Delft University of Technology
{ying.wen,yaodong.yang,rui.luo,jun.wang}@cs.ucl.ac.uk
{wei.pan}@tudelft.nl

A BSTRACT
Humans are capable of attributing latent mental contents such as beliefs or intentions to others. The social skill is critical in daily life for reasoning about the
potential consequences of others’ behaviors so as to plan ahead. It is known that
humans use such reasoning ability recursively by considering what others believe
about their own beliefs. In this paper, we start from level-1 recursion and introduce
a probabilistic recursive reasoning (PR2) framework for multi-agent reinforcement
learning. Our hypothesis is that it is beneficial for each agent to account for how the
opponents would react to its future behaviors. Under the PR2 framework, we adopt
variational Bayes methods to approximate the opponents’ conditional policies, to
which each agent finds the best response and then improve their own policies. We
develop decentralized-training-decentralized-execution algorithms, namely PR2-Q
and PR2-Actor-Critic, that are proved to converge in the self-play scenarios when
there exists one Nash equilibrium. Our methods are tested on both the matrix game
and the differential game, which have a non-trivial equilibrium where common
gradient-based methods fail to converge. Our experiments show that it is critical to
reason about how the opponents believe about what the agent believes. We expect
our work to contribute a new idea of modeling the opponents to the multi-agent
reinforcement learning community.

1

I NTRODUCTION

In the long journey of creating artificial intelligent (AI) that mimics human intelligence, a hallmark
of an AI agent is its capabilities of understanding and interacting with other agents (Lake et al.,
2017). At the cognitive level, the real-world intelligent entities (e.g. rats, humans) are born to be
able to reason about various properties of interests of others (Tolman, 1948; Pfeiffer & Foster, 2013).
Those interests usually indicates unobservable mental state including desires, beliefs, and intentions
(Premack & Woodruff, 1978; Gopnik & Wellman, 1992). In everyday life, people use this inborn
ability to reason about others’ behaviors (Gordon, 1986), plan effective interactions (Gallese &
Goldman, 1998), or match with the folk psychology (Dennett, 1991). It is known that people can
use this reasoning ability recursively; that is, they engage in considering what others believe about
their own beliefs. A number of human social behaviors have been profiled by the recursion reasoning
ability (Pynadath & Marsella, 2005). Behavioral game theorist and experimental psychologist believe
that reasoning recursively is a tool of human cognition that is equipped with evolutionary advantages
(Camerer et al., 2004; 2015; Goodie et al., 2012; Robalino & Robson, 2012).
Traditional approach of constructing the models of other agents, also known as opponent modeling,
has a rich history in the multi-agent learning (Shoham et al., 2007; Albrecht & Stone, 2018). Even
though equipped with modern machine learning methods that could enrich the representation of
the opponent’s behaviors (He et al., 2016), those algorithms tend to only work either under limited
types of scenarios (e.g. mean-field games (Yang et al., 2018)), pre-defined opponent strategies (e.g.
Tit-fot-Tat in iterated Prisoner’s Dilemma (Foerster et al., 2018)), or in cases where opponents are
assumed to constantly return to the same strategy (Da Silva et al., 2006). Recently, a promising
∗
The first two authors have equal contributions. Correspondence to Jun Wang. This work was conducted
during Ying Wen’s internship at MediaGamma Ltd.

1

Published as a conference paper at ICLR 2019

methodology from game theory – recursive reasoning – has become popular in opponent modeling
(Gmytrasiewicz & Durfee, 2000; Camerer et al., 2004; Gmytrasiewicz & Doshi, 2005; De Weerd
et al., 2013b). Similar to the way of thinking adopted by humans, recursive reasoning represents the
belief reasoning process where each agent considers the reasoning process of other agents, based
on which it expects to make better decisions. Importantly, it allows an opponent to reason about the
modeling agent rather than being a fixed type; the process can therefore be nested in a form as "I
believe that you believe that I believe ...". Despite some initial trails (Gmytrasiewicz & Doshi, 2005;
Von Der Osten et al., 2017), there has been little work that tries to adopt this idea into the multi-agent
deep reinforcement learning (DRL) setting. One main reason is that computing the optimal policy is
prohibitively expensive (Doshi & Gmytrasiewicz, 2006; Seuken & Zilberstein, 2008).
In this paper, we introduce a probabilistic recursive reasoning (PR2) framework for multi-agent DRL
tasks. Unlike previous work on opponent modeling, each agent here considers how the opponents
would react to its potential behaviors, before it tries to find the best response for its own decision
making. By employing variational Bayes methods to model the uncertainty of opponents’ conditional
policies, we develop decentralized-training-decentralized-execution algorithms, PR2-Q and PR2Actor-Critic, and prove the convergence in the self-play scenarios when there exists only one Nash
equilibrium. Our methods are tested on the matrix game and the differential game. The games come
with a non-trivial equilibrium where conventional gradient-based methods find challenging. We
compare against multiple strong baselines. The results justify the unique value provided by agent’s
recursive reasoning capability throughout the learning. We expect our work to offer a new angel on
incorporating conditional opponent modeling into the multi-agent DRL context.

2

R ELATED W ORK

Game theorists take initiatives in modeling the recursive reasoning procedures (Harsanyi, 1962; 1967).
Since then, alternative approaches, including logics-based models (Bolander & Andersen, 2011;
Muise et al., 2015) or graphical models (Doshi et al., 2009; Gal & Pfeffer, 2003; 2008), have been
adopted. Recently, the idea of Theory of Mind (ToM) (Goldman et al., 2012) from cognitive science
becomes popular. An example of ToM is the "Recursive Modeling Method" (RMM) (Gmytrasiewicz
et al., 1991; Gmytrasiewicz & Durfee, 1995; 2000), which incorporates the agent’s uncertainty about
opponent’s exact model, payoff, and recursion depth. However, these methods follow the decisiontheoretic approaches, and are studied in the limited context of one-shot games. The environment is
relatively simple and the opponents are not RL agents.
The Interactive POMDP (I-POMDP) (Gmytrasiewicz & Doshi, 2005) implements the idea of ToM
to tackle the multi-agent RL problems. It extends the partially observed MDP (Sondik, 1971) by
introducing an extra space of models of other agents into the MDP; as such, an agent can build belief
models about how it believes other agents know and believe. Despite the added flexibility, I-POMDP
has limitations in its solvability (Seuken & Zilberstein, 2008). Solving I-POMDP with N models
in each recursive level with K maximum level equals to solving O(N K ) PODMPs. Such inherent
complexity requires high precision on the approximation solution methods, including particle filtering
(Doshi & Gmytrasiewicz, 2009), value iteration (Doshi & Perez, 2008), or policy iteration (Sonu &
Doshi, 2015). Out work is different from I-POMDP in that we do not adjust the MDP; instead, we
provide a probabilistic framework to implement the recursive reason in the MDP. We approximate the
opponent’s conditional policy through variational Bayes methods. The induced PR2-Q and PR2-AC
algorithms are model-free and can practically be used as the replacement to other multi-agent RL
algorithms such as MADDPG (Lowe et al., 2017).
Our work can also be tied into the study of opponent modeling (OM) Albrecht & Stone (2018). OM
is all about shaping the anticipated movements of the other agents. Traditional OM can be regarded as
level-0 recursive reasoning in that OM methods model how the opponent behaves based on the history,
but not how the opponent would behave based on what I would behave. In general, OM methods
have two major limitations. One is that OM tends to work with a pre-defined target of opponents; for
example, fictitious play (Brown, 1951) and joint-action learners (Claus & Boutilier, 1998) require
opponents play stationary strategies, Nash-Q (Hu & Wellman, 2003) require all agents play towards
the Nash equilibrium, so do Correlated Q-learning (Greenwald et al., 2003), Minimax-Q (Littman,
1994), and Friend-or-foe Q (Littman, 2001). These algorithms become invalid if the opponents
change their types of policy. The other major limitation is that OM algorithms require to know the
2

Published as a conference paper at ICLR 2019

⇡ i (ai |s)

⇡ i (ai |s)

<latexit sha1_base64="9K/RTgBV+CUaKdW437/SsOT/JZ0=">AAAB+3icbVC7TsMwFL3hWcorlJHFokUqS5WwwFgJBsYi0YfUhuK4TmvVcSLbQVQhv8LCAEKs/Agbf4PTdoCWI92ro3Pula+PH3OmtON8Wyura+sbm4Wt4vbO7t6+fVBqqSiRhDZJxCPZ8bGinAna1Exz2oklxaHPadsfX+Z++4FKxSJxqycx9UI8FCxgBGsj9e1SpRezu5RlVZz3J3Va6dtlp+ZMgZaJOyfleiUI7gGg0be/eoOIJCEVmnCsVNd1Yu2lWGpGOM2KvUTRGJMxHtKuoQKHVHnp9PYMnRhlgIJImhIaTdXfGykOlZqEvpkMsR6pRS8X//O6iQ4uvJSJONFUkNlDQcKRjlAeBBowSYnmE0MwkczcisgIS0y0iatoQnAXv7xMWmc116m5N265fgUzFOAIjqEKLpxDHa6hAU0g8AjP8ApvVma9WO/Wx2x0xZrvHMIfWJ8/doGVig==</latexit>
sha1_base64="bfhHlZEH2kNRVUf5CSDdNfbhYsc=">AAAB+3icbVC7TsMwFL0pr1JeoYwsFi1SWaqEBcZKMDAWiT6kNlSO67ZWHSeyHUQV8issDCDEyo+w8Tc4bQZoOdK9OjrnXvn6+BFnSjvOt1VYW9/Y3Cpul3Z29/YP7MNyW4WxJLRFQh7Kro8V5UzQlmaa024kKQ58Tjv+9CrzOw9UKhaKOz2LqBfgsWAjRrA20sAuV/sRu09YWsNZf1Jn1YFdcerOHGiVuDmpQI7mwP7qD0MSB1RowrFSPdeJtJdgqRnhNC31Y0UjTKZ4THuGChxQ5SXz21N0apQhGoXSlNBorv7eSHCg1CzwzWSA9UQte5n4n9eL9ejSS5iIYk0FWTw0ijnSIcqCQEMmKdF8ZggmkplbEZlgiYk2cZVMCO7yl1dJ+7zuOnX31q00rvM4inAMJ1ADFy6gATfQhBYQeIRneIU3K7VerHfrYzFasPKdI/gD6/MHWkWT+g==</latexit>

1

⇢ i (a i |s, ai )
<latexit sha1_base64="b35OXpDH5uIe/x/kOVUrjahSa6A=">AAACAnicbZDLSgMxFIbPeK31NupK3ASrUEHLjBtdFnThsoK9QDvWTJppQzOTIckIZRzc+CpuXCji1qdw59uYXhbaeiDk4//PITm/H3OmtON8W3PzC4tLy7mV/Ora+samvbVdUyKRhFaJ4EI2fKwoZxGtaqY5bcSS4tDntO73L4Z+/Z5KxUR0owcx9ULcjVjACNZGatu7LdkTt+kJy4p4dD2oYwMsO2rbBafkjArNgjuBQvkgCO4AoNK2v1odQZKQRppwrFTTdWLtpVhqRjjN8q1E0RiTPu7SpsEIh1R56WiFDB0apYMCIc2JNBqpvydSHCo1CH3TGWLdU9PeUPzPayY6OPdSFsWJphEZPxQkHGmBhnmgDpOUaD4wgIlk5q+I9LDERJvU8iYEd3rlWaidllyn5F67hfIljCsHe7APRXDhDMpwBRWoAoFHeIZXeLOerBfr3foYt85Zk5kd+FPW5w/0hZie</latexit>
sha1_base64="M/DzVmUMmiTy0/02rYFvG0FnP6s=">AAACAnicbZDLSgMxFIbP1Futt1FX4iZYhApaZtzosqALlxXsBdqxZNJMG8xkhiQjlLG48VXcuFDErU/hzrcxnc5CWw+EfPz/OSTn92POlHacb6uwsLi0vFJcLa2tb2xu2ds7TRUlktAGiXgk2z5WlDNBG5ppTtuxpDj0OW35dxcTv3VPpWKRuNGjmHohHggWMIK1kXr2XlcOo9v0hI0rOLse1LEBNj7q2WWn6mSF5sHNoQx51Xv2V7cfkSSkQhOOleq4Tqy9FEvNCKfjUjdRNMbkDg9ox6DAIVVemq0wRodG6aMgkuYIjTL190SKQ6VGoW86Q6yHatabiP95nUQH517KRJxoKsj0oSDhSEdokgfqM0mJ5iMDmEhm/orIEEtMtEmtZEJwZ1eeh+Zp1XWq7rVbrl3mcRRhHw6gAi6cQQ2uoA4NIPAIz/AKb9aT9WK9Wx/T1oKVz+zCn7I+fwDYSZcO</latexit>

<latexit sha1_base64="i6gwRV0FLTNkAaRJ8qdmpTR0kak=">AAAB9XicbVDLTgJBEOz1ifhCPXqZCCZ4Ibte9EiiB4+YyCOBBXuHWZgwO7uZmdUQ5D+8eNAYr/6LN//G4XFQsJJOKlXd6e4KEsG1cd1vZ2V1bX1jM7OV3d7Z3dvPHRzWdJwqyqo0FrFqBKiZ4JJVDTeCNRLFMAoEqweDq4lff2BK81jemWHC/Ah7koecorFSu9BKeJsXsc2f9Fmhk8u7JXcKsky8OcmXC2F4DwCVTu6r1Y1pGjFpqECtm56bGH+EynAq2DjbSjVLkA6wx5qWSoyY9kfTq8fk1CpdEsbKljRkqv6eGGGk9TAKbGeEpq8XvYn4n9dMTXjpj7hMUsMknS0KU0FMTCYRkC5XjBoxtASp4vZWQvuokBobVNaG4C2+vExq5yXPLXm3Xr58DTNk4BhOoAgeXEAZbqACVaCg4Ble4c15dF6cd+dj1rrizGeO4A+czx9gpZNB</latexit>
sha1_base64="8K5HR7wYidHAhIFlLY3bjODpjis=">AAAB9XicbVA9TwJBEJ3DL8Qv1NJmI5hgQ+5stCTRwhIT+UjgIHvLHmzY273s7mnIyf+wsdAYW/+Lnf/GBa5Q8CWTvLw3k5l5QcyZNq777eTW1jc2t/LbhZ3dvf2D4uFRU8tEEdogkkvVDrCmnAnaMMxw2o4VxVHAaSsYX8/81gNVmklxbyYx9SM8FCxkBBsr9crdmPVYBffYkz4v94slt+rOgVaJl5ESZKj3i1/dgSRJRIUhHGvd8dzY+ClWhhFOp4VuommMyRgPacdSgSOq/XR+9RSdWWWAQqlsCYPm6u+JFEdaT6LAdkbYjPSyNxP/8zqJCa/8lIk4MVSQxaIw4chINIsADZiixPCJJZgoZm9FZIQVJsYGVbAheMsvr5LmRdVzq96dV6rdZHHk4QROoQIeXEINbqEODSCg4Ble4c15dF6cd+dj0Zpzsplj+APn8wdEaZGx</latexit>

Perspective of Agent i:
⇡(ai , a i |s)
⇡ i (ai |s)⇢ i (a i |s, ai )

Opponent Eﬀect

Perspective of Opponent:
⇡(ai , a i |s)
⇡ i (a i |s)⇢i (ai |s, a i )

Best Response

<latexit sha1_base64="+Ltucwlah3u6tTozHWQ46Gp8Zz0=">AAAB6nicbZC7SgNBFIbPeo3xFrW0GUwEq7Bro50BLSwjmgskS5idnE2GzM4uM7NCWPIINhZKsLHwZWztfBsnl0ITfxj4+P9zmHNOkAiujet+Oyura+sbm7mt/PbO7t5+4eCwruNUMayxWMSqGVCNgkusGW4ENhOFNAoENoLB9SRvPKLSPJYPZpigH9Ge5CFn1FjrvsRLnULRLbtTkWXw5lC8+hyP3wGg2il8tbsxSyOUhgmqdctzE+NnVBnOBI7y7VRjQtmA9rBlUdIItZ9NRx2RU+t0SRgr+6QhU/d3R0YjrYdRYCsjavp6MZuY/2Wt1ISXfsZlkhqUbPZRmApiYjLZm3S5QmbE0AJlittZCetTRZmx18nbI3iLKy9D/bzsuWXvzitWbmCmHBzDCZyBBxdQgVuoQg0Y9OAJXuDVEc6zM3beZqUrzrznCP7I+fgBYR+QIg==</latexit>
sha1_base64="j39h6TpjA+3rmTGxWTs97UboLCU=">AAAB6nicbVA9SwNBEJ2LXzF+RS1tFhPBKtzZxDKghWVE8wHJEfY2e8mSvb1jd04IR36CjYUitv4iO/+Nm+QKTXww8Hhvhpl5QSKFQdf9dgobm1vbO8Xd0t7+weFR+fikbeJUM95isYx1N6CGS6F4CwVK3k00p1EgeSeY3Mz9zhPXRsTqEacJ9yM6UiIUjKKVHqqiOihX3Jq7AFknXk4qkKM5KH/1hzFLI66QSWpMz3MT9DOqUTDJZ6V+anhC2YSOeM9SRSNu/Gxx6oxcWGVIwljbUkgW6u+JjEbGTKPAdkYUx2bVm4v/eb0Uw2s/EypJkSu2XBSmkmBM5n+TodCcoZxaQpkW9lbCxlRThjadkg3BW315nbSvap5b8+69SuM2j6MIZ3AOl+BBHRpwB01oAYMRPMMrvDnSeXHenY9la8HJZ07hD5zPH4bRjUg=</latexit>

<latexit sha1_base64="Ll377vlpynLGxThYmnp+57rcoXI=">AAACLnicbVDLSgMxFL3j2/qqunQTbIUKWmbc6LKggksFq0KnrXfSjA1mJkOSUcrYL3Ljr+hCUBG3fobpVMHXgcDhnHO5uSdIBNfGdZ+ckdGx8YnJqenCzOzc/EJxcelEy1RRVqdSSHUWoGaCx6xuuBHsLFEMo0Cw0+Byd+CfXjGluYyPTS9hzQgvYh5yisZK7eJ+2U94BVt8g2Ar2+T9G71OfMFCg0rJa2LdVu5b3VddmWcqX9ENS3h/vdwultyqm4P8Jd4nKdXKYXgOAIft4oPfkTSNWGyoQK0bnpuYZobKcCpYv+CnmiVIL/GCNSyNMWK6meXn9smaVToklMq+2JBc/T6RYaR1LwpsMkLT1b+9gfif10hNuNPMeJykhsV0uChMBTGSDLojHa4YNaJnCVLF7V8J7aJCamzDBVuC9/vkv+Rkq+q5Ve/IK9X2YIgpWIFVqIAH21CDAziEOlC4hXt4hhfnznl0Xp23YXTE+ZxZhh9w3j8AZxmpqg==</latexit>
sha1_base64="KzwBo9QahhkLST4cWISfr9R8GjM=">AAACLnicbVDLSgMxFM3UV62vqks3wVaooGXGjS4LKrisYB/QacudNGNDM5MhyShl7Be58Vd0IaiIWz/DdFpBqwcCh3PO5eYeL+JMadt+sTJz8wuLS9nl3Mrq2vpGfnOrrkQsCa0RwYVseqAoZyGtaaY5bUaSQuBx2vAGp2O/cUOlYiK80sOItgO4DpnPCGgjdfPnRTdiJeiwAwyd5JCN7tQ+djn1NUgpbrFxO6lvdFf2RZopfUcPDGGj/WI3X7DLdgr8lzhTUkBTVLv5J7cnSBzQUBMOSrUcO9LtBKRmhNNRzo0VjYAM4Jq2DA0hoKqdpOeO8J5RetgX0rxQ41T9OZFAoNQw8EwyAN1Xs95Y/M9rxdo/aScsjGJNQzJZ5Mcca4HH3eEek5RoPjQEiGTmr5j0QQLRpuGcKcGZPfkvqR+VHbvsXDqFytm0jizaQbuohBx0jCroAlVRDRF0jx7RK3qzHqxn6936mEQz1nRmG/2C9fkFSt2oGg==</latexit>

2

Mutual
Eﬀects

4

⇡ i (a i |s)
<latexit sha1_base64="IZiH9Q1U2AbRcLUkDkX2gEZuhpA=">AAAB/XicbVC7TsMwFL0pr1Je4bGxWLRIZaBKWGCsBANjkehDakNxXKe16jiR7SCVUPErLAwgxMp/sPE3uGkHKBzp6h6dc698ffyYM6Ud58vKLSwuLa/kVwtr6xubW/b2TkNFiSS0TiIeyZaPFeVM0LpmmtNWLCkOfU6b/vB84jfvqFQsEtd6FFMvxH3BAkawNlLX3it1YnaTHrNxGWftQR2VunbRqTgZ0F/izkixWgqCWwCode3PTi8iSUiFJhwr1XadWHsplpoRTseFTqJojMkQ92nbUIFDqrw0u36MDo3SQ0EkTQmNMvXnRopDpUahbyZDrAdq3puI/3ntRAdnXspEnGgqyPShIOFIR2gSBeoxSYnmI0MwkczcisgAS0y0CaxgQnDnv/yXNE4qrlNxr9xi9QKmyMM+HEAZXDiFKlxCDepA4B6e4AVerUfr2Xqz3qejOWu2swu/YH18A1NHlfg=</latexit>
sha1_base64="g2+vr88Cl8ygeXHPnA6L09rRdMI=">AAAB/XicbVC7TsMwFL0pr1Je4bGxWLRIZaBKWGCsBANjkehDakPluE5r1XEi20EqoeJXWBhAiJX/YONvcNMO0HKkq3t0zr3y9fFjzpR2nG8rt7S8srqWXy9sbG5t79i7ew0VJZLQOol4JFs+VpQzQeuaaU5bsaQ49Dlt+sPLid+8p1KxSNzqUUy9EPcFCxjB2khd+6DUidldesrGZZy1R3VS6tpFp+JkQIvEnZEizFDr2l+dXkSSkApNOFaq7Tqx9lIsNSOcjgudRNEYkyHu07ahAodUeWl2/RgdG6WHgkiaEhpl6u+NFIdKjULfTIZYD9S8NxH/89qJDi68lIk40VSQ6UNBwpGO0CQK1GOSEs1HhmAimbkVkQGWmGgTWMGE4M5/eZE0ziquU3Fv3GL1ahZHHg7hCMrgwjlU4RpqUAcCD/AMr/BmPVkv1rv1MR3NWbOdffgD6/MHNwuUaA==</latexit>

⇡ i (a i |s)
<latexit sha1_base64="IZiH9Q1U2AbRcLUkDkX2gEZuhpA=">AAAB/XicbVC7TsMwFL0pr1Je4bGxWLRIZaBKWGCsBANjkehDakNxXKe16jiR7SCVUPErLAwgxMp/sPE3uGkHKBzp6h6dc698ffyYM6Ud58vKLSwuLa/kVwtr6xubW/b2TkNFiSS0TiIeyZaPFeVM0LpmmtNWLCkOfU6b/vB84jfvqFQsEtd6FFMvxH3BAkawNlLX3it1YnaTHrNxGWftQR2VunbRqTgZ0F/izkixWgqCWwCode3PTi8iSUiFJhwr1XadWHsplpoRTseFTqJojMkQ92nbUIFDqrw0u36MDo3SQ0EkTQmNMvXnRopDpUahbyZDrAdq3puI/3ntRAdnXspEnGgqyPShIOFIR2gSBeoxSYnmI0MwkczcisgAS0y0CaxgQnDnv/yXNE4qrlNxr9xi9QKmyMM+HEAZXDiFKlxCDepA4B6e4AVerUfr2Xqz3qejOWu2swu/YH18A1NHlfg=</latexit>
sha1_base64="g2+vr88Cl8ygeXHPnA6L09rRdMI=">AAAB/XicbVC7TsMwFL0pr1Je4bGxWLRIZaBKWGCsBANjkehDakPluE5r1XEi20EqoeJXWBhAiJX/YONvcNMO0HKkq3t0zr3y9fFjzpR2nG8rt7S8srqWXy9sbG5t79i7ew0VJZLQOol4JFs+VpQzQeuaaU5bsaQ49Dlt+sPLid+8p1KxSNzqUUy9EPcFCxjB2khd+6DUidldesrGZZy1R3VS6tpFp+JkQIvEnZEizFDr2l+dXkSSkApNOFaq7Tqx9lIsNSOcjgudRNEYkyHu07ahAodUeWl2/RgdG6WHgkiaEhpl6u+NFIdKjULfTIZYD9S8NxH/89qJDi68lIk40VSQ6UNBwpGO0CQK1GOSEs1HhmAimbkVkQGWmGgTWMGE4M5/eZE0ziquU3Fv3GL1ahZHHg7hCMrgwjlU4RpqUAcCD/AMr/BmPVkv1rv1MR3NWbOdffgD6/MHNwuUaA==</latexit>

Agent
Execution

3

⇢i (ai |s, a i )
<latexit sha1_base64="tJXLvo19MJmJEjFBBe0SBvYEfg8=">AAACAXicbVC7TsMwFL3hWcorwILEYlGQigRVwgJjJRgYi0QfUluK4zqtVceJbAepCmHhV1gYQIiVv2Djb3DaDtByJPsenXOv7Hu8iDOlHefbmptfWFxazq3kV9fWNzbtre2aCmNJaJWEPJQNDyvKmaBVzTSnjUhSHHic1r3BRebX76lULBQ3ehjRdoB7gvmMYG2kjr3bkv3wNmFpEWf3gzo29YSlRx274JScEdAscSekUD7w/TsAqHTsr1Y3JHFAhSYcK9V0nUi3Eyw1I5ym+VasaITJAPdo01CBA6rayWiDFB0apYv8UJojNBqpvycSHCg1DDzTGWDdV9NeJv7nNWPtn7cTJqJYU0HGD/kxRzpEWRyoyyQlmg8NwUQy81dE+lhiok1oeROCO73yLKmdllyn5F67hfIljJGDPdiHIrhwBmW4ggpUgcAjPMMrvFlP1ov1bn2MW+esycwO/IH1+QOHS5hn</latexit>
sha1_base64="LxsQ07jre8Ab0KSyeDCS/o3D5Fk=">AAACAXicbVDLSgMxFL1TX7W+Rt0IboJFqKBlxo0uC7pwWcE+oB1LJs20wUxmSDJCGceNv+LGhSJu/Qt3/o1pOwttPZDcwzn3ktzjx5wp7TjfVmFhcWl5pbhaWlvf2Nyyt3eaKkokoQ0S8Ui2fawoZ4I2NNOctmNJcehz2vLvLsZ+655KxSJxo0cx9UI8ECxgBGsj9ey9rhxGtynLKnh8P6hjU09YdtSzy07VmQDNEzcnZchR79lf3X5EkpAKTThWquM6sfZSLDUjnGalbqJojMkdHtCOoQKHVHnpZIMMHRqlj4JImiM0mqi/J1IcKjUKfdMZYj1Us95Y/M/rJDo491Im4kRTQaYPBQlHOkLjOFCfSUo0HxmCiWTmr4gMscREm9BKJgR3duV50jytuk7VvXbLtcs8jiLswwFUwIUzqMEV1KEBBB7hGV7hzXqyXqx362PaWrDymV34A+vzB2sPltc=</latexit>

<latexit sha1_base64="6QsNs08dhmroptZrm55N79/qvic=">AAACMHicbZBNS8NAEIYnflu/qh69LLaCgpbEix4LCnpUsCo0bZ1sN3bpJht2N0qJ/Ule/Cl6UVDEq7/CTduDXy8svLzPDLMzQSK4Nq774oyNT0xOTc/MFubmFxaXissr51qmirIalUKqywA1EzxmNcONYJeJYhgFgl0E3YOcX9wwpbmMz0wvYY0Ir2MecorGRq3iUdlP+CY2+TbBZrbD+3d6i/iChQaVkrfE0mbOR8hXHdnMeD9P8mB7SLbKrWLJrbgDkb/GG5lStRyGVwBw0io++m1J04jFhgrUuu65iWlkqAyngvULfqpZgrSL16xubYwR041ssHCfbNikTUKp7IsNGaTfOzKMtO5Fga2M0HT0b5aH/7F6asL9RsbjJDUspsNBYSqIkSS/HmlzxagRPWuQKm7/SmgHFVJjb1ywR/B+r/zXnO9WPLfinXql6iEMNQNrsA6b4MEeVOEYTqAGFO7hCV7hzXlwnp1352NYOuaMelbhh5zPL2JKqrY=</latexit>
sha1_base64="o0/Hz+trc4RToMcGv7lxWzy1yEw=">AAACMHicbZDNSsNAFIUn9b/+RV26GWwFBS2JG10KCrqsYKvQpOVmOmkHJ5kwM1FK7CO58VF0o6CIW5/CSZuFWi8MHM53L3fuCRLOlHacV6s0NT0zOze/UF5cWl5ZtdfWm0qkktAGEVzI6wAU5SymDc00p9eJpBAFnF4FNyc5v7qlUjERX+pBQv0IejELGQFtrI59VvUStgNttoehne2z4b3axR6noQYpxR02tJ3zAnmyL9oZG+ZObuyNyW61Y1ecmjMqPCncQlRQUfWO/eR1BUkjGmvCQamW6yTaz0BqRjgdlr1U0QTIDfRoy8gYIqr8bHTwEG8bp4tDIc2LNR65PycyiJQaRIHpjED31V+Wm/+xVqrDIz9jcZJqGpPxojDlWAucp4e7TFKi+cAIIJKZv2LSBwlEm4zLJgT378mTonlQc52ae+FWjk+LOObRJtpCO8hFh+gYnaM6aiCCHtAzekPv1qP1Yn1Yn+PWklXMbKBfZX19A0YOqSY=</latexit>

Considering
Impact on Opponent

Figure 1: Probabilistic recursive reasoning framework. PR2 decouples the connections between
agents by Eq. 3. 1 : agent i takes the best response after considering all the potential consequences of
opponents’ actions given its own action ai . 2 : how agent i behaves in the environment serves as the
prior for the opponents to learn how their actions would affect ai . 3 : similar to 1 , opponents take
the best response to agent i. 4 : similar to 2 , opponents’ actions are the prior knowledge to agent i
on estimating how ai will affect the opponents. Looping from step 1 to 4 forms recursive reasoning.
exact (Nash) equilibrium policy of the opponent during training. Typical examples include the series
of WoLF models (Bowling, 2005; Bowling & Veloso, 2001a; 2002) or the Nash-Q learning (Hu
& Wellman, 2003), both of which require the Nash Equilibrium at each stage game to update the
Q-function. By contrast, our proposed methods, PR2-Q & PR2-AC, do not need to pre-define the
type of the opponents. Neither do our methods require to know the equilibrium beforehand.
Despite the recent success of applying deep RL algorithms on the single-agent discrete (Mnih et al.,
2015) and continuous (Lillicrap et al., 2015) control problems, it is still challenging to transfer
these methods into the multi-agent RL context. The reason is because learning independently while
ignoring the others in the environment will simply break the theoretical guarantee of convergence
(Tuyls & Weiss, 2012). A modern framework is to maintain a centralized critic (i.e. Q-network)
during training, e.g. MADDPG (Lowe et al., 2017), BiCNet (Peng et al., 2017), and multi-agent
soft Q-learning (Wei et al., 2018); however, they require strong assumptions that the parameters of
agent policies are fully observable, letting alone the centralized Q-network potentially prohibits the
algorithms from scaling up. By contrast, our approach employs decentralized training with no need
to maintain a central critic; neither does it require to know the exact opponents’ policies.

3

P RELIMINARIES

For an n-agent stochastic game (Shapley, 1953), we define a tuple (S, A1, . . . , An, r 1, . . . , r n, p, γ),
where S denotes the state space, p is the distribution of the initial state, γ is the discount factor for
future rewards, Ai and r i = r i (s, ai, a−i ) are the action space and the reward function for agent
i ∈ {1, . . . , n} respectively. Agent i chooses its action ai ∈ Ai according to the policy πθi i (ai |s)
parameterized by θ i conditioning on some given state s ∈ S. Let us define the joint policy as the
collection of all agents’ policies πθ with θ representing the joint parameter. It is convenient to
interpret the joint policy from the perspective of agent i such that πθ = (πθi i (ai |s), πθ−i−i (a−i |s)),
where a−i = (a j ) j6=i , θ −i = (θ j ) j6=i , and πθ−i−i (a−i |s) is a compact representation of the joint policy
of all complementary agents of i. At each stage of the game, actions are taken simultaneously. Each
agent is presumed to pursue the maximal cumulative reward (Sutton et al., 1998), expressed as
"∞
#
X
i
t i
i −i
max η (πθ ) = E
γ r (st , at , at ) ,
(1)
t=1

with (ati, at−i ) sample from (πθi i , πθ−i−i ). Correspondingly, for the game with (infinite) time horizon,
P∞ l i

−i
i
we can define the state-action Q-function by Qiπθ (st , ati, at−i ) = E
l=0 γ r (st+l, at+l, at+l ) .
3.1

N ON - CORRELATED FACTORIZATION ON THE J OINT P OLICY

In the multi-agent learning tasks, each agent can only control its own action; however, the resulting
reward value depends on other agents’ actions. The Q-function of each agent, Qiπθ , is subject to the
joint policy πθ consisting of all agents’ policies. One common approach is to decouple the joint
policy assuming conditional independence of actions from different agents (Albrecht & Stone, 2018):
πθ (ai, a−i |s) = πθi i (ai |s)πθ−i−i (a−i |s).

(2)

The study regarding the topic of “centralized training with decentralized execution” in the deep RL
domain, including MADDPG (Lowe et al., 2017), COMA (Foerster et al., 2017), MF-AC (Yang et al.,
3

Published as a conference paper at ICLR 2019

2018), Multi-Agent Soft-Q (Wei et al., 2018), and LOLA (Foerster et al., 2018), can be classified
into this category (see more clarifications in Appendix B). Although the non-correlated factorization
of the joint policy simplifies the algorithm, this simplication is vulnerable because it ignores the
agents’ connections, e.g. impacts of one agent’s action on other agents, and the subsequent reactions
from other agents. One might argue that during training, the joint Q-function should potentially
guide each agent to learn to consider and act for the mutual interests of all the agents; nonetheless,
a counter-example is that the non-correlated policy could not even solve the simplest two-player
zero-sum differential game where two agents act in x and y with the reward functions defined by
(xy, −x y). In fact, by following Eq. 2, both agents are reinforced to trace a cyclic trajectory that
never converge to the equilibrium (Mescheder et al., 2017).
It is worth clarifying that the idea of non-correlated policy is still markedly different from the
independent learning (IL). IL is a naive method that completely ignore other agents’ behaviors. The
objective of agent i is simplified to ηi (πθ i ), depending only on i’s own policy πθ i compared to Eq. 1.
As Lowe et al. (2017) has pointed out, in IL, the probability of taking a gradient step in the correct
direction decreases exponentially with the increasing number of agents, letting alone the major issue
of the non-stationary environment due to the independence assumption (Tuyls & Weiss, 2012).

4

M ULTI -AGENT P ROBABILISTIC R ECURSIVE R EASONING

In the previous section, we have shown the weakness of the learning algorithms that build on the noncorrelated factorization on the joint policy. Here we introduce the probabilistic recursive reasoning
approach that aims to capture how the opponents believe about what the agent believes. Under
such setting, we devise a new multi-agent policy gradient theorem. We start from assuming the true
opponent conditional policy πθ−i−i is given, and then move onward to the practical case where it is
approximated through variational inference.
4.1

P ROBABILISTIC R ECURSIVE R EASONING

The issue on the non-correlated factorization is that it fails to help each agent to consider the
consequence of its action on others, which could lead to the ill-posed behaviors in the multi-agent
learning tasks. On the contrary, people explicitly attribute contents such as beliefs, desires, and
intentions to others in daily life. It is known that human beings are capable of using this ability
recursively to make decisions. Inspired by this, here we integrate the concept of recursive reasoning
into the joint policy modeling, and propose the new probabilistic recursive reasoning (PR2) framework.
Specifically, we employ the nested process of belief reasoning where each agent simulates the
reasoning process of other agents, thinking about how its action would affect others, and then make
actions based on such predictions. The process can be nested in a form as "I believe [that you believe
(that I believe)]". Here we start from considering the level-1 recursion, as psychologist have found
that humans tend to reason on average at one or two level of recursion (Camerer et al., 2004), and
levels higher than two do not provide significant benefits (De Weerd et al., 2013a;b; de Weerd et al.,
2017). Based on this, we re-formulate the joint policy by
πθ (ai, a−i |s) = πθi i (ai |s)πθ−i−i (a−i |s, ai ) = πθ−i−i (a−i |s)πθi i (ai |s, a−i ) .
(3)
|
{z
} |
{z
}
Agent i’s perspective

The opponents’ perspective

Similar ways of decomposition can also be found in dual learning (Xia et al., 2017) on machine
translation. From the perspective of agent i, the first equality in Eq. 3 indicates that the joint policy
can be essentially decomposed into two parts. The conditional part πθ−i−i (a−i |s, ai ) represents what
actions would be taken by the opponents given the fact that the opponents know the current state of
environment and agent i’s action; this is based on what agent i believes other opponents might think
about itself. Note that the way of thinking developed by agent i regarding how others would consider
of itself is also shaped by opponents’ original policy πθ−i−i (a−i |s), as this is also how the opponents
actually act in the environment. Taking into account different potential actions that agent i thinks the
opponents would take, agent i uses the marginal policy πθi i (ai |s) to find the best response. To this
end, a level-1 recursive procedure is established: ai → a−i → ai . The same inference logic can be
applied to the opponents from their perspectives, as shown in the second equality of Eq. 3.
Albeit intuitive, Eq. 3 may not be practical due to the requirement on the full knowledge regarding
the actual conditional policy πθ−i−i (a−i |s, ai ). A natural solution is that one approximates the actual
4

Published as a conference paper at ICLR 2019
Decentralized
Training with
Probabilistic
Reasoning

Decentralized
Execution

ρ−i

π −i

πi

ai

a−i

s

ρi

Q−i

Qi

Figure 2: Diagram of multi-agent PR2 learning algorithms. It conducts decentralized training with
decentralized execution. The light grey panels on two sides indicate decentralized execution for each
agent whereas the white counterpart shows the decentralized learning procedure. All agents share the
interaction experiences in the environment inside the dark rectangle in the middle.
−i
i
policy via a best-fit model from a family of distributions. We denote this family as ρ−i
φ −i (a |s, a )
−i
with learnable parameter φ . PR2 is probabilistic as it considers the uncertainty of modeling
πθ−i−i (a−i |s, ai ). The reasoning structure is now established as shown in Fig. 1. With the recursive
joint policy defined in Eq. 3, the n-agent learning task can therefore be formulated as


−i
i
arg max ηi πθi i (ai |s)ρ−i
(a
|s,
a
)
,
(4)
φ −i
θ i ,φ −i



arg max η−i πθ−i−i (a−i |s)ρiφ i (ai |s, a−i ) .

(5)

θ −i ,φ i

With the new learning protocol defined in Eq. 4 and 5, each agent now learns its own policy as
well as the approximated conditional policy of other agents given its own actions. In such a way,
−i
i
both the agent and the opponents can keep track of the joint policy by πθi i (ai |s)ρ−i
φ −i (a |s, a ) →
πθ (ai, a−i |s) ← πθ−i−i (a−i |s)ρiφ i (ai |s, a−i ). Once converged, the resulting approximate satistfies:
−i
−i
i
−i
i
i
−i
πθ (ai, a−i |s) = πθi i (ai |s)ρ−i
φ −i (a |s, a ) = πθ −i (a |s)ρφ i (a |s, a ), according to Eq. 3.
4.2

P ROBABILISTIC R ECURSIVE R EASONING P OLICY G RADIENT

Given the true opponent policy πθ−i−i and that each agent tries to maximize its cumulative return in
the stochastic game with the objective defined in Eq. 1, we establish the policy gradient theorem by
accounting for the PR2 joint policy decomposition in Eq. 3.
Proposition 1. In a stochastic game, under the recursive reasoning framework defined by Eq. 3, the
update for the multi-agent recursive reasoning policy gradient method can be derived as follows:


Z
∇θ i ηi = Es∼p,a i ∼π i ∇θ i log πθi i (ai |s)
πθ−i−i (a−i |s, ai )Qi (s, ai, a−i ) da−i .
(6)
a−i

Proof. See Appendix B.2. 
Proposition 1 states that each agent should improve its policy toward the direction of the best response
after it takes into account all kinds of possibilities of how other agents would react if that action
is taken, which implicitly forms level-1 recursive reasoning. The term of πθ−i−i (a−i |s, ai ) can be
regarded as the posterior estimation of agent i’s belief about how the opponents would respond to
his action ai , given opponents’ true policy πθ−i−i (a−i |s) serving as the prior. Note that compared to
the direction
of policy update in the conventional multi-agent policy gradient theorem (Wei et al.,
R
2018), a−i πθ−i−i (a−i |s)Qi (s, ai, a−i ) da−i , the direction of the gradient update in PR2 is guided by
R
the term a−i πθ−i−i (a−i |s, ai )Qi (s, ai, a−i ) da−i which shapes reward after considering its affect to
opponents.
In practice, agent i might not have access to the opponents’ actual policy parameters θ −i , it is often
−i
i
needed to approximate πθ−i−i (a−i |s, ai ) by ρ−i
φ −i (a |s, a ), thereby we propose Proposition 2.
Proposition 2. In a stochastic game, under the recursive reasoning framework defined by Eq. 3,
−i
i
with the opponent policy approximated by ρ−i
φ −i (a |s, a ), the update for the multi-agent recursive
reasoning policy gradient method can be formulated as follows:
5

Published as a conference paper at ICLR 2019

"

"
∇θ i ηi =Es∼p,a i ∼π i ∇θ i log πθi i (ai |s) · Ea−i ∼ρ−i

φ −i

πθ−i−i (a−i |s, ai )
−i
i
ρ−i
φ −i (a |s, a )

##
Qi (s, ai, a−i )

.

(7)

−i
−i
i
Proof. Substituting the approximated model ρ−i
φ −i (a |s, a ) for the true policy πθ−i in Eq. 6. 

Proposition 2 raises an important point: the difference between decentralized training (algorithms
that do not require the opponents’ policies) with centralized learning (algorithms that require the
opponents’ policies) can in fact be quantified by a term of importance weights, similar to the
connection between on-policy and off-policy methods. If we find a best-fit approximation such that
−i
−i
i
−i
i
ρ−i
φ −i (a |s, a ) → πθ −i (a |s, a ), then Eq.7 collapses into Eq. 6.
Based on Proposition 2, we could provide multi-agent PR2 learning algorithm. As illustrated in
Fig. 2, it is a decentralized-training-with-decentralized-execution algorithm. In this setting, agents
share the experiences in the environment including state and historical joint actions, while each agent
receive its rewards privately. Our method does not require the knowledge of other agents’ policy
parameters. We list the pseudo-code of PR2-AC and PR2-Q in Appendix A. Finally, one last piece
−i
i
missing is how to find the best-fit approximation of ρ−i
φ −i (a |s, a ).
4.3

VARIATIONAL I NFERENCE ON O PPONENT C ONDITIONAL P OLICY

−i
i
We adopt an optimization-based approximation to infer the unobservable ρ−i
φ −i (a |s, a ) via variational inference (Jordan et al., 1999). We first define the trajectory τ up to time t including the
experiences of t consecutive time stages, i.e. τ = [(s1, a1i , a1−i ), . . . , (st , ati, at−i )]. In the probabilistic
reinforcement learning (Levine, 2018), the probability of τ being generated can be derived as
"
#
!
T
T
Y
X
i −i
i
−i
p(τ) = p(s1 )
p(st+1 |st , at , at ) exp
r (st , at , at ) .
(8)
t=1

t=1

Assuming the dynamics is fixed (i.e. the agent can not influence the environment transition prob−i
i
ability), our goal is then to find the best approximation of πθi i (ati |st )ρ−i
φ −i (at |st , at ) such that the
induced trajectory distribution p̂(τ) can match with the true trajectory probability p(τ):
p̂(τ) = p(s1 )

T
Y

−i
i
p(st+1 |st , ati, at−i )πθi i (ati |st )ρ−i
θ −i (at |st , at ).

(9)

t=1

In other words, we can optimize the opponents’ policy ρ−i
φ −i via minimizing the K L-divergence, i.e.
DKL ( p̂(τ)kp(τ)) = −Eτ∼ p̂(τ) [log p(τ) − log p̂(τ)]
t=T
h

X


i
−i
i
=−
Eτ∼ p̂(τ) r i st , ati, at−i + H πθi i ati |st ρ−i
a
|s
,
a
.
−i
t
t
φ

(10)

t=1

Besides the reward term, the objective introduces
an additional term of the conditional entropy on
 −i

i
i
−i
i
the joint policy H πθ i at |st ρφ−i a |st , at that potentially promotes the explorations for both
the agent i’s best response and the opponents’ conditional policy. Note that the entropy here is
conditioning not only on the state st but also on agent i’s action. Minimizing Eq. 10 gives us:
Theorem 1. The optimal Q-function for agent i that satisfies minimizing Eq. 10 is formulated as:
Z
Qiπθ (s, ai ) = log
exp(Qiπθ (s, ai, a−i )) da−i .
(11)
a−i

And the corresponding optimal opponent conditional policy reads:
−i
i
ρ−i
φ −i (a |s, a ) =

1
exp(Qiπθ (s, ai, a−i ) − Qiπθ (s, ai ))
Z

Proof. See Appendix C. 
6

(12)

Published as a conference paper at ICLR 2019
0.70

0.4

200

0.2

100

0.0
0.0

0

0.2

0.4

0.6

0.8

Policy of Agent 1

1.0

(a) IGA dynamics.

0.6

300

Agent Policy

0.65

0.4

200

0.2

100

0.0
0.0

0

0.2

0.4

0.6

0.8

Policy of Agent 1

1.0

(b) PR2-Q dynamics.

0.5

Policy of Agent 1
Policy of Agent 2

0.60

0.4

0.55

Policy

300

400

Policy

0.6

0.8

Iterations

400

Policy of Agent 2

1.0

0.8

Iterations

Policy of Agent 2

1.0

0.50

0.3
0.2

0.45
0.40

0.1

0.35

0.0
0

100

200

300

Iteration

400

500

Opponent Policy
Opponent Policy Estimated by Agent 1
Opponent Policy Estimated by Agent 2
0

100

200

300

Iteration

400

500

(c) PR2-Q Agent Policies. (d) PR2-Q Opponent Policies

Figure 3: Learning paths on the iterated matrix game. Figure (a): IGA; (b)–(d): PR2-Q.
−i
i
Theorem 1 states that the learning of ρ−i
φ −i (a |s, a ) can be further converted to minimizing the K L-divergence between the estimated policy ρ−i
φ −i and the advantage function:


−i
i
i
i −i
i
i
DKL ρ−i
φ −i (a |s, a ) exp(Q (s, a , a ) − Q (s, a )) . We can obtain a solution to Eq. 12 by
maintaining two Q-functions, and then iteratively update them. We prove the convergence under
self-play when there is one equilibrium. This leads to a fixed-point iteration that resembles value
iteration.
Theorem 2. In a symmetric game with only one equilibrium,
and
equilibrium
meets one of

 the

i
i
the conditions:
1)
the
global
optimum,
i.e.
E
Q
(s)
≥
E
Q
(s)
;
2)
a
saddle
point, i.e.





π∗ t
 π t
Eπ∗ Qit (s) ≥ Eπ i Eπ∗−i Qit (s) or Eπ∗ Qit (s) ≥ Eπ∗i Eπ −i Qit (s) ; where Q∗ and π∗ are the
equilibrium value function and policy, respectively. The PR2 soft value iteration operator defined by:
" Z
#
 i 0 0 i 0 −i 
i
i −i
i
i −i
0 −i
TQ (s, a , a ) , r (s, a , a ) + γEs0,(a0 )i ∼ps ,π i log
exp Q (s , (a ) , (a ) ) d(a )
,
(a0 )−i

is a contraction mapping.
Proof. See Appendix D. 
4.4

S AMPLING IN CONTINUOUS ACTION SPACE

−i
i
In continuous controls, getting the actions from the opponent policy ρ−i
φ −i (a |s, a ) is challenging.
In this work, we follow Haarnoja et al. (2017) to adopt the amortized Stein Variational Gradient
Descent (SVGD) (Liu & Wang, 2016; Wang & Liu, 2016) in sampling from the soft Q-function. Com−i
i
pared to MCMC, Amortized SVGD is a computationally-efficient way to estimate ρ−i
φ −i (a |s, a ).
Thanks
to SVGD, agent i is able to reason about potential consequences of opponent bavhaviors
R
−i
−i
i
i
i −i
−i
π
−i
−i
θ (a |s, a )Q (s, a , a ) da , and finally find the corresponding best response.
a

5

E XPERIMENTS

We evaluate the performance of PR2 methods on the iterated matrix games, differential games, and
particle world environment. Those games can by design have a non-trivial equilibrium that requires
certain levels of intelligent reasonings between agents. We compared our algorithm with a series of
baselines. In the matrix game, we compare against IGA (Infinitesimal Gradient Ascent) (Singh et al.,
2000). In the differential games, the baselines from multi-agent learning algorithms are MASQL
(Multi-Agent Soft-Q) (Wei et al., 2018) and MADDPG (Lowe et al., 2017). We also including
independent learning algorithms implemented through DDPG (Lillicrap et al., 2015). To compare
against traditional method of opponent modeling, we include one baseline that is based on DDPG
but with one additional opponent modeling unit that is trained in an online and supervised way to
learn the most recent opponent policy, which is then fed into the critic. Similar approach has been
implemented by Rabinowitz et al. (2018) in realizing machine theory of mind. Besides, we applied
centralized Symplectic Gradient Adjustment (SGA) (Balduzzi et al., 2018) optimization for DDPG
agents (DDPG-SGA), which has recently been found to help converge to a local equilibrium quickly.
For the experiment settings, all the policies and Q-functions are parameterized by the MLP with 2
hidden layers, each with 100 units ReLU activation. The sampling network ξ for the ρ−i
φ −i in SGVD
follows the standard normal distribution. In the iterated matrix game, we trained all the methods
including the baselines for 500 iterations. In the differential game, we trained the agents for 350
iterations with 25 steps per iteration. For the actor-critic methods, we set the exploration noise to 0.1
in first 1000 steps, and the annealing parameters for PR2-AC and MASQL are set to 0.5 to balance
between the exploration and acting as the best response.
7

-10.0

-

-18 22
.0 .0 2019
Published as a conference paper at -2ICLR

.0

2.0
6.0

-30.0
-26.0
-22.0

10

PR2-AC
DDPG-OM
DDPG
DDPG-SGA
MADDPG
MASQL
300
350

20

5

30
50

5

100

-18.0
-14
.0

5

10

-6.0
-14
.0

-6.0
-14
.0
-18.0

-10.0

5

-18 -22
.0 .0

-2.0

-30.0
-26.0
-22.0

0

-10
.0

-18.0
-14
.0

-2.0

-30.0

-2.0

0

2.0
6.0

5

-10
.0

5

(e) MASQL.

-22.0

0

10

-2.0

5

-6.0

5

10

5

-6.0
-14
.0

2.0
6.0

-18 -22
.0 .0

(d) MADDPG.

5

10

-18.0

-10.0 0

-30.0

10

5

-22.0

(f) PR2-AC / DDPG.

5

-6.0

10

-30.0
-26.0
-22.0

-30.0

-22.0

0

10

-2.0

-6.0

5

5

0
-26.0

-18.0
-14
.0

5

10

0

-18 -22
.0 .0

5

-2.0

-6.0

10

5

2.0
6.0

-10
.0

-30.0

5

-6.0

-10.0

-30.0
-26.0
-22.0

0
-22.0

-2.0

-6.0

(c) DDPG-SGA.

-6.0
-14
.0

-18.0
-14
.0

.0

-26.0

-10

-26.0

-6.0
-14
.0

-2.0

5

-18.0

0

10 10

5

(b) DDPG-OM.

-30.0
-26.0
-22.0

5

0

5

-6.0
-14
.0

2.0
6.0

(a) DDPG.

5

-18 -22
.0 .0

-2.0

5

-30.0

10
-10.0

.0

-22.0

10

-2.0

-18.0
-14
.0

-10

-30.0

5

-30.0
-26.0
-22.0

0
-22.0

0

-18.0
-14
.0

.0

-18 -22
.0 .0

-2.0

2.0
6.0

5

-10

-30.0

5

-10.0

-18 -22
.0 .0

-2.0

-30.0
-26.0
-22.0

0
-22.0

-30.0

-2.0

-6.0

10

-10.0
2.0
6.0

5

5

-6.0

10

-22.0

-2.0

5

-18.0
-1
-10 4.0
.0

0
-26.0

.0

-30.0

-22.0

-2.0

-18.0
-14
.0

-10

-18-22
.0 .0

5

-26.0

0
-26.0

.0

-2.0

-30.0
-26.0
-22.0

5

-6.0
-14
.0

-18.0
-14
.0

-10

-18.0

0

2.0
6.0

-30.0
-26.0
-22.0

5

-10.0

-2.0

-6.0
-14
.0

2.0
6.0

-18 -22
.0 .0

-18.0

-2.0

-30.0
-26.0
-22.0

5

250

(b) The learning curves.
-10.0

-18.0

2.0
6.0

200

Iteration

Figure 4: Max of Two Quadratic Game.

-18 -22
.0 .0

-18.0

-10.0

150

-26.0

0

-6.0
-14
.0

5

Action of Agent 1
(a) The learning path of PR2-AC vs.
PR2-AC.

-26.0

10

-18.0

10

-6.0

-26.0

-2.0

0

-18.0

-22.0

-26.0

.0

Return

-10

-18.0

0

-6.
0
-14
.0

10
-18.0
-14
.0

-30.0

Action of Agent 2

5

10

-6.0

5

0

5

(g) PR2-AC / DDPG-OM. (h) PR2-AC / MADDPG.

10

10

5

0

5

(i) PR2-AC / MASQL.

Figure 5: The learning path of Agent 1 (x-axis) vs. Agent 2 (y-axis).
5.1

I TERATED M ATRIX G AME




0 3
3 2
2
In the matrix game, the payoffs are defined by: R =
, and R =
. These
1 2
0 1
exists the only Nash Equilibrium at (0.5, 0.5). This game has been intensively investigated in multiagent studies (Bowling & Veloso, 2001a;b). One reason is that in solving the Nash Equilibrium for
this game, simply taking simultaneous gradient steps on both agent’s value functions will present
the rotational behaviors on the gradient vector field; this leads to an endlessly iterative change of
behaviors. Without considering the consequence of one agent’s action on the other agent beforehand,
it is challenging for both players to find the equilibrium. Similar issue has been found on training the
GANs (Goodfellow et al., 2014; Mescheder et al., 2017)
1



The results are shown in Fig. 3. As expected, IGA fails to converge to the equilibrium but rotate
around the equilibrium point. On the contrary, our method can find precisely the central equilibrium
with a fully distributed fashion (see Fig. 3b). The convergence can also be justified by the agents’
policies in Fig. 3c, and the opponent’s policy that is maintained by each agent in Fig. 3d.
5.2

D IFFERENTIAL G AME

We adopt the same differential game, the Max of Two Quadratic Game, as Panait et al. (2006);
Wei et al. (2018). The agents have continuous action space
 of [−10, 10].
 Each agent’s reward
depends on the joint action following the equations: r 1 a1, a2 = r 2 a1, a2 = max ( f1, f2 ) , where
1
2
1
2
f1 = 0.8 × [−( a 3+5 )2 − ( a 3+5 )2 ], f2 = 1.0 × [−( a 1−5 )2 − ( a 1−5 )2 ] + 10. The task poses a great
challenge to general gradient-based algorithms because gradient tends to points to the sub-optimal
solution. The reward surface is shown in Fig. 4a; there is a local maximum 0 at (−5, −5) and a
global maximum 10 at (5, 5), with a deep valley staying in the middle. If the agents’ policies are
initialized to (0, 0) (the red starred point) that lies within the basin of the left local maximum, the
gradient based methods would tend to fail to find the global maximum equilibrium point due to the
8

Published as a conference paper at ICLR 2019

Cooperative navigation
PR2-AC
MASQL
MADDPG
DDPG-OM
DDPG
0.0 0.3 0.6 0.9
Normalized agent score

Figure 6: Performance of PR2-AC on the Particle World environment. Each bar shows the 0 − 1
normalized score for agent in cooperative navigation task and the normalized advantage score (agent
reward - adversary reward) in a set of competitive tasks. Higher score is better.
valley blocking the upper right area. The pathology of finding a suboptimal Nash equilibrium is also
called relative over-generalization (Wei & Luke, 2016).
We present the results in Fig. 4b, PR2-AC shows superior performance that manages to converge
to the global equilibrium, while all the other baselines fall into the local basin on the left, except
that the MASQL has small chance to find the optimal point. On top of the convergence result, it is
worth noting that as the temperature annealing is required for energy-based RL methods, the learning
outcomes of MASQL are extremely sensitive to the way of annealing, i.e. when and how to anneal
the temperature to a small value during training is non-trivial. However, our method does not need
to tune the the annealing parameter at all because the each agent is acting the best response to the
approximated conditional policy, considering all potential consequences of the opponent’s response.
Interestingly, by comparing the learning path in Fig. 4a against Fig. 5(a-e) where the scattered blue
dots are the exploration trails at the beginning, we can tell that if the PR2-AC model finds the peak
point in joint action space, the agents can quickly go through the shortcut out of the local basin in a
clever way, while other algorithms just converge to the local equilibrium. This further justifies the
effectiveness and benefits of conducting recursive reasoning with opponents. Apart from testing in
the self-play setting, we also test the scenario when the opponent type is different. We pair PR2-AC
with all four baseline algorithms in Fig. 5(f-i). Similar result can be found, that is, algorithm that has
the function of taking into account the opponents (i.e. DDPG_OM & MADDPG) can converge to
the local equilibrium even though not global, while DDPG and MASQL completely fails due to the
inborn defect from the independent learning methods.

5.3

PARTICLE W ORLD E NVIRONMENTS

We further test our method on the multi-state multi-player Particle World Environments (Lowe
et al., 2017). This includes four testing scenarios: 1) Cooperative Navigation with 3 agents and 3
landmarks. Agents are collectively rewarded based on the proximity of any agent to each landmark
while avoiding collisions; 2) Physical Deception with 1 adversary, 2 good agents, and 2 landmarks.
All agents observe the positions of landmarks and other agents. Only one landmark is the true target
landmark. Good agents are rewarded based on how close any of them is to the target landmark, and
how well they deceive the adversary; 3) Keep-away with 1 agent, 1 adversary, and 1 landmark. Agent
is rewarded based on distance to landmark. Adversary is rewarded if it push away the agent from the
landmark; 4) Predator-prey with 1 prey agent who moves faster try to run away from 3 adversary
predator who move slower but are motivated to catch the prey cooperatively.
The PR2 methods are compared against a series of the centralized MARL methods in Fig. 6. Under
the fully-cooperative setting (the left plot), PR2AC achieves the best performance over all baselines,
even though it is a decentralized algorithm that does not have access to the exact opponent policies.
Under the competitive settings where PR2AC rivals against the a set of adversary baselines, we find
that PR2AC learners can beat all the baselines, including DDPG, DDPG-OM, and MASQL. The only
exception is MADDPG, as it is suggested by the drop-down arrow. PR2AC performs particularly
bad on the physical deception task. We believe it is mainly because the centralized critic can access
the full knowledge of the exact policies of PR2-AC, but PR2-AC cannot access the models of its
opponents in the reversed way; this could place PR2-AC in an inferior position during testing time as
its deceptive strategy has been found out by the opponents already during training.
9

Published as a conference paper at ICLR 2019

6

C ONCLUSION

Inspired by the recursive reasoning capability of human intelligence, in this paper, we introduce a
probabilistic recursive reasoning framework for multi-agent RL that follows "I believe that you believe
that I believe". We adopt variational Bayes methods to approximate the opponents’ conditional policy,
to which each agent finds the best response and then improve their own policy. The training and
execution is full decentralized and the resulting algorithms, PR2-Q and PR2-AC, converge in selfplay when there is one Nash equilibrium. Our results on three kinds of testing beds with increasing
complexity justify the advantages of learning to reason about the opponents in a recursive manner. In
the future, we plan to investigate other approximation methods for the PR2 framework, and test our
PR2 algorithm for the coordination task between AI agents such as coordinating autonomous cars
before the traffic light.
ACKNOWLEDGMENTS
We thank Zheng Tian and Minne Li for useful discussions. Ying Wen was partially funded by
MediaGamma Ltd.

R EFERENCES
Stefano V Albrecht and Peter Stone. Autonomous agents modelling other agents: A comprehensive
survey and open problems. Artificial Intelligence, 258:66–95, 2018.
David Balduzzi, Sebastien Racaniere, James Martens, Jakob Foerster, Karl Tuyls, and Thore Graepel.
The mechanics of n-player differentiable games. arXiv preprint arXiv:1802.05642, 2018.
Dipyaman Banerjee and Sandip Sen. Reaching pareto-optimality in prisoner’s dilemma using
conditional joint action learning. Autonomous Agents and Multi-Agent Systems, 15(1):91–108,
2007.
Thomas Bolander and Mikkel Birkegaard Andersen. Epistemic planning for single-and multi-agent
systems. Journal of Applied Non-Classical Logics, 21(1):9–34, 2011.
Michael Bowling. Convergence and no-regret in multiagent learning. In Advances in neural
information processing systems, pp. 209–216, 2005.
Michael Bowling and Manuela Veloso. Convergence of gradient dynamics with a variable learning
rate. In ICML, pp. 27–34, 2001a.
Michael Bowling and Manuela Veloso. Rational and convergent learning in stochastic games. In
International joint conference on artificial intelligence, volume 17, pp. 1021–1026. Lawrence
Erlbaum Associates Ltd, 2001b.
Michael Bowling and Manuela Veloso. Multiagent learning using a variable learning rate. Artificial
Intelligence, 136(2):215–250, 2002.
George W Brown. Iterative solution of games by fictitious play. Activity analysis of production and
allocation, 13(1):374–376, 1951.
Colin F Camerer, Teck-Hua Ho, and Juin-Kuan Chong. A cognitive hierarchy model of games. The
Quarterly Journal of Economics, 119(3):861–898, 2004.
Colin F Camerer, Teck-Hua Ho, and Juin Kuan Chong. A psychological approach to strategic thinking
in games. Current Opinion in Behavioral Sciences, 3:157–162, 2015.
Caroline Claus and Craig Boutilier. The dynamics of reinforcement learning in cooperative multiagent
systems. AAAI/IAAI, 1998:746–752, 1998.
Bruno C Da Silva, Eduardo W Basso, Ana LC Bazzan, and Paulo M Engel. Dealing with nonstationary environments using context detection. In Proceedings of the 23rd international conference on Machine learning, pp. 217–224. ACM, 2006.
10

Published as a conference paper at ICLR 2019

Harmen De Weerd, Rineke Verbrugge, and Bart Verheij. Higher-order theory of mind in negotiations
under incomplete information. In International Conference on Principles and Practice of MultiAgent Systems, pp. 101–116. Springer, 2013a.
Harmen De Weerd, Rineke Verbrugge, and Bart Verheij. How much does it help to know what she
knows you know? an agent-based simulation study. Artificial Intelligence, 199:67–92, 2013b.
Harmen de Weerd, Rineke Verbrugge, and Bart Verheij. Negotiating with other minds: the role of
recursive theory of mind in negotiation with incomplete information. Autonomous Agents and
Multi-Agent Systems, 31(2):250–287, 2017.
Daniel C Dennett. Two contrasts: folk craft versus folk science, and belief versus opinion. The future
of folk psychology: Intentionality and cognitive science, pp. 135–148, 1991.
Prashant Doshi and Piotr J Gmytrasiewicz. On the difficulty of achieving equilibrium in interactive
pomdps. In PROCEEDINGS OF THE NATIONAL CONFERENCE ON ARTIFICIAL INTELLIGENCE, volume 21, pp. 1131. Menlo Park, CA; Cambridge, MA; London; AAAI Press; MIT
Press; 1999, 2006.
Prashant Doshi and Piotr J Gmytrasiewicz. Monte carlo sampling methods for approximating
interactive pomdps. Journal of Artificial Intelligence Research, 34:297–337, 2009.
Prashant Doshi and Dennis Perez. Generalized point based value iteration for interactive pomdps. In
AAAI, pp. 63–68, 2008.
Prashant Doshi, Yifeng Zeng, and Qiongyu Chen. Graphical models for interactive pomdps: representations and solutions. Autonomous Agents and Multi-Agent Systems, 18(3):376, 2009.
Jakob Foerster, Gregory Farquhar, Triantafyllos Afouras, Nantas Nardelli, and Shimon Whiteson.
Counterfactual multi-agent policy gradients. arXiv preprint arXiv:1705.08926, 2017.
Jakob Foerster, Richard Y Chen, Maruan Al-Shedivat, Shimon Whiteson, Pieter Abbeel, and Igor
Mordatch. Learning with opponent-learning awareness. In Proceedings of the 17th International
Conference on Autonomous Agents and MultiAgent Systems, pp. 122–130. International Foundation
for Autonomous Agents and Multiagent Systems, 2018.
Roy Fox, Ari Pakman, and Naftali Tishby. Taming the noise in reinforcement learning via soft
updates. In Proceedings of the Thirty-Second Conference on Uncertainty in Artificial Intelligence,
pp. 202–211. AUAI Press, 2016.
Ya’akov Gal and Avi Pfeffer. A language for modeling agents’ decision making processes in games.
In Proceedings of the second international joint conference on Autonomous agents and multiagent
systems, pp. 265–272. ACM, 2003.
Ya’akov Gal and Avi Pfeffer. Networks of influence diagrams: a formalism for representing agents’
beliefs and decision-making processes. Journal of Artificial Intelligence Research, 33:109–147,
2008.
Vittorio Gallese and Alvin Goldman. Mirror neurons and the simulation theory of mind-reading.
Trends in cognitive sciences, 2(12):493–501, 1998.
Piotr J Gmytrasiewicz and Prashant Doshi. A framework for sequential planning in multi-agent
settings. Journal of Artificial Intelligence Research, 24:49–79, 2005.
Piotr J Gmytrasiewicz and Edmund H Durfee. A rigorous, operational formalization of recursive
modeling. In ICMAS, pp. 125–132, 1995.
Piotr J Gmytrasiewicz and Edmund H Durfee. Rational coordination in multi-agent environments.
Autonomous Agents and Multi-Agent Systems, 3(4):319–350, 2000.
Piotr J Gmytrasiewicz, Edmund H Durfee, and David K Wehe. A decision-theoretic approach to
coordinating multi-agent interactions. In IJCAI, volume 91, pp. 63–68, 1991.
Alvin I Goldman et al. Theory of mind. The Oxford handbook of philosophy of cognitive science, pp.
402–424, 2012.
11

Published as a conference paper at ICLR 2019

Ian Goodfellow, Jean Pouget-Abadie, Mehdi Mirza, Bing Xu, David Warde-Farley, Sherjil Ozair,
Aaron Courville, and Yoshua Bengio. Generative adversarial nets. In Advances in neural information processing systems, pp. 2672–2680, 2014.
Adam S Goodie, Prashant Doshi, and Diana L Young. Levels of theory-of-mind reasoning in
competitive games. Journal of Behavioral Decision Making, 25(1):95–108, 2012.
Alison Gopnik and Henry M Wellman. Why the child’s theory of mind really is a theory. Mind &
Language, 7(1-2):145–171, 1992.
Robert M Gordon. Folk psychology as simulation. Mind & Language, 1(2):158–171, 1986.
Amy Greenwald, Keith Hall, and Roberto Serrano. Correlated q-learning. In ICML, volume 3, pp.
242–249, 2003.
Tuomas Haarnoja, Haoran Tang, Pieter Abbeel, and Sergey Levine. Reinforcement learning with
deep energy-based policies. arXiv preprint arXiv:1702.08165, 2017.
John C Harsanyi. Bargaining in ignorance of the opponent’s utility function. Journal of Conflict
Resolution, 6(1):29–38, 1962.
John C Harsanyi. Games with incomplete information played by bayesian players, i–iii part i. the
basic model. Management science, 14(3):159–182, 1967.
He He, Jordan Boyd-Graber, Kevin Kwok, and Hal Daumé III. Opponent modeling in deep reinforcement learning. In International Conference on Machine Learning, pp. 1804–1813, 2016.
Junling Hu and Michael P Wellman. Nash q-learning for general-sum stochastic games. Journal of
machine learning research, 4(Nov):1039–1069, 2003.
Michael I Jordan, Zoubin Ghahramani, Tommi S Jaakkola, and Lawrence K Saul. An introduction to
variational methods for graphical models. Machine learning, 37(2):183–233, 1999.
Brenden M Lake, Tomer D Ullman, Joshua B Tenenbaum, and Samuel J Gershman. Building
machines that learn and think like people. Behavioral and Brain Sciences, 40, 2017.
Sergey Levine. Reinforcement learning and control as probabilistic inference: Tutorial and review.
arXiv preprint arXiv:1805.00909, 2018.
Timothy P Lillicrap, Jonathan J Hunt, Alexander Pritzel, Nicolas Heess, Tom Erez, Yuval Tassa,
David Silver, and Daan Wierstra. Continuous control with deep reinforcement learning. arXiv
preprint arXiv:1509.02971, 2015.
Michael L Littman. Markov games as a framework for multi-agent reinforcement learning. In
Machine Learning Proceedings 1994, pp. 157–163. Elsevier, 1994.
Michael L Littman. Friend-or-foe q-learning in general-sum games. In ICML, volume 1, pp. 322–328,
2001.
Qiang Liu and Dilin Wang. Stein variational gradient descent: A general purpose bayesian inference
algorithm. In Advances In Neural Information Processing Systems, pp. 2378–2386, 2016.
Ryan Lowe, Yi Wu, Aviv Tamar, Jean Harb, OpenAI Pieter Abbeel, and Igor Mordatch. Multi-agent
actor-critic for mixed cooperative-competitive environments. In Advances in Neural Information
Processing Systems, pp. 6379–6390, 2017.
Lars Mescheder, Sebastian Nowozin, and Andreas Geiger. The numerics of gans. In Advances in
Neural Information Processing Systems, pp. 1825–1835, 2017.
Volodymyr Mnih, Koray Kavukcuoglu, David Silver, Andrei A Rusu, Joel Veness, Marc G Bellemare,
Alex Graves, Martin Riedmiller, Andreas K Fidjeland, Georg Ostrovski, et al. Human-level control
through deep reinforcement learning. Nature, 518(7540):529, 2015.
12

Published as a conference paper at ICLR 2019

Christian J Muise, Vaishak Belle, Paolo Felli, Sheila A McIlraith, Tim Miller, Adrian R Pearce, and
Liz Sonenberg. Planning over multi-agent epistemic states: A classical planning approach. In
AAAI, pp. 3327–3334, 2015.
Liviu Panait, Sean Luke, and R Paul Wiegand. Biasing coevolutionary search for optimal multiagent
behaviors. IEEE Transactions on Evolutionary Computation, 10(6):629–645, 2006.
Peng Peng, Ying Wen, Yaodong Yang, Quan Yuan, Zhenkun Tang, Haitao Long, and Jun Wang.
Multiagent bidirectionally-coordinated nets: Emergence of human-level coordination in learning
to play starcraft combat games. arXiv preprint arXiv:1703.10069, 2017.
Brad E Pfeiffer and David J Foster. Hippocampal place-cell sequences depict future paths to
remembered goals. Nature, 497(7447):74, 2013.
David Premack and Guy Woodruff. Does the chimpanzee have a theory of mind? Behavioral and
brain sciences, 1(4):515–526, 1978.
David V Pynadath and Stacy C Marsella. Psychsim: Modeling theory of mind with decision-theoretic
agents. In IJCAI, volume 5, pp. 1181–1186, 2005.
Neil C Rabinowitz, Frank Perbet, H Francis Song, Chiyuan Zhang, SM Eslami, and Matthew
Botvinick. Machine theory of mind. arXiv preprint arXiv:1802.07740, 2018.
Nikolaus Robalino and Arthur Robson. The economic approach to ’theory of mind’. Phil. Trans. R.
Soc. B, 367(1599):2224–2233, 2012.
Sven Seuken and Shlomo Zilberstein. Formal models and algorithms for decentralized decision
making under uncertainty. Autonomous Agents and Multi-Agent Systems, 17(2):190–250, 2008.
Lloyd S Shapley. Stochastic games. Proceedings of the national academy of sciences, 39(10):
1095–1100, 1953.
Yoav Shoham, Rob Powers, Trond Grenager, et al. If multi-agent learning is the answer, what is the
question? Artificial Intelligence, 171(7):365–377, 2007.
Satinder Singh, Michael Kearns, and Yishay Mansour. Nash convergence of gradient dynamics
in general-sum games. In Proceedings of the Sixteenth conference on Uncertainty in artificial
intelligence, pp. 541–548. Morgan Kaufmann Publishers Inc., 2000.
Edward Jay Sondik. The optimal control of partially observable markov processes. Technical report,
STANFORD UNIV CALIF STANFORD ELECTRONICS LABS, 1971.
Ekhlas Sonu and Prashant Doshi. Scalable solutions of interactive pomdps using generalized and
bounded policy iteration. Autonomous Agents and Multi-Agent Systems, 29(3):455–494, 2015.
Richard S Sutton, Andrew G Barto, et al. Reinforcement learning: An introduction. MIT press, 1998.
Richard S Sutton, David A McAllester, Satinder P Singh, and Yishay Mansour. Policy gradient methods for reinforcement learning with function approximation. In Advances in neural information
processing systems, pp. 1057–1063, 2000.
Edward C Tolman. Cognitive maps in rats and men. Psychological review, 55(4):189, 1948.
Karl Tuyls and Gerhard Weiss. Multiagent learning: Basics, challenges, and prospects. Ai Magazine,
33(3):41, 2012.
Friedrich Burkhard Von Der Osten, Michael Kirley, and Tim Miller. The minds of many: opponent
modelling in a stochastic game. In Proceedings of the 25th International Joint Conference on
Artificial Intelligence (IJCAI), AAAI Press, pp. 3845–3851, 2017.
Dilin Wang and Qiang Liu. Learning to draw samples: With application to amortized mle for
generative adversarial learning. arXiv preprint arXiv:1611.01722, 2016.
Ermo Wei and Sean Luke. Lenient learning in independent-learner stochastic cooperative games. The
Journal of Machine Learning Research, 17(1):2914–2955, 2016.
13

Published as a conference paper at ICLR 2019

Ermo Wei, Drew Wicke, David Freelan, and Sean Luke. Multiagent soft q-learning. AAAI, 2018.
Yingce Xia, Tao Qin, Wei Chen, Jiang Bian, Nenghai Yu, and Tie-Yan Liu. Dual supervised learning.
arXiv preprint arXiv:1707.00415, 2017.
Yaodong Yang, Rui Luo, Minne Li, Ming Zhou, Weinan Zhang, and Jun Wang. Mean field multiagent reinforcement learning. In Jennifer Dy and Andreas Krause (eds.), Proceedings of the 35th
International Conference on Machine Learning, volume 80 of Proceedings of Machine Learning
Research, pp. 5571–5580, Stockholmsmassan, Stockholm Sweden, 10–15 Jul 2018. PMLR.

14

Published as a conference paper at ICLR 2019

A PPENDIX
A

D ECENTRALIZED M ULTI -AGENT P ROBABILISTIC R ECURSIVE R EASONING A LGORITHMS

Algorithm 1 gives the step by step learning procedures for PR2-AC algorithm.
Algorithm 1: Multi-Agent Probabilistic Recursive Reasoning Actor Critic (PR2-AC).
Result: Policy:π i , Opponent Recursive Reasoning: ρ−i (a−i |s, ai ).
Initialize parameters θ i, φ−i, ωi for each agent i, and the random process N for action exploration.
i0
i
i0
i
2 Assign target parameters of joint action Q-function: ω ← ω , and target policy parameter: θ ← θ
i
3 D ← empty replay buffer for each agent.
4 for each episode do
5
Initialize random process N for action exploration.
6
for each step t do
7
Given the current s, for each agent i, select action ai = µiθ i (s) + Nt ;
8
Take the joint action (ai, a−i ) and observe own reward r i and new state s0 ;
9
Add the tuple (s, ai, a−i, r i, s0 ) in corresponding replay buffer Di ;
10
s ← s0 ;
11
for each agent i do
i 0
N
i
12
Sample a random mini-batch {(s, aij , a−i
j , r j , s j )} j=0 from D ;
13
Get ai0j = µi0θ i for each state s0j ;
−i
−i0 M
0 i0
i0
0
14
Sample {ak,
j }k=0 ∼ ρφ −i (·|s j , a j ) for each a j and s j ;
P
M
1
0 i0 −i0
i
15
Set y ij = r ji + γ M
k=0 Q µ i0 (s , a , ak, j );
2
PN 
i
i −i
16
Update the critic by minimizing the loss L(ωi ) = N1
j=0 y j − Q µ i (s j , a j , a j ) ;
1

Update the actor using the sampled policy gradient:

17

N

∇θ i η i ≈

M

1 X
1 X i
−i
∇θ i µi (s j ) ∇a i
Q µ i (s j , aij , ak,
j );
N j=0
M
k=0

Compute ∆ρ−i
φ −i using empirical estimation:

18
19

 


i
κ at−i, ρ−i
·;
s
,
a
∇ã−i Qi st , ati, ã−i ã−i =a−i
−i
t t
φ
t
φ −i




i
+ κ ã−i, ρ−i
∇ã−i |ã−i =a−i
,
φ −i ·; st , at
t

i
−i
−i
∆ρ−i
φ −i (·|s, a ) =E at ∼ρ

20
21
22
23
24

where κ is a kernel function;
ˆ φ−i Jρ−i ;
Compute empirical gradient ∇
−i
ˆ φ−i Jρ−i ;
Update φ according to ∇
end
Update target network parameters for each agent i:

25

θ i0 ← λθ i + (1 − λ)θ i0 ;
ωi0 ← λωi + (1 − λ)ωi0 ;
26
27

end
end

The Algorithm 2 shows the variant of Decentralized Multi-Agent Probabilistic Recursive Reasoning.
We can simply approximate the ρ−i (a−i |s, ai ) by counting:ρ−i (a−i |s, ai ) = C(ai, a−i, s)/C(ai, s)
in tabular if the state-action space is small, where C is the counting function. It this case, an agent
15

Published as a conference paper at ICLR 2019

Algorithm 2: Multi-Agent Probabilistic Recursive Reasoning Q-Learning (PR2-Q).
x Result: Policy: π i , Opponent Recursive Reasoning: ρ−i (a−i |s, ai ).
i
i −i
2 Initialize Q (s, a , a
) arbitrarily, set α as the learning rate, γ as discount factor;
3 while not converge do
4
Given the current s, calculate the opponent best response ρ−i (a−i |s, ai ) according to:
1

5

1
exp(Qi (s, ai, a−i ) − Qi (s, ai ))
Z
Select and sample action ai based on the Recursive Reasoning ρ−i (a−i |s, ai );
ρ−i (a−i |s, ai ) =

6
7

Z

ρ−i (a−i |s, ai )Qi (s, ai, a−i ))

softmax(
a−i

Observing joint-action (ai, a−i ), reward r i , and next state s0 ;

8
9

Qi (s, ai, a−i ) ← (1 − α)Qi (s, ai, a−i ) + α(r i + γV i (s0 ))
Qi (s, ai ) ← (1 − α)Qi (s, ai ) + α(r i + γV i (s0 ))
where,
V i (s) = max
i

Z

a

10

ρ−i (a−i |s, ai )Qi (s, ai, a−i )
a−i

end

only needs to learn a joint action Q-function, and if the game is static, our method would degenerate
to Conditional Joint Action Learning (CJAL) (Banerjee & Sen, 2007).
B

M ULTI -AGENT P OLICY G RADIENT

B.1

M ULTI -AGENT N ON - CORRELATED P OLICY G RADIENT






Since πθ ai, a−i |s = πθi i ai πθ−i−i a−i |,ai = πθ−i−i a−i |s πθi i ai |s, a−i , πθ ai, a−i |s can be
factorized as πθi i (ai |s)πθ−i−i (a−i |s) if ai and a−i are non-correlated. We follow the policy gradient
formulation (Sutton et al., 2000; Wei et al., 2018) using Leibniz integral rule and Fubini’s theorem
which can give us Multi-Agent Non-correlated Policy Gradient:
Z Z Z
i
η =
π(ai, a−i |s)Qi (s, ai, a−i ) da−i dai ds
s a i a−i
Z Z Z
=
π i (ai |s)π −i (a−i |s)Qi (s, ai, a−i ) da−i dai ds
(13)
i
−i
s a
a
Z Z
Z
=
π i (ai |s)
π −i (a−i |s)Qi (s, ai, a−i ) da−i dai ds.
s

ai

a−i

Suppose the π i (ai ) is parameterized by θ i , and we apply the gradient over the ηi :
Z Z

Z

π −i (a−i |s)Qi (s, ai, a−i ) da−i dai ds
Z
i i
=Es∼p,a i ∼π i [∇θ i log π (a |s)
π −i (a−i |s)Qi (s, ai, a−i ) da−i ].

∇θ i η i =

s

ai

∇θ i πθi i (ai |s)

a−i

(14)

a−i

In practice, off-policy is more data-efficient. In MADDPG (Lowe et al., 2017) and COMA (Foerster
et al., 2017), the replay buffer is introduced in a centralized deterministic actor-critic method for
off-policy training. They apply batch sampling to the centralized critic which gives the joint-action
Q-values:
∇θ i ηi = Es,a i ,a−i ∼D [∇θ i µiθ i (ai |s)∇a i Qi (s, ai, a−i )|a i =µ i (s) ].
(15)
16

Published as a conference paper at ICLR 2019

B.2

M ULTI -AGENT R ECURSIVE R EASONING P OLICY G RADIENT

Proposition 1. In a stochastic game, under the recursive reasoning framework defined by Eq. 3, the
update rule for the multi-agent recursive reasoning policy gradient method can be devised as follows:


Z
∇θ i ηi = Es∼p,a i ∼π i ∇θ i log πθi i (ai |s)
πθ−i−i (a−i |s, ai )Qi (s, ai, a−i ) da−i .
(16)
a−i

Proof: As following.
If we apply the chain rule to factorize the joint policy to: πθ (ai, a−i |s) = πθi i (ai |s)πθ−i−i (a−i |s, ai ).
Then, we can have multi-agent recursive reasoning objective function as:
Z Z Z
i
η =
π(ai, a−i |s)Qi (ai, a−i ) da−i dai ds
s a i a−i
Z Z
Z
(17)
=
π i (ai |s)
π −i (a−i |s, ai )Qi (s, ai, a−i ) da−i dai ds.
s

ai

a−i

Compare to Eq. 13, a−i in Eq. 17 is additionally conditioned on ai . We introduce agent i’a action
ai into other agents’s policies, leading to π −i (a−i |s, ai ). We now compute the policy gradient
analytically. Following the single agent Policy Gradient Theorem with Leibniz integral rule and
Fubini’s theorem, we get the multi-Agent Recursive Reasoning Policy Gradient:
Z
∇θ i ηi =Es∼p,a i ∼π i [∇θ i log π i (ai |s)
π −i (a−i |s, ai )Qi (s, ai, a−i ) da−i ].
(18)
a−i

However, in practice, the agent may not get access to other agents’ policies. We need to infer the
−i
i
other agents’ policies. We let ρ−i
φ−i (a |s, a ) denotes the parameterized opponent conditional policy
of agent i to approximate other agents policies, i.e, π −i (a−i |s, ai ). Then we have Decentralized
Multi-Agent Recursive Reasoning Policy Gradient comes as:
Z
i
i
i
−i
i
i
i −i
−i
∇θ i η ≈Es∼p,a i ∼π i [∇θ i log πθ i (a |s)
ρ−i
φ−i (a |s, a )Q (s, a , a ) da ]
−i
a
(19)
=Es∼p,a i ∼π i [∇θ i log πθi i (ai |s)Qiρ−i (s, ai )].
φ −i

In Eq. 19, the gradient for agent i is scaled by Qiρ−i (s, ai ) =
φ −i

R

a−i

−i
i
i
i −i
−i
ρ−i
φ−i (a |s, a )Q (s, a , a ) da .

−i
i
i
i −i
The trajectories generated by updated policy would help to train ρ−i
φ−i (a |s, a ) and Q (s, a , a ).
−i
These steps form a Expectation-Maximization style learning procedures: first, fix ρφ−i and
i
i −i
Qi (s, ai, a−i ) to improve πθi i (ai |s); then, improve ρ−i
φ−i and Q (s, a , a ) by the trajectories generi
i
ated by πθ i (a |s). Furthermore, since PR2 method do not require opponents’ actual private policies,
Decentralized Multi-Agent Recursive Reasoning Policy Gradient can be decoupled from other agents’
on-policies or target policies. In other words, the training can be conducted in an off-policy fashion
−i
i
by sampling mini-batches from the memory buffer D with the help of the learned ρ−i
φ−i (a |s, a )
from Qi (s, ai, a−i ). 

C

O PPONENT C ONDITIONAL P OLICY I NFERENCE VIA O PTIMAL T RAJECTORY

Theorem 1. The optimal Q-function for agent i that satisfies minimizing Eq. 10 is formulated as:
Z
Qiπθ (s, ai ) = log
exp(Qiπθ (s, ai, a−i )) da−i .
(20)
a−i

And the corresponding optimal opponent conditional policy reads:
−i
i
ρ−i
φ −i (a |s, a ) =

1
exp(Qiπθ (s, ai, a−i ) − Qiπθ (s, ai ))
Z

Proof. As following.
17

(21)

Published as a conference paper at ICLR 2019

Follow the proof in Levine (2018); Haarnoja et al. (2017), we first give the overall distribution by:
p(τ) = [p(s1 )

T
Y

T
X
p(st+1 |st , ati, at−i )] exp(
r i (st , at , at−i )).

t=1

(22)

t=1

We can adopt an optimization-based approach to approximate the opponent conditional policy, in
which case the goal is to fit an approximation π(ati, at−i |st ) ≈ π i (ati |st )ρ−i (at−i |st , ati ) such that the
trajectory distribution,
p̂(τ) = p(s1 )

T
Y

−i
i
p(st+1 |st , ati, at−i )πθi i (ati |st )ρ−i
θ −i (at |st , at ),

(23)

t=1

has high likelihood to be observed. In the case of exact inference, as derived in the previous section,
DKL ( p̂(τ)kp(τ)) = 0. However, due to the fact that agent can only access its own reward, the
approximated ρ−i may be affected by this constraint. We can therefore view the inference process as
minimizing the K L-divergence:
DKL ( p̂(τ)kp(τ)) = −Eτ∼ p̂(τ) [log p(τ) − log p̂(τ)].

(24)

Negating both sides and substituting, we get:
−DKL ( p̂(τ)kp(τ)) = Eτ∼ p̂(τ) [log p(s1 ) +

T
X

(log p(st+1 |st , at , at−i ) + r i (st , ati, at−i ))

t=1

− log p(s1 ) −

T
X

(log p(st+1 |st , ati, at−i ) + log π(ati, at−i |st ))]

t=1
T
X
= Eτ∼ p̂(τ) [
r i (st , ati, at−i ) − log π(ati, at−i |st )]

(25)

t=1

=

T
X

E(st ,ati ,a−i
[r i (st , ati, at−i ) − log π(ati, at−i |st )]
i −i
t )∼ p̂(st ,a t ,a t ))

t=1

=

T
X

E(st ,ati ,a−i
[r i (st , ati, at−i )]
i −i
t )∼ p̂(st ,a t ,a t ))

t=1

+ Est ,ati ∼ p̂(st ) [H(ρ−i (at−i |st , ati ))] + Est ∼ p̂(st ) [H(π i (ati |st ))],
where H is the entropy term. In the recursive case, we can rewrite the objective as follows:
Z
i
i
Q (s, a ) = log
exp(Qi (s, ai, a−i )) da−i .

(26)

a−i

This corresponds to a standard bellman backup with a soft maximization for the value function.
choosing optimal opponent recursive reasoning policy:
1
ρ−i (a−i |s, ai ) = exp(Qi (s, ai, a−i ) − Qi (s, ai )).
(27)
Z
Then we can have the objective function:
J i (φ−i ) =

T
X

i
i −i
E(st ,ati ,a−i
i −i [r (st , at , at )
t )∼ p̂(st ,a t ,a t )

(28)

t=1
−i
i
i
i
+ H(ρ−i
φ −i (at |st , at )) + H(πθ i (at |st ))].

Then the gradient is then given by:
∇φ−i J i (φ−i ) =

T
X

−i
−i
i
E(st ,ati ,a−i
i −i [∇φ −i log ρ −i (at |st , at )(
φ
t )∼p(st ,a t ,a t )

r i (st 0 , ati 0 , at−i
0 )]

t 0 =t

t=1

+ ∇φ−i

T
X

T
X

−i
−i
i
i
i
E(st ,ati ,a−i
i −i [H(ρ −i (at |st , at )) + H(πθ i (at |st ))].
φ
t )∼p(st ,a t ,a t )

t=1

18

(29)

Published as a conference paper at ICLR 2019

The gradient of the entropy terms is given by:
−i
−i
i
−i
−i
−i
∇φ−i H(ρ−i
i [log ρ −i (at |st , at )]]
(a−i
φ −i ) = −∇φ E(st ,ati )∼p(st ,ati ,at ) [E at ∼ρ
φ
t |st ,a t )
φ −i

−i
−i
−i
i
−i
i
= −E(st ,ati ,a−i
i −i [∇φ log ρ −i (at |st , at )(1 + log ρ −i (at |st , at )].
φ
φ
t )∼p(st ,a t ,a t )

(30)
We can do the same for ∇φ−i H(πθi i ), and substitute these back we have:
∇φ−i J i (φ−i ) =

T
X

−i
−i
i
E(st ,ati ,a−i
i −i [∇φ −i log ρ −i (at |st , at )
φ
t )∼p(st ,a t ,a t )

t=1

(

T
X

(31)

−i
−i
i
i
i
r (st 0 , ati 0 , at−i
0 ) − log ρ −i (at 0 |st , at 0 ) − log πθ i (at |st ) − 1)].
φ
i

t 0 =t

The −1 comes from the derivative of the entropy terms, and replacing −1 with a state and self-action
dependent baseline b(st 0 , ati 0 ) we can obtain the approximated gradient for φ:
∇φ−i J i (φ−i ) =

T
X

−i
−i
i
E(st ,ati ,a−i
i −i [∇φ log ρ −i (at |st , at )
φ
t )∼p(st ,a t ,a t )

t=1

(

T
X

−i
−i
i
i
i
r i (st 0 , ati 0 , at−i
0 ) − log ρ −i (at 0 |st 0 , at 0 ) − log πθ i (at 0 |st 0 ) −
φ

t 0 =t

≈

T
X

1
|{z}

)]

baseline ignore

−i
−i
i
E(st ,ati ,a−i
i −i [∇φ −i log ρ −i (at |st , at )
φ
t )∼p(st ,a t ,a t )

t=1
−i
i
(r i (st , ati, at−i ) − log πθi i (ati |st ) − log ρ−i
φ −i (at |st , at )
|
{z
} |
{z
}
Qti (st ,ati )−Vti (st )

T
X

+

i
i
Qti (st ,ati ,a−i
t )−Q t (st ,a t )

−i
−i
i
i
i
r i (st 0 , ati 0 , at−i
0 ) − log ρ −i (at 0 |st 0 , at 0 ) − log πθ i (at 0 |st 0 ))]
φ

t 0 =t+1

|
=

T
X

{z

}

≈Qti (st +1,ati +1,a−i
t +1 )

(32)

−i
−i
i
E(st ,ati ,a−i
i −i [∇φ log ρ −i (at |st , at )
φ
t )∼p(st ,a t ,a t )

t=1
i

−i
i
i
i
i −i
i
(r (st 0 , ati 0 , at−i
0 ) + Q t (st+1, at+1, at+1 ) − Q t (st , at , at ) + Vt (st ))]
| {z }
ignore

=

T
X

i
i −i
i
i
E(st ,ati ,a−i
i −i [(∇φ −i Q t (st , at , at ) − ∇φ −i Q t (st , at ))
t )∼p(st ,a t ,a t )

t=1
−i
i
i
i
i −i
i
(r i (st 0 , ati 0 , at−i
0 ) + Q t (st+1, at+1, at+1 ) − Q t (st , at , at ) + Vt (st ))]
| {z }
ignore

=

T
X

i
i −i
i
i
E(st ,ati ,a−i
i −i [(∇φ −i Q t (st , at , at ) − ∇φ −i Q t (st , at ))
t )∼p(st ,a t ,a t )

t=1

(Q̂it (st , ati, at−i ) − Qit (st , ati, at−i ))],
where Q̂it (st , ati, at−i ) is is an empirical estimate of the Q-value of the policy. 
D

S OFT B ELLMAN E QUATION AND S OFT VALUE I TERATION

and
meets one of
Theorem 2. In a symmetric game with only one equilibrium,

 the equilibrium

the conditions: 1) the global optimum, i.e. Eπ∗ Qit (s) ≥ Eπ Qit (s) ; 2) a saddle point, i.e.
19

Published as a conference paper at ICLR 2019









Eπ∗ Qit (s) ≥ Eπ i Eπ∗−i Qit (s) or Eπ∗ Qit (s) ≥ Eπ∗i Eπ −i Qit (s) ; where Q∗ and π∗ are the
equilibrium value function and policy, respectively. The PR2 soft value iteration operator defined by:
 Z

i
i −i
i
i −i
i 0 i0 −i0
−i0
TQ (s, a , a ) , r (s, a , a ) + γEs0,a i0 ∼ps ,π i log
exp(Q (s , a , a )) da
, (33)
a−i0

is a contraction mapping.
Proof. As following:
Based on Eq. 11 & 12 in Theorem 1, we can have the PR2 soft value iteration rules shown as:


Qiπ (s, ai, a−i ) = r i (s, ai, a−i ) + γEs0 ∼ps H(π i (ai |s)π −i (a−i |s, ai )) + Ea−i0 ∼π −i (·|s0,a i0 ) [Qiπ (s0, ai0, a−i0 )]


= r i (s, ai, a−i ) + γEs0 ∼ps Qiπ (s0, ai0 ) .
(34)
Correspondingly, we define the soft value iteration operator T:
 Z

TQi (s, ai, a−i ) , r i (s, ai, a−i ) + γEs0,a i0 ∼ps ,π i log
exp(Qi (s0, ai0, a−i0 )) da−i0 . (35)
a−i0

In a symmetric game with either one global equilibrium or saddle equilibrium, it has been shown
by Yang et al. (2018) (see condition 1&2 in Theorem 1) that the payoff at the equilibrium point is
unique. This validates applying the similar idea in proving the contraction mapping of soft-value
iteration operator in the single agent case (see Lemma 1 in Fox et al. (2016)). We include it here to
stay self-contained.
We first define a norm on Q-values as kQi1 − Qi2 k , maxs,a i ,a−i |Qi1 (s, ai, a−i ) − Qi2 (s, ai, a−i )|.
Suppose ε = kQi1 − Qi2 k, then
Z
Z
i
0 i0 −i0
−i0
log
exp(Q1 (s , a , a )) da ≤ log
exp(Qi2 (s0, ai0, a−i0 ) + ε) da−i0
a−i0
a−i0
Z
= log
exp(ε) exp(Qi2 (s0, ai0, a−i0 )) da−i0
(36)
−i0
a
Z
= ε + log
exp(Qi2 (s0, ai0, a−i0 )) da−i0
a−i0

R
R
Similarly, log a−i0 exp(Qi1 (s0, ai0, a−i0 )) da−i0 ≤ −ε + log a−i0 exp(Qi2 (s0, ai0, a−i0 )) da−i0 . Therefore kTQi1 − TQi2 k ≤ γε = γkQi1 − Qi2 k. 

20

