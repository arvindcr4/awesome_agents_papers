Principled Reinforcement Learning with Human Feedback from
Pairwise or K-wise Comparisons
Banghua Zhu†
†

Michael I. Jordan†, ‡

Jiantao Jiao†, ‡

Department of Electrical Engineering and Computer Sciences, UC Berkeley
‡
Department of Statistics, UC Berkeley

arXiv:2301.11270v5 [cs.LG] 8 Feb 2024

Abstract
We provide a theoretical framework for Reinforcement Learning with Human Feedback (RLHF).
Our analysis shows that when the true reward function is linear, the widely used maximum likelihood
estimator (MLE) converges under both the Bradley-Terry-Luce (BTL) model and the Plackett-Luce
(PL) model. However, we show that when training a policy based on the learned reward model, MLE
fails while a pessimistic MLE provides policies with improved performance under certain coverage
assumptions. Additionally, we demonstrate that under the PL model, the true MLE and an alternative
MLE that splits the K-wise comparison into pairwise comparisons both converge. Moreover, the
true MLE is asymptotically more efficient. Our results validate the empirical success of existing
RLHF algorithms in InstructGPT and provide new insights for algorithm design. We also unify the
problem of RLHF and max-entropy Inverse Reinforcement Learning (IRL), and provide the first
sample complexity bound for max-entropy IRL.

1

Introduction

The alignment problem aims at aligning human values with machine learning systems and steering learning
algorithms towards the goals and interests of humans. One of the most promising tools for AI alignment,
Reinforcement Learning with Human Feedback (RLHF, or Preference-based Reinforcement Learning),
has delivered significant empirical success in the fields of game playing, robot training, stock-prediction,
recommender systems, clinical trials, large language models etc. (Novoseller et al., 2019; Sadigh et al.,
2017; Christiano et al., 2017b; Kupcsik et al., 2018; Jain et al., 2013; Wirth et al., 2017; Knox and Stone,
2008; MacGlashan et al., 2017; Christiano et al., 2017a; Warnell et al., 2018; Brown et al., 2019; Shin
et al., 2023; Ziegler et al., 2019; Stiennon et al., 2020; Wu et al., 2021; Nakano et al., 2021; Ouyang et al.,
2022; Menick et al., 2022; Glaese et al., 2022; Gao et al., 2022; Bai et al., 2022a; Ganguli et al., 2022;
Ramamurthy et al., 2022). Notably, the language model application ChatGPT is based on RLHF and this
underlies several of its skills: answering followup questions, admitting its mistakes, challenging incorrect
premises, and rejecting inappropriate requests. One of the key capabilities in RLHF is to learn a reward
from human feedback, in the form of pairwise or K-wise comparisons between actions (responses). In
this paper, we take the first step towards providing a theoretical framework for RLHF, with a specific
focus on reward learning. We provide theoretical analysis that justifies the empirical success of RLHF in
InstructGPT and ChatGPT, along with new insights for algorithm design.
Taking InstructGPT Ouyang et al. (2022) as an example, a typical deployment of RLHF for language
modeling includes the following steps:
(a) Pre-train a Large Language Model (LLM) using supervised training.
(b) Train a reward model based on the pre-trained LLM using human feedback.
(c) Fine-tune the existing LLM based on the learned reward model using Proximal Policy Optimization
(PPO).
During the reward training step, the prompts are first sampled from a pre-collected dataset. Then
K responses are sampled by executing existing models on the sampled prompts. Based on the prompt
provided, a human labeler ranks all the responses according to her own preference. The reward model is
trained based on a maximum likelihood estimator (MLE), also known as the learning-to-rank algorithm
or cross-entropy minimization (Liu et al., 2009; Xia et al., 2008; Cao et al., 2007; Christiano et al., 2017a;
Ouyang et al., 2022).
In the setting of InstructGPT, the ranking of responses is based purely on the current prompt, which
can be viewed as the state in a contextual bandit. We accordingly start with the setting of a contextual

1

bandit, and later generalize our results to Markov Decision Process (MDP) where there are transitions
between states. Let S be the set of states (prompts), and A be the set of actions (responses). For each
state-action pair (s, a), we assume that the reward is parametrized by rθ (s, a) = ⟨θ, ϕ(s, a)⟩ for some
known and fixed feature function ϕ(s, a) : S × A 7→ Rd . In an LLM, such a ϕ is usually derived by
removing the last layer of the pre-trained model.1 We denote the ground-truth reward provided by a
human as rθ⋆ (s, a) for some parameter θ⋆ ∈ Rd .
We are interested in the sample complexity for learning a reward model rθ⋆ from pairwise or K-wise
comparison data. For the i-th sample, a state si is first sampled from some fixed distribution ρ. Given the
state si , K actions (ai0 , ai1 , · · · , aiK−1 ) are sampled from some joint distribution P(a0 , · · · , aK−1 | si ). Let
σ i : [K] 7→ [K] denote the output of the human labeller, which is a permutation function representing the
ranking of the actions. Here σ i (0) represents the most preferred action. We assume that the distribution
of σ i follows a Plackett-Luce (PL) model (Plackett, 1975; Luce, 2012):
P(σ i | si , ai0 , ai1 , · · · , aiK−1 ) =

exp(rθ⋆ (si , aiσi (k) ))
.
PK−1
i i
⋆
j=k exp(rθ (s , aσ i (j) ))
k=0

K−1
Y

When K = 2, this reduces to the pairwise comparison of the Bradley-Terry-Luce (BTL) model (Bradley
and Terry, 1952), which is widely applied in existing RLHF algorithms Christiano et al. (2017a); Ouyang
et al. (2022).
Since the learned reward model is mainly used for downstream policy training, we measure the
correctness of the estimated reward model via the performance of a greedy policy trained from a reward
model rθ̂ . Concretely, for a greedy policy π̂(s) = arg maxa rθ̂ (s, a), we compute a performance gap
compared to the optimal policy:
SubOpt(π̂) := Es∼ρ [rθ⋆ (s, π ⋆ (s)) − rθ⋆ (s, π̂(s)].
Here π ⋆ = arg maxa rθ⋆ (s, a) is the optimal policy under the true reward rθ⋆ .
Gao et al. (2022) has observed that in the reward model trained from practice, there exists an overoptimization phenomenon where the true reward first increases and then decreases during the policy
optimization stage. In this paper, we study the potential sub-optimality of the MLE in the RLHF setting.
As a by-product, we also provide guarantee of the estimation error on the semi-norm of the parameter
estimation error, ∥θ̂ − θ⋆ ∥Σ , for a query-dependent covariance matrix Σ.
From a broader perspective, the framework of RLHF can be viewed as a special case of reward learning
from pre-collected data, which has been a primary focus in Inverse Reinforcement Learning (IRL) and
offline reinforcement learning. Our techniques also provide theoretical guarantee for the max-entropy
IRL Ziebart et al. (2008) and action-based IRL algorithms Ramachandran and Amir (2007); Neu and
Szepesvári (2009); Florence et al. (2022).

1.1

Main Results

Pairwise Comparison. We start with the setting of a contextual bandit with pairwise comparison.
We focus on two algorithms, MLE and pessimistic MLE. The following result from dueling bandits and
RL Faury et al. (2020); Pacchiano et al. (2021) shows that under a semi-norm ∥ · ∥Σ , MLE converges to
the true parameter.
Lemma 1.1 (Informal). Under certain regularity conditions, the MLE satisfies the following with
probability at least 1 − δ,
r
d + log(1/δ)
⋆
∥θ̂MLE − θ ∥ΣD ≤ C ·
.
n
Pn
Here ΣD = n1 i=1 (ϕ(si , ai1 ) − ϕ(si , ai0 ))(ϕ(si , ai1 ) − ϕ(si , ai0 ))⊤ .
1 In InstructGPT, the function ϕ is still parametrized can be further trained in the reward learning step. However, for
simplicity of theoretical analysis we assume in this paper that ϕ is fixed and one only fine-tunes the last layer with parameter
θ.

2

However, when we consider the performance of the induced policy, MLE provably fails while pessimistic
MLE gives a near-optimal rate. In essence, the pessimism principle discounts actions that are less
represented in the observed dataset, and hence is conservative in outputting a policy.
Theorem 1.2 (Informal). Under certain coverage assumption, one can design a pessimistic MLE such
that the induced greedy policy π̂PE is good; i.e., with probability at least 1 − δ,
!
r
d + log(1/δ)
SubOpt(π̂PE ) = Θ
.
n
In contrast, under the same assumption, one can find instances such that the greedy policy w.r.t. MLE
π̂MLE fails:
∀n > 1, E[SubOpt(π̂MLE )] ≥ 0.1.
K-wise Comparison. For K-wise comparison, we analyze both the MLE and the algorithm in
InstructGPT (Ouyang et al., 2022) which splits the ranking data into K(K −1)/2 pairwise comparison data
and runs an MLE based on the BTL model. We show that both converge in terms of the estimation error
under the semi-norm, and give a near-optimal policy when combined with pessimism. More importantly,
we show that although both estimators are unbiased, the asymptotic variance of MLE is smaller than
that of the splitted estimator in InstructGPT (Ouyang et al., 2022), which belongs to the family of
M-estimators. Thus the MLE is more efficient than the existing algorithm used in InstructGPT. We also
conduct experiments to verify the theoretical prediction.
Let the estimated parameter for the splitted estimator be θ̂ and the induced policy be π̂PE . We have:
Theorem 1.3 (Informal). Under certain coverage and regularity conditions, the following holds separately
with probability at least 1 − δ:
r
d + log(1/δ)
∥θ̂ − θ⋆ ∥ΣD ≤ C ·
,
n
r
d + log(1/δ)
SubOpt(π̂PE ) ≤ C ′ ·
,
n
Pn PK−1 PK−1
2
i i
i i
i i
i i ⊤
Here ΣD = K(K−1)n
( i=1 j=0
k=j+1 (ϕ(s , aj ) − ϕ(s , ak ))(ϕ(s , aj ) − ϕ(s , ak )) ).
We also extend our results to the case of MDP and IRL; see the detailed presentation in Section 5
and Section 6. Let the estimated parameter be θ̂ and the induced pessimistic policy be π̂PE . For pairwise
comparison we have:
Theorem 1.4 (Informal). In the MDP setting with horizon H, under certain coverage and regularity
conditions, the following holds separately with probability at least 1 − δ:
r
d + log(1/δ)
⋆
∥θ̂ − θ ∥ΣD ≤ C ·
,
n
r
d + log(1/δ)
SubOpt(π̂PE ) ≤ C ′ ·
,
n
PH
Pn PH
i
i
i′ i′
⊤
i′
Here ΣD = n1 i=1 ( h=0 (ϕ(sih , aih ) − ϕ(si′
h , ah ))) (
h=0 (ϕ(sh , ah ) − ϕ(sh , ah ))) .
Our results not only explain the correctness of existing algorithms, but also provide new insights for
algorithm design in RLHF. In particular, it suggests the importance of introducing pessimism in the
reward learning part, which can be implemented via adding regularization in policy training steps as
in Ouyang et al. (2022), or using existing offline RL algorithms, including but not limited to Conservative
Q-Learning (Kumar et al., 2020), Implicit Q-Learning (Kostrikov et al., 2021) and Adversarially Trained
Actor Critic (Cheng et al., 2022). On the other hand, it also shows that MLE is a more efficient estimator
than that in Ouyang et al. (2022).
3

1.2

Related Work

Learning and Estimation from Pairwise Comparison and Ranking. The problem of estimation
and ranking from pairwise or K-wise comparisons has been studied extensively in the literature. In the
literature of dueling bandit, one compares two actions and aims to minimize regret based on pairwise
comparisons (Yue et al., 2012; Zoghi et al., 2014b; Yue and Joachims, 2009, 2011; Saha and Krishnamurthy,
2022; Ghoshal and Saha, 2022; Saha and Gopalan, 2018a; Ailon et al., 2014; Zoghi et al., 2014a; Komiyama
et al., 2015; Gajane et al., 2015; Saha and Gopalan, 2018b, 2019; Faury et al., 2020). Novoseller et al.
(2019); Xu et al. (2020) analyze the sample complexity of dueling RL under the tabular case, which is
extended to linear case and function approximation by the recent work Pacchiano et al. (2021); Chen
et al. (2022). Chatterji et al. (2022) studies a close setting where in each episode only binary feedback is
received. However, most of the work focuses on regret minimization. We take a first step towards the
theoretical analysis for function approximation for K-wise comparisons with policy learning as the target.
On the other hand, in the literature of ranking, most of the theoretical work focuses on the tabular case
where the rewards for different actions are uncorrelated (Feige et al., 1994; Shah et al., 2015; Shah and
Wainwright, 2017; Heckel et al., 2018; Mao et al., 2018; Jang et al., 2017; Chen et al., 2013; Chen and Suh,
2015; Rajkumar and Agarwal, 2014; Negahban et al., 2018; Hajek et al., 2014; Heckel et al., 2019). And a
majority of the empirical literature focuses on the framework of learning to rank (MLE) under general
function approximation, especially when the reward is parameterized by a neural network (Liu et al.,
2009; Xia et al., 2008; Cao et al., 2007; Christiano et al., 2017a; Ouyang et al., 2022; Brown et al., 2019;
Shin et al., 2023; Busa-Fekete et al., 2014; Wirth et al., 2016, 2017; Christiano et al., 2017b; Abdelkareem
et al., 2022). Similar idea of RL with AI feedback also learns a reward model from preference Bai et al.
(2022b), except for that the preference is labeled by another AI model instead of human.
Inverse Reinforcement Learning and Offline Reinforcement Learning. RLHF, IRL and offline
learning are all approaches that can be used to incorporate human preferences or expertise into the
decision-making process of an agent. However, they differ in the way that they use human input to guide
the agent’s behavior. In IRL and imitation learning, we only observe an expert’s behavior and would
like to infer the expert’s preferences or goals (Ng et al., 2000; Abbeel and Ng, 2004; Ziebart et al., 2008;
Ramachandran and Amir, 2007; Neu and Szepesvári, 2009; Ho and Ermon, 2016; Florence et al., 2022;
Hussein et al., 2017). In offline learning, we directly observe the cardinal rewards for the state. But the
actions are likely to be sub-optimal. In RLHF, we observe ordinal comparisons between pairs or a set of
actions. In one of the popular IRL frameworks, max-entropy IRL (Ziebart et al., 2008), it is also assumed
that human choice follows a PL model. We unify the problem of RLHF and max-entropy IRL, and provide
the first sample complexity analysis for max-entropy IRL.
Pessimism in Offline RL. The idea of introducing pessimism for offline RL has been studied in recent
year (Jin et al., 2021; Rashidinejad et al., 2021; Li et al., 2022; Xie et al., 2021b; Zanette, 2022; Zanette
et al., 2021; Xie et al., 2021a; Xu and Liang, 2022). In this paper, we connect RLHF with offline RL and
show that pessimism also helps in RLHF.

2

Preliminaries

We begin with the notation that we use in the paper. We discuss our formulations of contextual bandits
and Markov decision processes in Section 2.1. We introduce the data collection model and the BTL and
PL models in Section 2.2.
Notations. We use calligraphic letters for sets, e.g., S and A. Given a set S, we write |S| to represent
the cardinality of S. For vectors x and y, we use ⟨x, y⟩ = x⊤ y to √
denote their inner product. We use [K]
to denote the set of integers from 0 to K − 1. We write ∥x∥Σ = x⊤ Σx as a semi-norm of x when Σ is
some positive-semidefinite matrix. We write Σ ⪰ Σ′ if Σ − Σ′ is positive semidefinite.

4

2.1

Markov decision processes

H
We consider a finite-horizon MDP described by a tuple M = (S, A, H, {Ph }H
h=1 , {Rh }h=1 , ρ), where
S is a (possibly infinite) state space, A is a (possibly infinite) action space, H is the horizon length,
Ph : S × A 7→ ∆(S) is a probability transition matrix at step h, Rh : S × A 7→ ∆([0, 1]) encodes a family of
reward distributions with rh : S × A 7→ [0, 1] as the expected reward function, ρ : S 7→ ∆(S) is the initial
state distribution. At step h, upon executing action a from state s, the agent receives a deterministic
reward rh (s, a) and transits to the next state s′ with probability Ph (s′ |s, a). The MDP transits to an
absorbing termination state with zero reward at step H. When H = 1 and there is no transition, the
model reduces to the contextual bandit problem.
A deterministic policy πh : S 7→ A is a function that maps a state to an action at step h ∈ [H]. We use
π
π to denote the family of policies {πh }H
h=1 . Correspondingly, the value function V : S 7→ R of the policy
family {πh }h∈[H] is defined as the expected sum of rewards
starting
at
state
s
and
following policy πh at
hP
i
H
step h. More precisely, we have for any s ∈ S, V π (s) := E
h=0 rh (sh , ah ) | s0 = s, ah = πh (sh ), ∀h ≥ 0 ,
where the expectation is taken over the trajectory generated according to the transition kernel sh+1 ∼
Ph (· | sh , ah ) and reward distributionh rh ∼ Rh (· | sh , ah ). The Q-function Qπ : S × A → Ri of policy π
PH
is defined analogously: Qπ (s, a) := E
h=0 rh (sh , ah ) | s0 = s, a0 = a, ah = πh (sh ), ∀h ≥ 0 . Note that
although we work with undiscounted episodic case, it is straightforward to extend the framework and
analysis to discounted MDP. We define the expected value of a policy π:
X
J(π) := Es∼ρ [V π (s)] =
ρ(s)V π (s).
s∈S
⋆

⋆

We use shorthands V ⋆ := V π and Q⋆ := Qπ to denote the optimal value function and the optimal
Q-function. We define the sub-optimality of any policy π as
SubOpt(π) := J(π ⋆ ) − J(π̂).
⋆

⋆

We use shorthands V ⋆ := V π and Q⋆ := Qπ to denote the optimal value function and the optimal
Q-function. We define the sub-optimality of any policy π as
SubOpt(π) := J(π ⋆ ) − J(π̂).
We also define the state occupancy measures dπ : S 7→ [0, H] and state-action occupancy measures
PH
PH
dπ : S × A 7→ [0, H] as dπ (s) := h=0 Ph (sh = s | π), dπ (s, a) := h=0 Ph (sh = s; ah = a | π), where we
use Ph (sh = s | π) to denote the probability of visiting state sh = s (and similarly sh = s, ah = a) at step
h after executing policy π and starting from s0 ∼ ρ(·).
Throughout the paper, we make the following assumption on the parameterization of the reward:
Assumption 2.1. The reward lies in the family of linear functions rθ (s, a) = θ⊤ ϕ(s, a) for some known
ϕ(s, a) with maxs,a ∥ϕ(s, a)∥2 ≤ L. Let θ⋆ be the true parameter. To ensure the identifiability of θ⋆ , we
let θ⋆ ∈ ΘB , where
ΘB = {θ ∈ Rd | ⟨1, θ⟩ = 0, ∥θ∥2 ≤ B}.

2.2

Sampling Procedure and Comparison Model

As in Ouyang et al. (2022), we assume that both the states and actions in the training set come from a
pre-collected dataset. In a contextual bandit, for the i-th sample, a state (prompt) si is first sampled
from some fixed distribution ρ. Given the state si , K actions (ai0 , ai1 , · · · , aiK−1 ) are sampled from some
joint distribution P(a0 , · · · , aK−1 | si )2 . Let σ i : [K] 7→ [K] be the output of the human labeller, which is
a permutation function that denotes the ranking of the actions. Here σ i (0) represents the most preferred
action. We use a0 > a1 to denote the event that the action a0 is more preferred compared to a1 . A
2 Indeed, it is not necessary to only compare actions under the same state. Our results can be easily generalized to the

case when the states for K queries are completely different.

5

common model on the distribution of σ under K-ary comparisons is a Plackett-Luce model (Plackett,
1975; Luce, 2012). The Plackett-Luce model defines the probability of a state-action pair (s, ai ) being the
largest among a given set {(s, ai )}K−1
i=0 as
exp(rθ (s, ai ))
.
P(ai > aj , ∀j ̸= i | s) = PK−1
j=0 exp(rθ (s, aj ))
Moreover, one can calculate the probability of observing the permutation σ as3
K−1
P(σ | s, {ai }i=0
)=

K−1
Y

exp(rθ⋆ (s, aσ(i) ))
.
PK−1
⋆
j=i exp(rθ (s, aσ(j) ))
i=0

When K = 2, this reduces to the pairwise comparison considered in the BTL model, which is used in
existing RLHF algorithms. In this case, the permutation σ can be reduced to a Bernoulli random variable,
representing whether a0 is preferred compared to a1 . Concretely, for each queried state-actions pair
exp(rθ⋆ (s,a1 ))
(s, a0 , a1 ), we observe a sample y from a Bernoulli distribution with parameter exp(rθ⋆ (s,a
;
0 ))+exp(rθ ⋆ (s,a1 ))
i.e., for any l ∈ {0, 1},
P(y = l | s, a0 , a1 ) =

2.3

exp(rθ⋆ (s, al ))
.
exp(rθ⋆ (s, a0 )) + exp(rθ⋆ (s, a1 ))

Organization

Section 3 presents the problem of learning with pairwise comparisons under the contextual bandit
framework, we provide upper and lower bounds for MLE and pessimistic MLE. We extend the result into
K-wise comparisons in Section 4 and MDP in Section 5. We discuss the guarantee for IRL in Section 6.
We present our experimental results on simulated dataset in Section 7. We also discuss the analysis for
nonlinear rewards in Appendix A .

3

Learning from Pairwise Comparison

We begin with the problem of learning from pairwise comparisons under the BTL model.

3.1

Algorithms: MLE and Pessimistic MLE

We first bound the estimation error for MLE, the most common algorithm in learning to rank and
RLHF Liu et al. (2009); Xia et al. (2008); Cao et al. (2007); Christiano et al. (2017a); Ouyang et al.
(2022). For any query-observation dataset {(si , ai1 , ai2 , y i )}ni=1 , MLE aims at minimizing the negative log
likelihood, defined as:
θ̂MLE ∈ arg min ℓD (θ),
θ∈ΘB
n
X

ℓD (θ) = −

log

i=1

=−

n
X



1(y i = 1) · exp(rθ (si , ai1 ))
1(y i = 0) · exp(rθ (si , ai0 )) 
+
exp(rθ (si , ai0 )) + exp(rθ (si , ai1 )) exp(rθ (si , ai0 )) + exp(rθ (si , ai1 ))



log 1(y i = 1) · sigmoid(⟨θ, ϕ(si , ai1 ) − ϕ(si , ai0 )⟩) + 1(y i = 0) · sigmoid(⟨θ, ϕ(si , ai0 ) − ϕ(si , ai1 )⟩) .

i=1

When the minimizer is not unique, we take any of the θ̂ that achieve the minimum. Let D =
{(si , ai1 , ai2 )}ni=1 denote the queried state-action pairs. In this paper, we study how one can utilize D
to learn a near-optimal reward model and policy. We first present a lemma on the estimation error
conditioned on the data D. The lemma is a generalization of the upper bound in Shah et al. (2015,
3 In practice, one may introduce an extra temperature parameter σ and replace all r ⋆ with r ⋆ /σ. Here we take σ = 1.
θ
θ

6

Algorithm 1 Pessimistic MLE
Input: The current estimator θ̂, the data covariance ΣD , the regularization parameter λ, the bound on
the semi-norm f (n, d, δ, λ), a reference vector v ∈ Rd , state distribution q
Construct the confidence set
n
o
Θ(θ̂, λ) = θ ∈ ΘB | ∥θ̂ − θ∥ΣD +λI ≤ f (n, d, δ, λ) .
Compute the pessimistic expected value function
ˆ
J(π)
=

min Es∼q [θ⊤ (ϕ(s, π(s)) − v)]
θ∈Θ(θ̂,λ)
1

= (Es∼q [ϕ(s, π(s))] − v)⊤ θ̂ − ∥(ΣD + λI)− 2 (Es∼q [ϕ(s, π(s))] − v)∥2 · f (n, d, δ, λ)
ˆ
Return: π̂ = arg maxπ J(π).
Theorem 1) and the analysis follows a similar structure. The main difference is that Shah et al. (2015)
focus on the tabular case when ϕ(s, a) is always a standard basis vector, while in our case ϕ(s, a) can be
an arbitrary d-dimensional vector. This confidence bound guarantee is also similar to the guarantee for
dueling bandits and RL in Faury et al. (2020); Pacchiano et al. (2021), except for that we have better rate
in logarithmic factors since union bound is not needed in our case.
Lemma 3.1. For any λ > 0, with probability at least 1 − δ,
s
d + log(1/δ)
∥θ̂MLE − θ⋆ ∥ΣD +λI ≤ C ·
+ λB 2 .
γ2n
Pn
Here ΣD = n1 i=1 (ϕ(si , ai1 ) − ϕ(si , ai0 ))(ϕ(si , ai1 ) − ϕ(si , ai0 ))⊤ , γ = 1/(2 + exp(−LB) + exp(LB)).
The proof is deferred to Appendix B.1. The optimality of the bound can be seen via a lower-bound
argument akin to that in Shah et al. (2015, Theorem 1).
Now consider the set of parameters
s
o
n
d + log( 1δ )
2 .
+
λB
Θ(θ̂MLE , λ) = θ ∈ ΘB | ∥θ̂MLE − θ∥ΣD +λI ≤ C ·
γ2n
Lemma 3.1 shows that with probability at least 1 − δ, one has θ⋆ ∈ Θ(θ̂MLE ). We thus consider the
pessimistic MLE in Algorithm 1, which takes the lower confidence bound (LCB) as the reward estimate.
In the context of LLM, the features of meaningful prompts and responses usually lie on a low-dimensional
manifold. The idea of pessimism is to assign larger reward for the responses that lie on the manifold,
and penalize the rarely seen responses that do not lie on manifold. We have the following guarantee for
pessimistic MLE:
Theorem
3.2. Let π̂PE be the output of Algorithm 1 when taking θ̂ = θ̂MLE , f (n, d, δ, λ) = C ·
q
d+log(1/δ)
+ λB 2 , q = ρ. For any λ > 0 and v ∈ Rd , with probability at least 1 − δ,
γ2n
s
d + log(1/δ)
SubOpt(π̂PE ) ≤ C ·
+ λB 2 · ∥(ΣD + λI)−1/2 Es∼ρ [(ϕ(s, π ⋆ (s)) − v)]∥2 .
γ2n
The proof is deferred to Appendix B.2. We make several remarks.
Remark 3.3 (The single concentratability coefficient assumption). When v = 0, the term ∥(ΣD +
λI)−1/2 Es∼ρ [ϕ(s, π ⋆ (s))]∥2 is referred to as a “single concentratability coefficient”, which is assumed to be
bounded in most of the literature on offline learning (Rashidinejad et al., 2021; Li et al., 2022; Xie et al.,
2021b; Zanette, 2022; Zanette et al., 2021). A bounded concentratability coefficient can be understood as
certifying good coverage of the target vector Es∼ρ [ϕ(s, π ⋆ (s))] from the dataset D in the feature space.
The performance guarantee also holds when we replace π ⋆ with any reference policy π on both sides.
7

Remark 3.4 (The choice of λ). When ΣD is invertible, or when any θ ∈ ΘB is orthogonal to the nullspace
of ΣD , the above inequality holds for the case of λ = 0. In other cases, one may minimize λ on the
right-hand side, or simply take λ = (d + log(1/δ)/(B 2 γ 2 n)) to achieve a near-optimal rate up to a constant
factor.
Remark 3.5 (The choice of v). Compared to the traditional pessimism principle (Rashidinejad et al.,
2021; Li et al., 2022; Xie et al., 2021b; Zanette, 2022; Zanette et al., 2021), we subtract an extra reference
vector v in all the feature vectors ϕ. Subtracting a constant vector in feature space will not change the
induced policy, but may affect the concentratability coefficient ∥(ΣD + λI)−1/2 (Es∼ρ [ϕ(s, π(s))] − v)∥2 .
We briefly describe the reason for introducing v here. Consider the case where the differences between
features lie in the same subspace, while the feature ϕ itself does not. As a concrete example, consider a
single state s and two actions a0 , a1 , we let ϕ(s, a0 ) = (1, 1) and ϕ(s, a1 ) = (1, 0). The data covariance is
(ϕ(si , ai1 ) − ϕ(si , ai0 ))(ϕ(si , ai1 ) − ϕ(si , ai0 ))⊤ = [0, 0; 0, 1]. Thus ∥(ΣD + λI)−1/2 ϕ(s, a0 )∥2 can be arbitrarily
large as λ → 0 when v = 0. On the other hand, when we take v = ϕ(s, a1 ), one can verify that
∥(ΣD + λI)−1/2 (ϕ(s, a0 ) − v)∥2 ≤ 1.
The above example illustrates the importance of choosing an appropriate v. A good rule of thumb for
choosing v is the most common feature vector ϕ that appears in the data, so that more features can be
covered. This also affords additional design latitude for other pessimism algorithms.
Remark 3.6 (Implementation for neural network). When rθ is a neural network, Algorithm 1 may
not be directly implementable. As an alternative, there has been a number of heuristic approximations
considered, including Conservative Q-Learning (Kumar et al., 2020), Implicit Q-Learning (Kostrikov et al.,
2021) and Adversarially Trained Actor Critic (Cheng et al., 2022). Furthermore, one may also introduce
pessimism in the policy training procedure. For example, Ouyang et al. (2022) add regularization terms
in policy training, which enforces that the policy stays close to the original policy, and within the coverage
of the pre-trained dataset. Our analysis supplies a theoretical rationale for such regularization terms.
Remark 3.7 (Implications for online learning). Although we mainly focus on offline learning,
Lemma 3.1 also gives a straightforward online learning algorithm when combined with an optimism-based
algorithm. In particular, a pure exploration-based active learning scheme would seek to compare pairs
of actions whose feature difference is poorly covered by the past observations; i.e., find (s, a1 , a2 ) such
that ∥ϕ(s, a1 ) − ϕ(s, a2 )∥(ΣD +λI)−1 is maximized. As a corollary of Lemma 3.1 and exploration results
for linear bandits (Abbasi-Yadkori et al., 2011; Soare et al., 2014), one can derive tight regret bound for
online learning.
Remark 3.8 (Special Case: Multi-Armed Bandit). For multi-armed bandits we have only a single
state, such that the feature ϕ(s, a) reduces to ⃗1a , which is a unit vector withP
1 on its a-th element. In this
n
case, the data covariance reduces to a Laplacian matrix, defined as ΣD = n1 i=1 (⃗1a1 − ⃗1a0 )(⃗1a1 − ⃗1a0 )⊤ .
This is precisely the problem considered in Shah et al. (2015). The Laplacian matrix is positive semidefinite
and always has a zero eigenvalue, corresponding to an all ones eigenvector. When the graph induced by
the Laplacian matrix is connected, any θ with ⟨1, θ⟩ = 0 is orthogonal to the nullspace of ΣD , thus the
theorem holds for the case of λ = 0.

3.2

Failure of MLE and Lower Bounds

We also show that there exists a simple linear bandit where MLE fails and pessimistic MLE succeeds. Let
π̂MLE = arg maxπ E[rθ̂MLE (s, π(s))] be the greedy policy with respect to the MLE.
Theorem 3.9. There exists a linear bandit with four actions and a sampling distribution such that for
any n > 1,
E[SubOpt(π̂MLE )] ≥ 0.1.
On the other hand, with probability at least 1 − δ,
SubOpt(π̂PE ) ≤
Here C is some universal constant.
8

C · log(1/δ)
√
.
n

The proof is deferred to Appendix B.3. The results show a separation between MLE and pessimistic
MLE when the concentratability coefficient is bounded. The failure of MLE has also been empirically
observed in Gao et al. (2022), which leads to overoptimization with the trained reward model.
We also show that for the problems with bounded concentratability coefficient, pessimistic MLE is
minimax-rate optimal up to a constant factor. Consider the family of contextual bandit instances as
follows:
−1/2

CB(Λ) = {ρ, {(si , ai1 , ai2 )}ni=1 , θ⋆ | ∥ΣD

Es∼ρ [ϕ(s, π ⋆ (s))]∥2 ≤ Λ}.

Here we assume that ΣD is invertible to simplify the presentation of the lower bound. For any Q ∈ CB(Λ),
we let SubOptQ (π) be the sub-optimality under instance Q. We have the following lower bound result,
the proof of which is deferred to Appendix B.4.
Theorem 3.10. For any d > 6, n ≥ CdΛ2 , Λ ≥ 2, there exists a feature mapping ϕ such that the following
lower bound holds.
r
d
inf sup SubOptQ (π̂) ≥ CΛ ·
.
π̂ Q∈CB(Λ)
n
Comparing with the upper bound in Theorem 3.2, we see that the pessimistic MLE is minimax-optimal
up to constant factors for the sub-optimality of induced policy.

4

Learning from K-wise comparisons

We now consider learning from K-wise comparisons under the PL model. In this case, we design two
different estimators based on MLE. One involves directly maximizing the likelihood under the PL model,
denoted as MLEK . The other involves splitting the K-wise comparison data with pairwise comparisons
and running MLE for pairwise comparisons. We denote this estimator as MLE2 .

4.1

Algorithms

Guarantee for MLEK . Let D = {(si , ai0 , · · · , aiK )}ni=1 be the set of queried states and actions, and
the permutation function σ i be the output of the i-th query. We can compute its maximum likelihood
estimator as
θ̂MLEK ∈ arg min ℓD (θ),
θ∈ΘB
n K−1

exp(⟨θ, ϕ(si , aiσi (j) )⟩)

1XX
where ℓD (θ) = −
log
n i=1 j=0

PK−1
k=j

exp(⟨θ, ϕ(si , aiσi (k) )⟩)

!
.

Similar to Shah et al. (2015), we restrict our attention to K = O(1) since it is known that it is difficult
for human to compare more than a small number of items due to a limited information storage and
processing capacity (Miller, 1956; Kiger, 1984; Shiffrin and Nosofsky, 1994; Saaty and Ozdemir, 2003).
For instance, Saaty and Ozdemir (2003) recommend eliciting preferences over no more than seven options.
We have the following result for K-wise comparisons.
Theorem 4.1. Under the K-wise PL model, for any λ > 0, with probability at least 1 − δ,
s
K 4 (d + log(1/δ))
∥θ̂MLEK − θ⋆ ∥ΣD +λI ≤ C ·
+ λB 2 .
γ2n
Pn PK−1 PK−1
2
i i
i i
i i
i i ⊤
Here ΣD = K(K−1)n
( i=1 j=0
k=j+1 (ϕ(s , aj )−ϕ(s , ak ))(ϕ(s , aj )−ϕ(s , ak )) ), and γ = exp(−4LB).
As q
a consequence, let π̂PEK be the output of Algorithm 1 when taking θ̂ = θ̂MLEK , f (n, d, δ, λ) =
C·

K 4 (d+log(1/δ))
+ λB 2 . For any λ > 0 and v ∈ Rd , with probability at least 1 − δ,
γ2n

s
SubOpt(π̂PEK ) ≤ C ·

K 4 (d + log(1/δ))
+ λB 2 · ∥(ΣD + λI)−1/2 Es∼ρ [(ϕ(s, π ⋆ (s)) − v)]∥2 .
γ2n

9

The proof of Theorem 4.1 is provided in Appendix B.5. Shah et al. (2015) also study the extension
from pairwise to K-wise comparisons. However, they focus on the setting where only the maximum
is selected, where we assume a complete ranking among K items is given. Also, they only provide an
expectation bound while we provide a high-probability bound.
Compared to the pairwise comparison result in Theorem 3.2, the covariance matrix ΣD now takes
the sum over the feature differences between all pairs of actions among K-wise comparisons. As a cost,
the right-hand side bound also introduces extra dependence on K. Our bound is likely to be loose in
terms of the dependence on K. However, since we mainly focus on the case of K = O(1), such a bound
is still near-optimal due to the minimax lower bound for pairwise comparisons. Furthermore, the gap
between MLE and pessimistic MLE for sub-optimality still exists since Theorem 3.9 holds as a special
case of K-wise comparison.
Guarantee for MLE2 Besides the standard MLE approach, another option is to replace the joint
distribution of K-ranking data with K(K − 1)/2 pairs of pairwise comparisons. This can be understood
as replacing the true probability in MLEK with the product of marginals:
θ̂MLE2 ∈ arg min ℓD (θ),
θ∈ΘB
n K−1 K−1
1XX X
where ℓD (θ) = −
log
n i=1 j=0
k=j+1

exp(⟨θ, ϕ(si , aiσi (j) )⟩)

!

exp(⟨θ, ϕ(si , aiσi (j) )⟩) + exp(⟨θ, ϕ(si , aiσi (k) )⟩)

.

This estimator is also applied in the current RLHF for LLM (see, e.g., Ouyang et al., 2022). We show
that it also leads to a good induced policy, as is shown in the theorem below.
Theorem 4.2. Under the K-wise PL model, for any λ > 0, with probability at least 1 − δ,
s
d + log(1/δ)
⋆
+ λB 2 .
∥θ̂MLE2 − θ ∥ΣD +λI ≤ C ·
γ2n
2
Here ΣD = K(K−1)n
(

Pn

i=1

PK−1 PK−1
j=0

i i
i i
i i
i i ⊤
k=j+1 (ϕ(s , aj ) − ϕ(s , ak ))(ϕ(s , aj ) − ϕ(s , ak )) ), and γ = 1/(2 +

exp(−2LB) + exp(2LB)).
As a consequence, let π̂PE2 be the output of Algorithm 1 when taking θ̂ = θ̂MLE2 ,
q
f (n, d, δ, λ) = C ·

d+log(1/δ)
+ λB 2 , q = ρ. For any λ > 0 and v ∈ Rd , with probability at least 1 − δ,
γ2n

s
SubOpt(π̂PE2 ) ≤ C ·

d + log(1/δ)
+ λB 2 · ∥(ΣD + λI)−1/2 Es∼ρ [(ϕ(s, π ⋆ (s)) − v)]∥2 .
γ2n

The proof of Theorem 4.2 is provided in Appendix B.6. Our theoretical analysis validates the empirical
performance of MLE2 in Ouyang et al. (2022). Compared to the guarantee for MLEK , MLE2 seems to has
better nonasymptotic upper bound in terms of the dependence on K. However, it is likely that this comes
from a loose analysis of MLEK . The MLE2 belongs to the family of the M-estimators, whose asymptotic
variance is known to be larger than that of MLE Godambe (1960); Lee (2008). Thus, asymptotically,
MLEK is more efficient than MLE2 . We can calculate the asymptotic variance of both estimators as
follows:
Theorem 4.3. We have
√

n(θ̂MLEK − θ⋆ ) → N (0, I(θ⋆ )−1 );
√
n(θ̂MLE2 − θ⋆ ) → N (0, V ).

10

where
" K−1 K−1 K−1
X X X exp(⟨θ⋆ , ϕ(si , aiσi (k) ) + ϕ(si , aiσi (k′ ) )⟩)
I(θ⋆ ) = Eθ⋆
PK−1
( k′ =j exp(⟨θ⋆ , ϕ(si , aiσi (k′ ) )⟩))2
j=0 k=j k′ =j
#
· (ϕ(si , aiσi (k) ) − ϕ(si , aiσi (k′ ) ))(ϕ(si , aiσi (k) ) − ϕ(si , aiσi (k′ ) ))⊤ ,


V = Σ−1 Eθ⋆ GG⊤ Σ−1 ,


K−1


⊤
X K−1
X
exp(−⟨θ⋆ , xiσi (j)σi (k) )⟩
· ϕ(si , aiσi (j) ) − ϕ(si , aiσi (k) ) ϕ(si , aiσi (j) ) − ϕ(si , aiσi (k) )  ,
Σ = Eθ⋆ 
2
⋆ , xi
)⟩)
(1
+
exp(−⟨θ
σi (j)σi (k)
j=0
k=j

G=

K−1
X K−1
X

exp(−⟨θ⋆ , xiσi (j)σi (k) )⟩

1 + exp(−⟨θ⋆ , xiσi (j)σi (k) )⟩
j=0 k=j+1



· ϕ(si , aiσi (j) ) − ϕ(si , aiσi (k) )

The proof follows directly the gradient and Hessian computed in Appendix B.5 and B.6, combined
with Van der Vaart (2000, Section 5.3). We also empirically verify the performances of both estimators in
Section 7.

5

Extension to MDPs

Thus far we have considered only contextual bandits. We now extend our results to the MDP setting.
Depending on whether the comparison is based on a single action or a whole trajectory, we have two
regimes, namely action-based comparison and trajectory-based comparison.

5.1

Trajectory-based Comparison

In trajectory-based comparison, we assume that two trajectories that start from the same initial state
are given, and the comparison is based on the cumulative reward of the two trajectories. Concretely, we
first sample the initial state s0 from some fixed distribution ρ, and then sample two trajectories τ0 =
′
′
′
′
′
(a
Q0 , s1 , a1 , · · · , sH , aH ) and τ1 = (a0 , s1 , a1 , · · · , sH , aH ) from joint distributions Pl (a0 , s1 , a1 , · · · , sH , aH |s0 ) =
i πl (ai |si )P (si+1 |si , ai ), where l ∈ {0, 1}. For each queried state-trajectory pair, we observe a sample y
from a Bernoulli distribution as follows:
PH
exp( h=0 rθ⋆ (sh , ah ))
P(y = 1 | s, τ0 , τ1 ) =
.
PH
PH
exp( h=0 rθ⋆ (sh , ah )) + exp( h=0 rθ⋆ (s′h , a′h )))
Given the dataset {(si , τ0i , τ1i , y i }ni=1 , the MLE is
θ̂MLE ∈ arg min ℓD (θ),
θ∈ΘB
n
X

where ℓD (θ) = −

log

i=1



PH
PH

i′
1(y i = 0) · exp( h=0 rθ (si′
1(y i = 1) · exp( h=0 rθ (sih , aih ))
h , ah ))
+
.
PH
P
P
P
H
H
H
i′
i′
exp( h=0 rθ (sih , aih )) + exp( h=0 rθ (si′
exp( h=0 rθ (sih , aih )) + exp( h=0 rθ (si′
h , ah ))
h , ah ))

Compared to the pairwise comparison in the contextual bandit, the exponent changes from a single
reward to the cumulative reward. Similarly, we provide the following guarantee for the estimation error of
MLE:
Lemma 5.1. Assume that ∥ϕ(·, ·)∥∞ ≤ L for any s, a. Then for any λ > 0, with probability at least 1 − δ,
s
d log(1/δ)
⋆
∥θ̂MLE − θ ∥ΣD +λI ≤ C ·
+ λB 2 .
γ2n
Pn PH
PH
i′
i
i
i′ i′
⊤
Here ΣD = n1 i=1 ( h=0 (ϕ(sih , aih ) − ϕ(si′
h , ah ))) (
h=0 (ϕ(sh , ah ) − ϕ(sh , ah ))) , and γ = 1/(2 +
exp(−2HLB) + exp(2HLB)).
11

The proof is deferred to Appendix B.7. Compared to the guarantee for contextual bandits in Lemma 3.1,
the features in the covariance is now the difference between the cumulative feature in trajectory τ and the
cumulative feature in trajectory τ ′ . The result reduces to Lemma 3.1 when H = 1.
In order to bound the sub-optimality of the induced policy, one needs to plug-in a pessimistic version
of the reward estimate. Note that from the definition of dπ , one has
Es∼ρ [V π (s)] = Es,a∼dπ [r(s, a)].
In the case when the transition distribution P is known, one may directly compute dπ for any policy π and
replace the initial distribution ρ in the algorithm for contextual bandit. This gives the following result:
Theorem
5.2. Let π̂PE be the output of Algorithm 1 when taking θ̂ = θ̂MLE , f (n, d, δ, λ) = C ·
q
d+log(1/δ)
+ λB 2 , q = dπ . For any λ > 0 and v ∈ Rd , with probability at least 1 − δ,
γ2n
s
SubOpt(π̂PE ) ≤ C ·

d + log(1/δ)
+ λB 2
γ2n

· ∥(ΣD + λI)−1/2 Es∼dπ⋆ [(ϕ(s, π ⋆ (s)) − v)]∥2 .
The proof is deferred to Appendix B.8. The result can be generalized to the case of K-wise comparisons
following the same argument in Section 4.

5.2

Action-based Comparison

In action-based comparison, we assume that two actions are sampled for each state, and the comparison
is based on the expected cumulative return starting from such state-action pair.
Concretely, assume that the optimal Q-function is parameterized as Q⋆θ (s, a) = θ⊤ ϕ(s, a) for some
given ϕ(s, a). Let θ⋆ be the true parameter. During the training, we first sample the state s from some
fixed distribution ρ, and then sample a pair of actions a0 , a1 from a joint distribution P (a0 , a1 |s). For each
queried state-actions pair (s, a0 , a1 ), we observe a sample y from a Bernoulli distribution with parameter
exp(Qθ⋆ (s,a1 ))
exp(Qθ⋆ (s,a0 ))+exp(Qθ⋆ (s,a1 )) , i.e.
P(y = 1 | s, a0 , a1 ) =

exp(Qθ⋆ (s, a1 ))
exp(Qθ⋆ (s, a0 )) + exp(Qθ⋆ (s, a1 ))

and P(y = 0 | s, a0 , a1 ) =

exp(Qθ⋆ (s, a0 ))
.
exp(Qθ⋆ (s, a0 )) + exp(Qθ⋆ (s, a1 ))

In this case, one may use the same MLE to estimate θ⋆ , which results in an estimator Q̂ for the Q⋆ -function.
The following lemma follows exactly the same analysis as Lemma 3.1:
Lemma 5.3. Under the BTL model for action-based RLHF, for any λ > 0, with probability at least 1 − δ,
s
d + log(1/δ)
⋆
∥θ̂MLE − θ ∥ΣD +λI ≤ C ·
+ λB 2 .
γ2n
Pn
Here γ = 1/(2 + exp(−LB) + exp(LB)). ΣD = n1 i=1 (ϕ(si , ai1 ) − ϕ(si , ai0 ))(ϕ(si , ai1 ) − ϕ(si , ai0 ))⊤ .
When ΣD is invertible and covers all the directions well, this will lead to a valid confidence bound for
Q⋆ , which implies a good performance of the induced greedy policy without pessimism. However, when
ΣD does not provide good coverage, introducing pessimism in this case can be hard. The reason is that
one needs to construct lower confidence bound for Qπ for any π. However, given such confidence bound of
θ̂MLE , one can only construct confidence bound for Q⋆ .

6

Connection with Inverse Reinforcement Learning

In Inverse Reinforcement Learning (IRL), BTL and PL model are also popular model of human behavior.
However, in IRL it is assumed that we only observe the human behavior, which is sampled from the
distribution under PL model. Thus no comparison is queried. Depending on the comparison is action-based
on trajectory-based, one has max-entropy IRL or action-based IRL, discussed in details below.
12

6.1

Trajectory-based IRL

In max-entropy IRL Ziebart et al. (2008), it is also assumed that the human selection of trajectory follows
a PL model. A common assumption in IRL or IL is that the observed trajectory collected by human
behavior is likely to be the optimal policy. Assumee that the transitions are deterministic. For any
trajectory τ = (s0 , a0 , · · · , sH , aH ), it is assumed that the expert chooses trajectory τ under the following
model:
PH
exp( h=0 ⟨θ⋆ , ϕ(sh , ah )⟩)
.
P(τ ) = P
PH
′
′
⋆
τ ′ ∈T (s0 ) exp(
h=0 ⟨θ , ϕ(sh , ah )⟩)
Here the set T (s0 ) denotes the set for all possible trajectories that start from s0 . Each trajectory is
i
i
represented by τ ′ = {(s′h , a′h )}H
h=1 . Assume that we are given a set of trajectories {sh , ah }i∈[n],h∈[H] that
are sampled from the distribution P(τ ). When the denominator can be computed exactly, the algorithm
of max entropy IRL also reduces to the MLE, which can be written as
θ̂MLE ∈ arg min ℓD (θ),
θ∈ΘB

!
PH
exp( h=0 ⟨θ, ϕ(sih , aih )⟩)
.
P
PH
′
′
τ ′ ∈T (si ) exp(
h=0 ⟨θ, ϕ(sh , ah )⟩)

n

1X
where ℓD (θ) = −
log
n i=1

0

Although the enumeration of all trajectories T (si0 ) is not possible due to exponential growth of the possible
trajectories with respect to horizon H, Ziebart et al. (2008) provides an alternative way of computing the
gradient via calculating the expected state frequency. This enables the efficient implementation of MLE.
One can show the performance guarantee for max entropy IRL as follows:
Lemma 6.1. Under the PL model, for any λ > 0, with probability at least 1 − δ,
s
sups |T (s)|2 · (d + log(1/δ))
⋆
+ λB 2 .
∥θ̂MLE − θ ∥ΣD +λI ≤ C ·
γ2n
Pn P
P
PH
PH
Here ΣD = n sup 1|T (s)|2 i=1 {(sh ,ah )}∈T (si ) {(s′ ,a′ )}∈T (si ) ( h=0 (ϕ(sh , ah )−ϕ(s′h , a′h )))( h=0 (ϕ(sh , ah )−
s

0

h

ϕ(s′h , a′h )))⊤ , and γ = exp(−4LB)/2.

h

0

Given such guarantee for MLE, we also show that IRL, when combined with pessimism principle, will
lead to a good policy.
Theorem
6.2. Let π̂PE be the output of Algorithm 1 when taking θ̂ = θ̂MLE , f (n, d, δ, λ) = C ·
q
sups |T (s)|(d+log(1/δ))
+ λB 2 , q = dπ . For any λ > 0 and v ∈ Rd , with probability at least 1 − δ,
γ2n
s
sups |T (s)|2 (d + log(1/δ))
SubOpt(π̂PE ) ≤ C ·
+ λB 2
γ2n
· ∥(ΣD + λI)−1/2 Es∼ρ [(ϕ(s, π ⋆ (s)) − v)]∥2 .
The proof of Lemma 6.1 and Theorem 6.2 is provided in Appendix B.9. For IRL we have the dependence
of sups |T (s)| in our bound, which can be much larger than d. Similar to the case of K-wise comparison,
one may also split the one observation into sups |T (s)| pairwise comparisons, which can help improve the
dependence on sups |T (s)| in the current analysis.

6.2

Action-based IRL

Similar to action-based RLHF, action-based IRL also models human choice based on Q⋆ instead of
cumulative reward Ramachandran and Amir (2007); Neu and Szepesvári (2009); Florence et al. (2022).
Concretely, the human behavior is assumed to be based on the Q function Q⋆ (s, a) = ⟨θ⋆ , ϕ(s, a)⟩, i.e.
exp(⟨θ⋆ , ϕ(s, a)⟩)
.
⋆
′
a′ ∈A exp(⟨θ , ϕ(s, a )⟩)

π ⋆ (a|s) = P

13

Here the denominator takes all possible actions. Unlike RLHF where a pair of actions are observed, in
IRL or IL, only a single human behavior is observed in each round and there is no comparison, i.e. the
observed actions a are sampled from π ⋆ (a | s). Given such observation, one can still run MLE and gives
similar performance guarantee. In particular, the MLE is given by
θ̂MLE ∈ arg min ℓD (θ),
θ∈ΘB
n
X

where ℓD (θ) = −

1
log
n i=1



exp(⟨θ, ϕ(si , ai )⟩)
i ′
a′ ∈A exp(⟨θ, ϕ(s , a )⟩)



P

.

The following lemma follows a similar analysis as Lemma 3.1 and Lemma 6.1:
Lemma 6.3. Under the PL model for action-based IRL, for any λ > 0, with probability at least 1 − δ,
s
|A|2 (d + log(1/δ))
∥θ̂MLE − θ⋆ ∥ΣD +λI ≤ C ·
+ λB 2 .
γ2n
1
Here ΣD = n|A|
2

Pn

i=1

P

a∈A

i
i ′
i
i ′
⊤
a′ ∈A (ϕ(s , a) − ϕ(s , a ))(ϕ(s , a) − ϕ(s , a ))) , and γ = exp(−4LB)/2.

P

Similar to the case of action-based RLHF, it remains an interesting open problem how one can introduce
provable lower confidence bound algorithm for policy learning.

7

Experiments

There has been a large amount of empirical work that demonstrates the success of MLE and pessimistic
MLE in RLHF for game playing (Knox and Stone, 2008; MacGlashan et al., 2017; Christiano et al., 2017a;
Warnell et al., 2018), robotics (Brown et al., 2019; Shin et al., 2023) and language models (Ziegler et al.,
2019; Stiennon et al., 2020; Wu et al., 2021; Nakano et al., 2021; Ouyang et al., 2022; Menick et al.,
2022; Glaese et al., 2022; Gao et al., 2022; Bai et al., 2022a; Ganguli et al., 2022; Ramamurthy et al.,
2022). Notably, the concurrent work Shin et al. (2023) proposes Offline Preference-Based Reward Learning
(OPRL), which trains pessimistic policy from the learned reward and shows empirically the superior
performance of pessimistic based method (which can be viewed as an approximation of pessimistic MLE).

Figure 1: Left: the convergence of MLE under the semi-norm ∥ · ∥Σ ; Right: the comparison between MLE
and pessimistic MLE under sub-optimality metric.
In this section, we provide experiments for the contextual bandit case. In particular, we conduct
both MLE and pessimistic MLE on the example constructed in Appendix B.3. The results are included
in Fig. 1. We range the number of samples n from 10 to 500. Each sample size is repeated 100 times.
The result verifies our theoretical analysis: MLE converges under the semi-norm but fails to give good
policy. On the other hand, pessimistic MLE gives vanishing rate when considering the sub-optimality
of the induced policy. Note that in the left figure we do not include pessimistic MLE, since both MLE

14

and pessimistic MLE rely on the same parameter θ̂MLE , and they only defer in how the induced policy is
trained.
On the other hand, we compare the performance of MLE2 and MLEK when learning from K-wise
comparisons. We take K = 4 and K = 9, and range samples from 10 to 500. We randomly generate ϕ and
θ⋆ as independent samples from 3-dimensional Gaussian distribution. The result is shown in Figure 2. One
can see that as n grows larger, both estimators converge, while MLEK has smaller estimation error than
MLE2 . The gap grows larger when K becomes larger. This is consistent with our theoretical prediction in
Section 4: since MLEK is the true MLE and MLE2 belongs to the family of M-estimators, asymptotically
MLEK shall be more efficient than MLE2 .

Figure 2: The comparison of estimation error between MLE2 and MLEK , with K = 4 in the left and
K = 9 in the right.

8

Conclusion

We have provided a theoretical analysis of the sample complexity of RLHF. Our main results involve two
insights: (i) pessimism is important to guarantee a good policy; (ii) in K-wise comparison, both MLEK
and MLE2 converge. Moreover, MLEK is asymptotically more efficient.
While we have made progress in understanding the reward learning aspect of RLHF, there are many
additional questions that remain to be answered.
1. We assumed that the policy trained is greedy with respect to the learned reward. However, in
practice the reward is mostly used to fine-tune the pre-trained policy. This requires a more extensive
theory that considers the whole procedure of pre-training the policy, learning a reward model and
then fine-tuning the policy with policy gradient or PPO.
2. Although we focused on the BTL and PL models, there have been a number of other models
considered for the modeling of human behavior, including the Thurstone model and cardinal models.
It would be interesting to extend our analysis to cover these additional models and begin to provide
a general characterization of behavioral models for RLHF.
3. Our constructed confidence bound is based on a fixed feature ϕ. In the practical fine-tuning scenario,
ϕ is not fixed but may change slowly. It is interesting to see how the constructed confidence bound
helps in the practical fine-tuning scenario for online (active) learning or offline learning, and how
one can design valid confidence bound for slowly changing ϕ.

Acknowledgement
The authors would like to thank the reviewers for the valuable suggestions. The authors would like to
thank Kihui Lee for pointing out the mistakes in the proof of Theorem 3.10 in an early version of the paper.
Banghua Zhu and Jiantao Jiao were partially supported by NSF Grants IIS-1901252 and CCF-1909499.
Michael I. Jordan was partially supported by NSF Grants IIS-1901252.
15

References
Y. Abbasi-Yadkori, D. Pál, and C. Szepesvári. Improved algorithms for linear stochastic bandits. Advances
in neural information processing systems, 24, 2011.
P. Abbeel and A. Y. Ng. Apprenticeship learning via inverse reinforcement learning. In Proceedings of the
Twenty-First International Conference on Machine Learning, page 1, 2004.
Y. Abdelkareem, S. Shehata, and F. Karray. Advances in preference-based reinforcement learning: A
review. In 2022 IEEE International Conference on Systems, Man, and Cybernetics (SMC), pages
2527–2532. IEEE, 2022.
N. Ailon, Z. S. Karnin, and T. Joachims. Reducing dueling bandits to cardinal bandits. In ICML,
volume 32, pages 856–864, 2014.
Y. Bai, A. Jones, K. Ndousse, A. Askell, A. Chen, N. DasSarma, D. Drain, S. Fort, D. Ganguli, T. Henighan,
et al. Training a helpful and harmless assistant with reinforcement learning from human feedback.
arXiv preprint arXiv:2204.05862, 2022a.
Y. Bai, S. Kadavath, S. Kundu, A. Askell, J. Kernion, A. Jones, A. Chen, A. Goldie, A. Mirhoseini,
C. McKinnon, et al. Constitutional ai: Harmlessness from ai feedback. arXiv preprint arXiv:2212.08073,
2022b.
R. A. Bradley and M. E. Terry. Rank analysis of incomplete block designs i: The method of paired
comparisons. Biometrika, 39(3/4):324–345, 1952.
J. Bretagnolle and C. Huber.
Estimation des densités: risque minimax.
Zeitschrift für
Wahrscheinlichkeitstheorie und Verwandte Gebiete, 47(2):119–137, 1979. doi: 10.1007/BF00535278.
URL https://doi.org/10.1007/BF00535278.
D. Brown, W. Goo, P. Nagarajan, and S. Niekum. Extrapolating beyond suboptimal demonstrations via
inverse reinforcement learning from observations. In International Conference on Machine Learning,
pages 783–792. PMLR, 2019.
R. Busa-Fekete, B. Szörényi, P. Weng, W. Cheng, and E. Hüllermeier. Preference-based reinforcement
learning: evolutionary direct policy search using a preference-based racing algorithm. Machine Learning,
97(3):327–351, 2014.
Z. Cao, T. Qin, T.-Y. Liu, M.-F. Tsai, and H. Li. Learning to rank: From pairwise approach to listwise
approach. In Proceedings of the 24th International Conference on Machine Learning, pages 129–136,
2007.
N. S. Chatterji, A. Pacchiano, P. L. Bartlett, and M. I. Jordan. On the theory of reinforcement learning
with once-per-episode feedback, 2022.
X. Chen, P. N. Bennett, K. Collins-Thompson, and E. Horvitz. Pairwise ranking aggregation in a
crowdsourced setting. In Proceedings of the Sixth ACM International Conference on Web Search and
Data Mining, pages 193–202, 2013.
X. Chen, H. Zhong, Z. Yang, Z. Wang, and L. Wang. Human-in-the-loop: Provably efficient preferencebased reinforcement learning with general function approximation. In International Conference on
Machine Learning, pages 3773–3793. PMLR, 2022.
Y. Chen and C. Suh. Spectral MLE: top-k rank aggregation from pairwise comparisons. In International
Conference on Machine Learning, pages 371–380. PMLR, 2015.
C.-A. Cheng, T. Xie, N. Jiang, and A. Agarwal. Adversarially trained actor critic for offline reinforcement
learning. arXiv preprint arXiv:2202.02446, 2022.

16

P. F. Christiano, J. Leike, T. Brown, M. Martic, S. Legg, and D. Amodei. Deep reinforcement learning
from human preferences. Advances in Neural Information Processing Systems, 30, 2017a.
P. F. Christiano, J. Leike, T. Brown, M. Martic, S. Legg, and D. Amodei. Deep reinforcement learning
from human preferences. In Advances in Neural Information Processing Systems, pages 4299–4307,
2017b.
L. Faury, M. Abeille, C. Calauzènes, and O. Fercoq. Improved optimistic algorithms for logistic bandits.
In International Conference on Machine Learning, pages 3052–3060. PMLR, 2020.
U. Feige, P. Raghavan, D. Peleg, and E. Upfal. Computing with noisy information. SIAM Journal on
Computing, 23(5):1001–1018, 1994.
P. Florence, C. Lynch, A. Zeng, O. A. Ramirez, A. Wahid, L. Downs, A. Wong, J. Lee, I. Mordatch, and
J. Tompson. Implicit behavioral cloning. In Conference on Robot Learning, pages 158–168. PMLR,
2022.
P. Gajane, T. Urvoy, and F. Clérot. A relative exponential weighing algorithm for adversarial utility-based
dueling bandits. In Proceedings of the 32nd International Conference on Machine Learning, pages
218–227, 2015.
D. Ganguli, L. Lovitt, J. Kernion, A. Askell, Y. Bai, S. Kadavath, B. Mann, E. Perez, N. Schiefer,
K. Ndousse, et al. Red teaming language models to reduce harms: Methods, scaling behaviors, and
lessons learned. arXiv preprint arXiv:2209.07858, 2022.
L. Gao, J. Schulman, and J. Hilton. Scaling laws for reward model overoptimization. arXiv preprint
arXiv:2210.10760, 2022.
S. Ghoshal and A. Saha. Exploiting correlation to achieve faster learning rates in low-rank preference
bandits. In International Conference on Artificial Intelligence and Statistics, pages 456–482. PMLR,
2022.
A. Glaese, N. McAleese, M. Trebacz, J. Aslanides, V. Firoiu, T. Ewalds, M. Rauh, L. Weidinger,
·
M. Chadwick, P. Thacker, et al. Improving alignment of dialogue agents via targeted human judgements.
arXiv preprint arXiv:2209.14375, 2022.
V. P. Godambe. An optimum property of regular maximum likelihood estimation. The Annals of
Mathematical Statistics, 31(4):1208–1211, 1960.
B. Hajek, S. Oh, and J. Xu. Minimax-optimal inference from partial rankings. Advances in Neural
Information Processing Systems, 27, 2014.
R. Heckel, M. Simchowitz, K. Ramchandran, and M. Wainwright. Approximate ranking from pairwise
comparisons. In International Conference on Artificial Intelligence and Statistics, pages 1057–1066.
PMLR, 2018.
R. Heckel, N. B. Shah, K. Ramchandran, and M. J. Wainwright. Active ranking from pairwise comparisons
and when parametric assumptions do not help. Annals of Statistics, 47(6):3099–3126, 2019.
J. Ho and S. Ermon. Generative adversarial imitation learning. Advances in Neural Information Processing
Systems, 29, 2016.
D. Hsu, S. Kakade, and T. Zhang. A tail inequality for quadratic forms of subgaussian random vectors.
Electronic Communications in Probability, 17:1–6, 2012.
A. Hussein, M. M. Gaber, E. Elyan, and C. Jayne. Imitation learning: A survey of learning methods.
ACM Computing Surveys (CSUR), 50(2):1–35, 2017.
A. Jain, B. Wojcik, T. Joachims, and A. Saxena. Learning trajectory preferences for manipulators via
iterative improvement. In Advances in neural information processing systems, pages 575–583, 2013.
17

M. Jang, S. Kim, C. Suh, and S. Oh. Optimal sample complexity of m-wise data for top-k ranking.
Advances in Neural Information Processing Systems, 30, 2017.
Y. Jin, Z. Yang, and Z. Wang. Is pessimism provably efficient for offline RL? In International Conference
on Machine Learning, pages 5084–5096. PMLR, 2021.
J. I. Kiger. The depth/breadth trade-off in the design of menu-driven user interfaces. International journal
of man-machine studies, 20(2):201–213, 1984.
W. B. Knox and P. Stone. Tamer: Training an agent manually via evaluative reinforcement. In 7th IEEE
International Conference on Development and Learning, pages 292–297. IEEE, 2008.
J. Komiyama, J. Honda, H. Kashima, and H. Nakagawa. Regret lower bound and optimal algorithm in
dueling bandit problem. In COLT, pages 1141–1154, 2015.
I. Kostrikov, A. Nair, and S. Levine. Offline reinforcement learning with implicit Q-learning. arXiv
preprint arXiv:2110.06169, 2021.
A. Kumar, A. Zhou, G. Tucker, and S. Levine. Conservative Q-learning for offline reinforcement learning.
Advances in Neural Information Processing Systems, 33:1179–1191, 2020.
A. Kupcsik, D. Hsu, and W. S. Lee. Learning dynamic robot-to-human object handover from human
feedback. In Robotics research, pages 161–176. Springer, 2018.
M.-j. Lee. M-estimator and maximum likelihood estimator (mle). In Micro-Econometrics, pages 91–132.
Springer, 2008.
G. Li, C. Ma, and N. Srebro. Pessimism for offline linear contextual bandits using ℓp confidence sets.
arXiv preprint arXiv:2205.10671, 2022.
T.-Y. Liu et al. Learning to rank for information retrieval. Foundations and Trends® in Information
Retrieval, 3(3):225–331, 2009.
R. D. Luce. Individual Choice Behavior: A Theoretical Analysis. Courier Corporation, 2012.
J. MacGlashan, M. K. Ho, R. Loftin, B. Peng, G. Wang, D. L. Roberts, M. E. Taylor, and M. L. Littman.
Interactive learning from policy-dependent human feedback. In International Conference on Machine
Learning, pages 2285–2294. PMLR, 2017.
C. Mao, J. Weed, and P. Rigollet. Minimax rates and efficient algorithms for noisy sorting. In Algorithmic
Learning Theory, pages 821–847. PMLR, 2018.
J. Menick, M. Trebacz, V. Mikulik, J. Aslanides, F. Song, M. Chadwick, M. Glaese, S. Young, L. CampbellGillingham, G. Irving, et al. Teaching language models to support answers with verified quotes. arXiv
preprint arXiv:2203.11147, 2022.
G. A. Miller. The magical number seven, plus or minus two: Some limits on our capacity for processing
information. Psychological Review, 63(2):81, 1956.
R. Nakano, J. Hilton, S. Balaji, J. Wu, L. Ouyang, C. Kim, C. Hesse, S. Jain, V. Kosaraju,
W. Saunders, et al. Webgpt: Browser-assisted question-answering with human feedback. arXiv
preprint arXiv:2112.09332, 2021.
S. Negahban, S. Oh, K. K. Thekumparampil, and J. Xu. Learning from comparisons and choices. The
Journal of Machine Learning Research, 19(1):1478–1572, 2018.
G. Neu and C. Szepesvári. Training parsers by inverse reinforcement learning. Machine Learning, 77(2):
303–337, 2009.
A. Y. Ng, S. Russell, et al. Algorithms for inverse reinforcement learning. In International Conference on
Machine Learning, volume 1, page 2, 2000.
18

E. R. Novoseller, Y. Sui, Y. Yue, and J. W. Burdick. Dueling posterior sampling for preference-based
reinforcement learning. arXiv preprint arXiv:1908.01289, 2019.
L. Ouyang, J. Wu, X. Jiang, D. Almeida, C. L. Wainwright, P. Mishkin, C. Zhang, S. Agarwal, K. Slama,
A. Ray, et al. Training language models to follow instructions with human feedback. arXiv preprint
arXiv:2203.02155, 2022.
A. Pacchiano, A. Saha, and J. Lee. Dueling rl: reinforcement learning with trajectory preferences. arXiv
preprint arXiv:2111.04850, 2021.
R. L. Plackett. The analysis of permutations. Journal of the Royal Statistical Society: Series C (Applied
Statistics), 24(2):193–202, 1975.
A. Rajkumar and S. Agarwal. A statistical convergence perspective of algorithms for rank aggregation
from pairwise data. In International conference on machine learning, pages 118–126. PMLR, 2014.
D. Ramachandran and E. Amir. Bayesian inverse reinforcement learning. In IJCAI, volume 7, pages
2586–2591, 2007.
R. Ramamurthy, P. Ammanabrolu, K. Brantley, J. Hessel, R. Sifa, C. Bauckhage, H. Hajishirzi, and
Y. Choi. Is reinforcement learning (not) for natural language processing?: Benchmarks, baselines, and
building blocks for natural language policy optimization. arXiv preprint arXiv:2210.01241, 2022.
P. Rashidinejad, B. Zhu, C. Ma, J. Jiao, and S. Russell. Bridging offline reinforcement learning and
imitation learning: A tale of pessimism. Advances in Neural Information Processing Systems, 34:
11702–11716, 2021.
T. L. Saaty and M. S. Ozdemir. Why the magic number seven plus or minus two. Mathematical and
computer modelling, 38(3-4):233–244, 2003.
D. Sadigh, A. D. Dragan, S. Sastry, and S. A. Seshia. Active preference-based learning of reward functions.
In Robotics: Science and Systems, 2017.
A. Saha and A. Gopalan. Battle of bandits. In Uncertainty in Artificial Intelligence, 2018a.
A. Saha and A. Gopalan. Active ranking with subset-wise preferences. International Conference on
Artificial Intelligence and Statistics (AISTATS), 2018b.
A. Saha and A. Gopalan. PAC Battling Bandits in the Plackett-Luce Model. In Algorithmic Learning
Theory, pages 700–737, 2019.
A. Saha and A. Krishnamurthy. Efficient and optimal algorithms for contextual dueling bandits under
realizability. In International Conference on Algorithmic Learning Theory, pages 968–994. PMLR, 2022.
N. Shah, S. Balakrishnan, J. Bradley, A. Parekh, K. Ramchandran, and M. Wainwright. Estimation from
pairwise comparisons: Sharp minimax bounds with topology dependence. In Artificial Intelligence and
Statistics, pages 856–865. PMLR, 2015.
N. B. Shah and M. J. Wainwright. Simple, robust and optimal ranking from pairwise comparisons. The
Journal of Machine Learning Research, 18(1):7246–7283, 2017.
R. M. Shiffrin and R. M. Nosofsky. Seven plus or minus two: a commentary on capacity limitations. 1994.
D. Shin, A. D. Dragan, and D. S. Brown. Benchmarks and algorithms for offline preference-based reward
learning. arXiv preprint arXiv:2301.01392, 2023.
M. Soare, A. Lazaric, and R. Munos. Best-arm identification in linear bandits. Advances in Neural
Information Processing Systems, 27, 2014.

19

N. Stiennon, L. Ouyang, J. Wu, D. Ziegler, R. Lowe, C. Voss, A. Radford, D. Amodei, and P. F. Christiano.
Learning to summarize with human feedback. Advances in Neural Information Processing Systems, 33:
3008–3021, 2020.
A. W. Van der Vaart. Asymptotic Statistics, volume 3. Cambridge university press, 2000.
G. Warnell, N. Waytowich, V. Lawhern, and P. Stone. Deep tamer: Interactive agent shaping in highdimensional state spaces. In Proceedings of the AAAI Conference on Artificial Intelligence, volume 32,
2018.
C. Wirth, J. Furnkranz, G. Neumann, et al. Model-free preference-based reinforcement learning. In 30th
AAAI Conference on Artificial Intelligence, AAAI 2016, pages 2222–2228, 2016.
C. Wirth, R. Akrour, G. Neumann, and J. Fürnkranz. A survey of preference-based reinforcement learning
methods. The Journal of Machine Learning Research, 18(1):4945–4990, 2017.
J. Wu, L. Ouyang, D. M. Ziegler, N. Stiennon, R. Lowe, J. Leike, and P. Christiano. Recursively
summarizing books with human feedback. arXiv preprint arXiv:2109.10862, 2021.
F. Xia, T.-Y. Liu, J. Wang, W. Zhang, and H. Li. Listwise approach to learning to rank: theory and
algorithm. In Proceedings of the 25th International Conference on Machine Learning, pages 1192–1199,
2008.
T. Xie, C.-A. Cheng, N. Jiang, P. Mineiro, and A. Agarwal. Bellman-consistent pessimism for offline
reinforcement learning. Advances in Neural Information Processing Systems, 34:6683–6694, 2021a.
T. Xie, N. Jiang, H. Wang, C. Xiong, and Y. Bai. Policy finetuning: Bridging sample-efficient offline and
online reinforcement learning. Advances in Neural Information Processing Systems, 34:27395–27407,
2021b.
T. Xu and Y. Liang. Provably efficient offline reinforcement learning with trajectory-wise reward. arXiv
preprint arXiv:2206.06426, 2022.
Y. Xu, R. Wang, L. Yang, A. Singh, and A. Dubrawski. Preference-based reinforcement learning
with finite-time guarantees. In H. Larochelle, M. Ranzato, R. Hadsell, M. F. Balcan, and
H. Lin, editors, Advances in Neural Information Processing Systems, volume 33, pages 18784–
18794. Curran Associates, Inc., 2020. URL https://proceedings.neurips.cc/paper/2020/file/
d9d3837ee7981e8c064774da6cdd98bf-Paper.pdf.
B. Yu. Assouad, fano, and le cam. In Festschrift for Lucien Le Cam, pages 423–435. Springer, 1997.
Y. Yue and T. Joachims. Interactively optimizing information retrieval systems as a dueling bandits
problem. In Proceedings of the 26th Annual International Conference on Machine Learning, pages
1201–1208. ACM, 2009.
Y. Yue and T. Joachims. Beat the mean bandit. In Proceedings of the 28th International Conference on
Machine Learning (ICML-11), pages 241–248, 2011.
Y. Yue, J. Broder, R. Kleinberg, and T. Joachims. The k-armed dueling bandits problem. Journal of
Computer and System Sciences, 78(5):1538–1556, 2012.
A. Zanette. When is realizability sufficient for off-policy reinforcement learning?
arXiv:2211.05311, 2022.

arXiv preprint

A. Zanette, M. J. Wainwright, and E. Brunskill. Provable benefits of actor-critic methods for offline
reinforcement learning. Advances in Neural Information Processing Systems, 34:13626–13640, 2021.
B. D. Ziebart, A. L. Maas, J. A. Bagnell, A. K. Dey, et al. Maximum entropy inverse reinforcement
learning. In AAAI, volume 8, pages 1433–1438. Chicago, IL, USA, 2008.

20

D. M. Ziegler, N. Stiennon, J. Wu, T. B. Brown, A. Radford, D. Amodei, P. Christiano, and G. Irving.
Fine-tuning language models from human preferences. arXiv preprint arXiv:1909.08593, 2019.
M. Zoghi, S. Whiteson, R. Munos, M. d. Rijke, et al. Relative upper confidence bound for the k-armed
dueling bandit problem. In JMLR Workshop and Conference Proceedings, number 32, pages 10–18.
JMLR, 2014a.
M. Zoghi, S. A. Whiteson, M. De Rijke, and R. Munos. Relative confidence sampling for efficient on-line
ranker evaluation. In Proceedings of the 7th ACM international conference on Web search and data
mining, pages 73–82. ACM, 2014b.

21

A

Analysis for nonlinear rθ

Consider the case of pairwise comparison when rθ is not linear, the MLE can be written as
θ̂MLE ∈ arg min ℓD (θ),
θ∈ΘB
n
X

exp(rθ (si , ai0 ))
exp(rθ (si , ai1 ))
i
+
1(y
=
0)
·
where ℓD (θ) = −
log 1(y = 1) ·
exp(rθ (si , ai0 )) + exp(rθ (si , ai1 ))
exp(rθ (si , ai0 )) + exp(rθ (si , ai1 ))
i=1


i

Here we provide a guarantee for the case when rθ is nonlinear and non-convex. We first make the following
boundedness and smoothness assumption on rθ :
Assumption A.1. Assume that for any θ ∈ ΘB , s ∈ S, a0 ∈ A, a1 ∈ A with a0 ̸= a1 , we have,
|rθ (s, a)| ≤ α0 ,

(Bounded value)

∥∇rθ (s, a)∥2 ≤ α1 ,

(Bounded gradient)

∥∇2 rθ (s, a)∥2 ≤ α2 . (Bounded Hessian / Lipschitz gradient)
One can verify that our linear reward satisfies the above assumption with α0 = LB, α1 = L, α2 = 0.
Under this assumption, we have
Theorem A.2. For any λ > 0, with probability at least 1 − δ,
s
d + log(1/δ)
+ (λ + α2 /γ + α1 α2 B)B 2 .
∥θ̂MLE − θ⋆ ∥ΣD +λI ≤ C ·
γ2n
Here γ = 2+exp(−2α10 )+exp(2α0 ) , ΣD = n1

Pn

i i
i i
i i
i i ⊤
⋆
⋆
⋆
⋆
i=1 ∇(rθ (s , a1 ) − rθ (s , a0 ))∇(rθ (s , a1 ) − rθ (s , a0 )) .

The proof is deferred to Appendix B.10. Our result recovers Lemma 3.1 when α2 = 0 and reveals how
the gradient of r plays a role in the bound for estimation error. However, the dependence on α2 will not
vanish as n → ∞. It remains open how to get vanishing rate for nonlinear reward functions when α2 > 0.
Similar argument can also be applied to the case of K-wise comparison and MDP. And we can similarly
design pessimistic MLE based on the confidence bound on θ̂MLE .
On the other hand, we can show that the true parameter θ⋆ is a global minimum of the population
negative log likelihood even when rθ is nonlinear and we use MLE2 for K-wise comparison. Recall that
the MLE2 splits K-wise comparisons into pairwise comparisons, and is given by
θ̂MLE2 ∈ arg min ℓD (θ),
θ∈ΘB
n K−1 K−1
1XX X
log
where ℓD (θ) = −
n i=1 j=0
k=j+1

exp(rθ (si , aiσi (j) ))
exp(rθ (si , aiσi (j) )) + exp(rθ (si , aiσi (k) ))

!
.

When there is infinite number of data, the loss become


exp(rθ⋆ (s, a0 ))
exp(rθ (s, a0 ))
log
exp(rθ⋆ (s, a0 )) + exp(rθ⋆ (s, a1 ))
exp(rθ (s, a0 )) + exp(rθ (s, a1 ))
s
a0 ,a1 ∈A


exp(rθ⋆ (s, a1 ))
exp(rθ (s, a1 ))
+
log
.
exp(rθ⋆ (s, a0 )) + exp(rθ⋆ (s, a1 ))
exp(rθ (s, a0 )) + exp(rθ (s, a1 ))

E[ℓ(θ)] = −

X

ρ(s)

X

ρ(a0 , a1 | s) ·



Here ρ(a0 , a1 | s) is the probability that actions a0 , a1 are included in the K-comparison when the state is
s. Now we show
θ⋆ ∈ arg min E[ℓ(θ)].
θ

22

(1)


.

To see this, note that we have


exp(rθ⋆ (s, a0 ))
exp(rθ (s, a0 ))
log
exp(rθ⋆ (s, a0 )) + exp(rθ⋆ (s, a1 ))
exp(rθ (s, a0 )) + exp(rθ (s, a1 ))
s
a0 ,a1 ∈A


exp(rθ⋆ (s, a1 ))
exp(rθ (s, a1 ))
+
log
exp(rθ⋆ (s, a0 )) + exp(rθ⋆ (s, a1 ))
exp(rθ (s, a0 )) + exp(rθ (s, a1 ))
X
X
=
ρ(s)
p(a0 , a1 | s) · (H(pθ⋆ (s, a0 , a1 )) + KL(pθ⋆ (s, a0 , a1 )∥pθ (s, a0 , a1 ))).

E[ℓ(θ)] = −

X

ρ(s)

s

X

ρ(a0 , a1 | s) ·



a0 ,a1 ∈A

Here H(p) = p log(1/p) + (1 − p) log(1/(1 − p)) is the entropy of a Bernoulli distribution with parameter
exp(rθ (s,a1 ))
p. And pθ (s, a0 , a1 ) = exp(rθ (s,a
. Now note that KL is lower bounded by 0, with equality
0 ))+exp(rθ (s,a1 ))
⋆
when θ = θ . This proves Equation (1).

B

Remaining Proofs

B.1

Proof of Lemma 3.1

Recall that the MLE is given by
θ̂MLE ∈ arg min ℓD (θ),
θ∈ΘB
n
X


exp(rθ (si , ai1 ))
exp(rθ (si , ai0 ))
i
+
1(y
=
0)
·
exp(rθ (si , ai0 )) + exp(rθ (si , ai1 ))
exp(rθ (si , ai0 )) + exp(rθ (si , ai1 ))
i=1



n
X
1
1
i
=−
log 1(y i = 1) ·
+
1(y
=
0)
·
1
−
1 + exp(rθ (si , ai0 ) − rθ (si , ai1 ))
1 + exp(rθ (si , ai0 ) − rθ (si , ai1 ))
i=1



n
X
1
1
i
=−
log 1(y i = 1) ·
+
1(y
=
0)
·
1
−
1 + exp(θ⊤ (ϕ(si , ai0 ) − ϕ(si , ai1 )))
1 + exp(θ⊤ (ϕ(si , ai0 ) − ϕ(si , ai1 )))
i=1

log 1(y i = 1) ·

where ℓD (θ) = −

To simplify the notation, we let xi = ϕ(si , ai1 ) − ϕ(si , ai0 ). Our goal is to bound the estimation error of
the MLE in the squared semi-norm ∥v∥2ΣD +λI = v ⊤ (ΣD + λI)v.
Strong convexity of ℓ. We first show that ℓD is strongly convex at θ⋆ with respect to the semi-norm
∥ · ∥ΣD , meaning that there is some constant γ > 0 such that
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≥ γ∥∆∥2ΣD
for all perturbations ∆ ∈ Rd such that θ⋆ + ∆ ∈ ΘB .
One can directly calculate the Hessian of ℓ as

n 
1X
exp(−⟨θ, xi ⟩)
exp(⟨θ, xi ⟩)
i
i
∇ ℓD (θ) =
1(y = 1) ·
· xi x⊤
+ 1(y = 0) ·
i
n i=1
(exp(−⟨θ, xi ⟩) + 1)2
(exp(⟨θ, xi ⟩) + 1)2
2

n

=

1X
exp(−⟨θ, xi ⟩)
· xi x⊤
i
n i=1 (exp(−⟨θ, xi ⟩) + 1)2

Observe that ⟨θ, xi ⟩ ∈ [−2LB, 2LB], which gives that
exp(−⟨θ, xi ⟩)
1
≥
.
2
(exp(−⟨θ, xi ⟩) + 1)
2 + exp(−2LB) + exp(2LB)
Putting together the pieces, we conclude that
v ⊤ ∇2 ℓD (θ)v ≥

γ
∥Xv∥22
n

23

for all v,

(2)

where γ = 1/(2 + exp(−2LB) + exp(2LB)), X ∈ Rn×d has the differencing vector xi ∈ Rd as its ith row.
Thus, if we introduce the error vector ∆ := θ̂MLE − θ⋆ , then we may conclude that
γ
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≥ ∥X∆∥22 = γ∥∆∥2ΣD ,
n
showing that ℓD is strongly convex around θ⋆ with parameter γ.
Bounding the estimation error. Now we aim at bounding the estimation error ∥θ̂MLE − θ⋆ ∥ΣD .
Since θ̂MLE is optimal for ℓD , we have ℓD (θ̂MLE ) ≤ ℓD (θ⋆ ). (When θ̂MLE is approximately optimal, i.e.
ℓD (θ̂MLE ) ≤ minθ ℓD (θ) + ϵ, the same argument also holds up to an extra additive term ϵ.) Defining the
error vector ∆ = θ̂MLE − θ⋆ , adding and subtracting the quantity ⟨∇ℓD (θ⋆ ), ∆⟩ yields the bound
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≤ −⟨∇ℓD (θ⋆ ), ∆⟩.
By the γ-convexity condition, the left-hand side is lower bounded by γ∥∆∥2ΣD . As for the right-hand side,
note that |⟨∇ℓD (θ⋆ ), ∆⟩| ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI for any λ > 0. Altogether we have
γ∥∆∥2ΣD ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI .
Now we further bound the term ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 . Observe that the gradient takes the form

n 
exp(−⟨θ⋆ , xi ⟩)
1
−1 X
i
⋆
i
1[y = 1]
− 1[y = 0]
xi .
∇ℓD (θ ) =
n i=1
1 + exp(−⟨θ⋆ , xi ⟩))
1 + exp(−⟨θ⋆ , xi ⟩))
Define a random vector V ∈ Rn with independent components as
( exp(−⟨θ⋆ , x ⟩)
1
i
w.p.
⋆ , x ⟩))
1+exp(−⟨θ ⋆ , xi ⟩))
i
⋆
Vi = 1+exp(−⟨θ
exp(−⟨θ
, xi ⟩)
−1
w.p.
1+exp(−⟨θ ⋆ , xi ⟩))
1+exp(−⟨θ ⋆ , xi ⟩)) .
With this notation, we have ∇ℓD (θ⋆ ) = − n1 X ⊤ V . One can verify that E[V ] = 0 and |Vi | ≤ 1.
Defining the n-dimensional square matrix M := n12 X(ΣD + λI)−1 X ⊤ , we have ∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 =
V ⊤ M V . Let the eigenvalue decomposition of X ⊤ X be X ⊤ X = U ΛU ⊤ . We can bound the trace and
operator norm of M as
1
d
Tr(U (Λ/n + λI)−1 U ⊤ U ΛU ⊤ ) ≤
2
n
n
1
d
2
−1 ⊤
⊤
Tr(M ) = 4 Tr(U (Λ/n + λI) U U ΛU U (Λ/n + λI)−1 U ⊤ U ΛU ⊤ ) ≤ 2
n
n
1
∥M ∥op = λmax (M ) ≤ ,
n
Tr(M ) =

Moreover, since the components of V are independent and of zero mean, and |Vi | ≤ 1, the variables are
1-sub-Gaussian, and hence the Bernstein’s inequality for sub-Gaussian random variables in quadratic form
(see e.g. Hsu et al. (2012, Theorem 2.1)) implies that with probability at least 1 − δ,
∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 = V ⊤ M V ≤ C1 ·

d + log(1/δ)
.
n

Here C1 is some universal constant. This gives us
γ∥∆∥2ΣD +λI ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI + 4λγB 2
r
d + log(1/δ)
≤ C1 ·
∥∆∥ΣD +λI + 4λγB 2 .
n
Solving the above inequality gives us that for some constant C2 ,
s
d + log(1/δ)
∥∆∥ΣD +λI ≤ C2 ·
+ λB 2 .
γ2n
24

B.2

Proof of Theorem 3.2

Proof. Let J ′ (π) = J(π) − ⟨θ⋆ , v⟩. We have
SubOpt(π̂PE ) = J(π ⋆ ) − J(π̂PE )
= J ′ (π ⋆ ) − J ′ (π̂PE )
ˆ ⋆ )) + (J(π
ˆ ⋆ ) − J(π̂
ˆ PE )) + (J(π̂
ˆ PE ) − J ′ (π̂PE )).
= (J ′ (π ⋆ ) − J(π
Since π̂PE is the optimal policy under expected value J ′ (π), we know that the second difference satisfies
ˆ ⋆ ) − J(π̂
ˆ PE ) ≤ 0. For the third difference, we have
J(π
ˆ PE ) − J ′ (π̂PE ) =
J(π̂

min

Es∼ρ [θ⊤ (ϕ(s, π(s)) − v)] − Es∼ρ [θ⋆⊤ (ϕ(s, π(s)) − v)].

θ∈Θ(θ̂MLE ,λ)

From Lemma 3.1 we know that θ⋆ ∈ Θ(θ̂MLE , λ) with probability at least 1 − δ. Thus we know that with
ˆ PE ) − J ′ (π̂PE ) ≤ 0. Now combining everything together and condition on the
probability at least 1 − δ, J(π̂
above event, we have
ˆ ⋆)
SubOpt(π̂PE ) ≤ J ′ (π ⋆ ) − J(π
=

Es∼ρ [(θ⋆ − θ)⊤ (ϕ(s, π ⋆ (s)) − v)]

sup
θ∈Θ(θ̂MLE ,λ)

=

Es∼ρ [(θ⋆ − θ̂MLE + θ̂MLE − θ)⊤ (ϕ(s, π ⋆ (s)) − v)]

sup
θ∈Θ(θ̂MLE ,λ)

= Es∼ρ [(θ⋆ − θ̂MLE )⊤ (ϕ(s, π ⋆ (s)) − v)] +

sup

Es∼ρ [(θ̂MLE − θ)⊤ (ϕ(s, π ⋆ (s)) − v)].

θ∈Θ(θ̂MLE ,λ)

By the definition
of Θ(θ̂MLE , λ), we know that for any θ ∈ Θ(θ̂MLE , λ), one has Es∼ρ [(θ̂MLE −θ)⊤ (ϕ(s, π ⋆ (s))−
q

v)] ≤ C ·

d+log(1/δ)
+ λB 2 · ∥(ΣD + λI)−1/2 Es∼ρ [ϕ(s, π ⋆ (s)) − v]∥2 .
γ2n

Furthermore, we know that θ⋆ ∈

Θ(θ̂MLE , λ) from Lemma 3.1. Altogether we have with probability 1 − δ
s
d + log(1/δ)
SubOpt(π̂PE ) ≤ 2C ·
+ λB 2 · ∥(ΣD + λI)−1/2 Es∼ρ [ϕ(s, π ⋆ (s)) − v]∥2 .
γ2n

B.3

Proof of Theorem 3.9

Proof. Consider 4 actions with parameter ϕ(a1 ) = [1, 1, 0], ϕ(a2 ) = [1, 0, 0], ϕ(a3 ) = [0, 0, 0], ϕ(a4 ) =
[0, 1, 0]. Let the true reward be θ⋆ = [−1, 0.1, 0.9] ∈ ΘB with B = 2. We query n − 1 times a1 , a2 and 1
time a2 , a3 . For the single pairwise comparison result Y2>3 between a2 and a3 , we know that
P (Y2>3 = 1) =

exp((ϕ(a2 ) − ϕ(a3 ))⊤ θ⋆ )
> 0.26.
1 + exp((ϕ(a2 ) − ϕ(a3 ))⊤ θ⋆ )

Now conditioned on the event that Y2>3 = 1, we know that the MLE aims to find
θ̂MLE = arg min ℓD (θ),
θ∈ΘB




exp((ϕ(a1 ) − ϕ(a2 ))⊤ θ)
exp((ϕ(a2 ) − ϕ(a1 ))⊤ θ)
where ℓD (θ) = −n1>2 · log
− n1<2 · log
1 + exp((ϕ(a1 ) − ϕ(a2 ))⊤ θ)
1 + exp((ϕ(a2 ) − ϕ(a1 ))⊤ θ)


exp((ϕ(a2 ) − ϕ(a3 ))⊤ θ)
− log
1 + exp((ϕ(a2 ) − ϕ(a3 ))⊤ θ)






exp(θ2 )
exp(−θ2 )
exp(θ1 )
= −n1>2 · log
− n1<2 · log
− log
.
1 + exp(θ2 )
1 + exp(−θ2 )
1 + exp(θ1 )


25

By concentration of n1>2 , we know that when n > 500, with probability at least 0.5, we have
n1<2 > 0.45n.
Under this case, the MLE will satisfy at θ̂1 > 0, θ̂2 < 0.5. Thus the policy based on MLE estimator will
choose action a1 or a2 instead of the optimal action a4 under the events above. The expected suboptimality
is
E[V ⋆ (s) − V π̂MLE (s)] ≥ 0.26 ∗ 0.5 ∗ 1 > 0.1.
On the other hand, one can calculate the coverage as
−1/2

∥ΣD

Es∼ρ [ϕ(s, π ⋆ (s))]∥2 =

n
.
n−1

Thus by Theorem 3.2 we know that pessimistic MLE achieves vanishing error.

B.4

Proof of Theorem 3.10

Proof. Assume without loss of generality that d/3 is some integer. We set S = [d/3], A = {a1 , a2 , a3 }. For
each of the s, ai , we set ϕ(s, a1 ) = e3s+1 , ϕ(s, a2 ) = e3s+2 , ϕ(s, a3 ) = 0. We set the initial distribution of
states as ρ = Unif([1, 2, · · · , S]), the query times n(s, a2 , a3 ) = n/S · (1 − 2/Λ2 ), n(s, a1 , a3 ) = n/S · (2/Λ2 ).
Let v−1 = [1/d, 1/d + ∆, −2/d − ∆], v+1 = [1/d + 2∆, 1/d + ∆, −2/d − 3∆]. We construct 2S instances,
S
indexed
, where each θτ = [vτ1 , vτ2 , · · · , vτS ]. One can see that E[VQ (π ⋆ ) − VQ⋆ (π̂)] =
P by τ ∈ {±1}
⋆
1/S · s∈S (rQ (s, π (s)) − rQ (s, π̂(s))). Under each θτ , the optimal policy π(s) is either a1 or a2 . One can
−1/2
verify that ∥ΣD Es∼ρ [ϕ(s, π ⋆ (s)])]∥2 ≤ Λ and that θτ ∈ ΘB with B = 1 when d > 6 and ∆ < 1/(6d).
Furthermore, for any θτ , θτ ′ that differs only in the j-th coordinate of τ , we have
1/S · (rQτ (j, π ⋆ (j)) − rQτ (j, π̂(j)) + rQτ ′ (j, π ⋆ (j)) − rQτ ′ (j, π̂(j))) ≥ ∆/S.
Thus by Assouad’s lemma (see e.g. Yu (1997)), we have
inf

sup

π̂ Q∈CB(λ)

E[VQ (π ⋆ ) − VQ⋆ (π̂)] ≥ S ·
≥

∆
min (1 − TV(Pθτ , Pθτ ′ ))
2S τ ∼τ ′

∆
min exp(−DKL (Pθτ , Pθτ ′ )).
4 τ ∼τ ′

Here τ ∼ τ ′ refers to any τ, τ ′ that only differs in one element. And the last inequality is due to the
Bretagnolle–Huber inequality Bretagnolle and Huber (1979). To bound the KL divergence, we have the
following lemma from Shah et al. (2015):
Lemma B.1 (Shah et al. (2015)). For any pair of quality score vectors θτ and θτ ′ , we have
DKL (Pθτ ∥Pθτ ) ≤ Cn(θτ − θτ ′ )⊤ ΣD (θτ − θτ ′ ).
From the lemma, we have
inf

sup

π̂ Q∈CB(λ)

E[VQ (π ⋆ ) − VQ⋆ (π̂)] ≥
≥

∆
min exp(−DKL (Pθτ , Pθτ ′ ))
2 τ ∼τ ′
∆
exp(−Cn∆2 /(SΛ2 ))
2

p
Taking ∆ = Λ S/n and noting that S = d/3 finishes the proof.

26

(3)

B.5

Proof of Theorem 4.1

This section presents the proof of Theorem 4.1 for the setting of K-wise comparisons. We first prove the
following lemma on the estimation error:
Lemma B.2. Under the K-wise PL model, for any λ > 0, with probability at least 1 − δ,
s
K 4 (d + log(1/δ))
∥θ̂MLE − θ⋆ ∥ΣD +λI ≤ C ·
+ λB 2 .
γ2n
Recall that the MLE is given by
θ̂MLE ∈ arg min ℓD (θ),
θ∈ΘB
n K−1

1XX
where ℓD (θ) = −
log
n i=1 j=0

exp(⟨θ, ϕ(si , aiσi (j) )⟩)
PK−1
k=j

exp(⟨θ, ϕ(si , aiσi (k) )⟩)

!
.

Our goal is to bound the estimation error of the MLE in the squared semi-norm ∥v∥2ΣD +λI =
v (ΣD + λI)v.
⊤

Strong convexity of ℓ. We first show that ℓD is strongly convex at θ⋆ with respect to the semi-norm
∥ · ∥ΣD , meaning that there is some constant γ > 0 such that
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≥ γ∥∆∥2ΣD

(4)

for all perturbations ∆ ∈ Rd such that θ⋆ + ∆ ∈ ΘB .
The gradient of the negative log likelihood is
∇ℓD (θ) = −

n K−1 K−1
exp(⟨θ, ϕ(si , aiσi (k) )⟩)
1XX X
· (ϕ(si , aiσi (j) ) − ϕ(si , aiσi (k) )).
PK−1
i , ai
n i=1 j=0
exp(⟨θ,
ϕ(s
)⟩)
′
k′ =j
k=j

σi (k )

The Hessian of the negative log likelihood can be written as
∇2 ℓD (θ)
n K−1 K−1 K−1

=

i

i

i

i

1 X X X X exp(⟨θ, ϕ(s , aσi (k) ) + ϕ(s , aσi (k′ ) )⟩)
· (ϕ(si , aiσi (k) ) − ϕ(si , aiσi (k′ ) ))(ϕ(si , aiσi (k) ) − ϕ(si , aiσi (k′ ) ))⊤ .
PK−1
n i=1 j=0
2( k′ =j exp(⟨θ, ϕ(si , ai ′ )⟩))2
′
k=j k =j

σi (k )

Since exp(⟨θ, ϕ⟩) ∈ [exp(−LB), exp(LB)], we know that the coefficients satisfy
exp(⟨θ, ϕ(si , aiσi (k) ) + ϕ(si , aiσi (k′ ) )⟩)
exp(−4LB)
≥
.
PK−1
i
i
2
2(K − j)2
( k′ =j exp(⟨θ, ϕ(s , aσi (k′ ) )⟩))
Set γ = exp(−4LB)/2. We can verify that for any vector v ∈ RK , one has


n K−1
K−1
K−1
X
X
X
X
1
γ
(ϕ(si , aiσi (k) ) − ϕ(si , aiσi (k′ ) ))(ϕ(si , aiσi (k) ) − ϕ(si , aiσi (k′ ) ))⊤  v
v ⊤ ∇2 ℓD (θ)v ≥ v ⊤ 
2
n
(K
−
j)
i=1 j=0
k=j k′ =k


n
K−1
K−1
X
X K−1
X
γ ⊤ X
1
≥ v
min
(ϕ(si , aiσi (k) ) − ϕ(si , aiσi (k′ ) ))(ϕ(si , aiσi (k) ) − ϕ(si , aiσi (k′ ) ))⊤  v
2
n
(K
−
j)
σi ∈Π[K]
′
i=1
j=0
k=j k =k

⊤

≥ γv ΣD v
= γ∥v∥2ΣD .
Thus we know that ℓ is γ-strongly convex with respect to the semi-norm ∥ · ∥ΣD .
27

Bounding the estimation error. Now we aim at bounding the estimation error ∥θ̂MLE − θ⋆ ∥ΣD+λI .
Since θ̂MLE is optimal for ℓD , we have ℓD (θ̂MLE ) ≤ ℓD (θ⋆ ). Defining the error vector ∆ = θ̂MLE − θ⋆ ,
adding and subtracting the quantity ⟨∇ℓD (θ⋆ ), ∆⟩ yields the bound
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≤ −⟨∇ℓD (θ⋆ ), ∆⟩.
By the γ-convexity condition, the left-hand side is lower bounded by γ∥∆∥2ΣD . As for the right-hand side,
note that |⟨∇ℓD (θ⋆ ), ∆⟩| ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI for any λ > 0. Altogether we have
γ∥∆∥2ΣD ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI .
Now we further bound the term ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 . Observe that the gradient takes the form
∇ℓD (θ⋆ ) = −

n K−1 K−1
exp(⟨θ⋆ , ϕ(si , aiσi (k) )⟩)
1XX X
· (ϕ(si , aiσi (j) ) − ϕ(si , aiσi (k) )).
PK−1
⋆ , ϕ(si , ai
n i=1 j=0
)⟩)
exp(⟨θ
′
k′ =j
k=j

(5)

σi (k )

We set xijk = ϕ(si , aij ) − ϕ(si , aik ). X ∈ R(nK(K−1)/2)×d has the differencing vector xijk as its (iK(K −
PK
i
1)/2 + k + l=K−j+1 l)th row. We also define Vjk
be the random variable of the coefficient of xijk in
Equation (5) under the PL model, i.e. conditioned on an arbitrary permutation σi ,

exp(⟨θ ⋆ , ϕ(si ,aik )⟩)

,
if σi−1 (j) < σi−1 (k)

 PK−1
exp(⟨θ ⋆ , ϕ(si ,ai
)⟩)
i
Vjk
=

k′ =σ

σi (k′ )

−1
(j)
i

⋆

i

i

exp(⟨θ , ϕ(s ,aj )⟩)


− PK−1 −1 exp(⟨θ⋆ , ϕ(si ,aiσ (k′ ) )⟩) ,
k′ =σ

i

otherwise.

i

(k)

Here σi−1 (j) < σi−1 (k) means that the j-th item ranks higher than the k-th item. Let Ṽi ∈ RK(K−1)/2 be
i
the concatenated random vector of {Vjk
}0≤j<k≤K−1 , V ∈ RnK(K−1)/2 be the concatenated random vector
of {Ṽi }ni=1 . We know that Ṽi and Ṽj are independent for each i =
̸ j due to the independent sampling
procedure. We can also verify that the mean of Ṽi is 0, the proof of which is deferred to the end of this
section. Furthermore, since under any permutation, the sum of absolute value of each element in Ṽi is at
most K, we know that Ṽi is sub-Gaussian with parameter K. Thus we know that V is also sub-Gaussian
with mean 0 and parameter K. Now we know that the term ∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 can be written as
∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 =

1 ⊤
V X(ΣD + λI)−1 X ⊤ V.
n2

2

Let M = Kn I. One can verify that M ⪰ n12 X(ΣD + λI)−1 X ⊤ almost surely since λmax (X(ΣD +
λI)−1 X ⊤ /n2 ) ≤ K 2 /n. Thus we can upper bound the original term as
∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 ≤

K2
∥V ∥22 .
n

By Bernstein’s inequality for sub-Gaussian random variables in quadratic form (see e.g. Hsu et al. (2012,
Theorem 2.1)), we know that with probability at least 1 − δ,
∥V ∥22 ≤ CK 2 · (d + log(1/δ)).
Thus altogether, we have
r
γ∥∆∥2ΣD ≤

CK 4 · (d + log(1/δ))
∥∆∥ΣD +λI .
n

Similar to the pairwise comparison analysis in Appendix B.1, we can derive that with probability at least
1 − δ,
r
K 4 (d + log(1/δ))
⋆
∥θ̂MLE − θ ∥ΣD +λI ≤ C ·
+ λB 2 .
n
28

The rest of the proof on the sub-optimality upper bound follows the same argument as Theorem 3.2.
Lastly, we verify that the mean of Ṽi is 0. For any fixed j, k ∈ [K], let P be the ordered set of all
elements which are ranked higher than both j and k. Now conditioned on P, we have
exp(⟨θ⋆ , ϕ(si , aij )⟩)
exp(⟨θ⋆ , ϕ(si , aik )⟩)
− P(k follows P | P) · P
i
⋆
i
⋆
i i
k′ ∈P̄ exp(⟨θ , ϕ(s , ak′ )⟩)
k′ ∈P̄ exp(⟨θ , ϕ(s , ak′ )⟩)

i
E[Vjk
| P] = P(j follows P | P) · P

1
=P
·
⋆
i i
k′ ∈P̄ exp(⟨θ , ϕ(s , ak′ )⟩)

exp(⟨θ⋆ , ϕ(si , aij )⟩) exp(⟨θ⋆ , ϕ(si , aik )⟩) − exp(⟨θ⋆ , ϕ(si , aij )⟩) exp(⟨θ⋆ , ϕ(si , aik )⟩)
exp(⟨θ⋆ , ϕ(si , aij )⟩) + exp(⟨θ⋆ , ϕ(si , aik )⟩)

!

= 0.

Here the second equality uses the fact that j follows P is equivalent to the event that j is larger than
i
k and either j, k is the largest among P̄. Taking expectation over P gives us that E[Vjk
] = 0.

B.6

Proof of Theorem 4.2

This section presents the proof of Theorem 4.2 for the setting of K-wise comparisons. We first prove the
following lemma on the estimation error.
Lemma B.3. Under the K-wise PL model, for any λ > 0, with probability at least 1 − δ,
s
d + log(1/δ)
⋆
∥θ̂MLE2 − θ ∥ΣD +λI ≤ C ·
+ λB 2 .
γ2n
Recall that the pairwise compairson based estimator is given by
θ̂MLE2 ∈ arg min ℓD (θ),
θ∈ΘB
n K−1 K−1
1XX X
log
where ℓD (θ) = −
n i=1 j=0
k=j+1

exp(⟨θ, ϕ(si , aiσi (j) )⟩)

!

exp(⟨θ, ϕ(si , aiσi (j) )⟩) + exp(⟨θ, ϕ(si , aiσi (k) )⟩)

.

Our goal is to bound the estimation error of the MLE in the squared semi-norm ∥v∥2ΣD +λI =
v (ΣD + λI)v.
⊤

Strong convexity of ℓ.

Let xijk = ϕ(si , aij ) − ϕ(si , aik ). The gradient of the negative log likelihood is

∇ℓD (θ) = −

n K−1 K−1
exp(−⟨θ, xiσi (j)σi (k) )⟩
1XX X
· xi
.
n i=1 j=0
1 + exp(−⟨θ, xiσi (j)σi (k) )⟩ σi (j)σi (k)
k=j+1

The Hessian of the negative log likelihood can be written as
∇2 ℓD (θ) =

n K−1 K−1
exp(−⟨θ, xiσi (j)σi (k) )⟩
1XX X
· xi
xi⊤
.
n i=1 j=0
(1 + exp(−⟨θ, xiσi (j)σi (k) )⟩)2 σi (j)σi (k) σi (j)σi (k)
k=j

Since exp(⟨θ, xiσi (j)σi (k) ⟩) ∈ [exp(−2LB), exp(2LB)], we know that the coefficients satisfy
exp(−⟨θ, xiσi (j)σi (k) )⟩
(1 + exp(−⟨θ, xiσi (j)σi (k) )⟩)2

≥

29

1
.
2 + exp(2LB) + exp(−2LB)

1
Set γ = 2+exp(2LB)+exp(−2LB)
. We can verify that for any vector v ∈ RK , one has


n K−1
X
X K−1
X
γ
v
v ⊤ ∇2 ℓD (θ)v ≥ v ⊤ 
xiσi (j)σi (k) xi⊤
σi (j)σi (k)
n
i=1 j=0 k=j+1


n K−1 K−1
γ ⊤ X X X i i⊤ 
= v
xjk xjk v
n
i=1 j=0
k=j+1

⊤

= γK(K − 1)v ΣD v/2
= γK(K − 1)∥v∥2ΣD /2.
Thus we know that ℓ is γ-strongly convex with respect to the semi-norm ∥ · ∥ΣD .
Bounding the estimation error. Now we aim at bounding the estimation error ∥θ̂MLE2 − θ⋆ ∥ΣD+λI .
Since θ̂MLE2 is optimal for ℓD , we have ℓD (θ̂MLE2 ) ≤ ℓD (θ⋆ ). Defining the error vector ∆ = θ̂MLE2 − θ⋆ ,
adding and subtracting the quantity ⟨∇ℓD (θ⋆ ), ∆⟩ yields the bound
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≤ −⟨∇ℓD (θ⋆ ), ∆⟩.
By the γ-convexity condition, the left-hand side is lower bounded by γK(K − 1)∥∆∥2ΣD /2. As for the
right-hand side, note that |⟨∇ℓD (θ⋆ ), ∆⟩| ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI for any λ > 0. Altogether
we have
γ∥∆∥2ΣD ≤ 2∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI /K(K − 1).
Now we further bound the term ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 . Observe that the gradient takes the form
∇ℓD (θ⋆ ) = −

n K−1 K−1
exp(−⟨θ, xiσi (j)σi (k) )⟩
1XX X
· xi
.
n i=1 j=0
1 + exp(−⟨θ, xiσi (j)σi (k) )⟩ σi (j)σi (k)

(6)

k=j+1

PK
We set X ∈ R(nK(K−1)/2)×d with the differencing vector xijk as its (iK(K − 1)/2 + k + l=K−j+1 l)th
i
row. We also define Vjk
be the random variable of the coefficient of xijk in Equation (6) under the PL
model, i.e. conditioned on an arbitrary permutation σi ,

i
 exp(−⟨θ, xjki)⟩ ,
if σi−1 (j) < σi−1 (k)
1+exp(−⟨θ, xjk )⟩
i
Vjk =
1
−
, otherwise.
1+exp(−⟨θ, xi )⟩
jk

i
Let Ṽi ∈ RK(K−1)/2 be the concatenated random vector of {Vjk
}0≤j<k≤K−1 , V ∈ RnK(K−1)/2 be the
n
concatenated random vector of {Ṽi }i=1 . pWe know that Ṽi is independent for each i, and that V is
sub-Gaussian with mean 0 and parameter K(K − 1)/2 since the PL model reduces to BTL model when
considering pairwise comparisons. Now we know that the term ∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 can be written as

∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 =

1 ⊤
V X(ΣD + λI)−1 X ⊤ V.
n2

2

Let M = Kn I. One can verify that M ⪰ n12 X(ΣD + λI)−1 X ⊤ almost surely since λmax (X(ΣD +
λI)−1 X ⊤ /n2 ) ≤ K 2 /n. Thus we can upper bound the original term as
∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 ≤

K2
∥V ∥22 .
n

By Bernstein’s inequality for sub-Gaussian random variables in quadratic form (see e.g. Hsu et al.
(2012, Theorem 2.1)), we know that with probability at least 1 − δ,
∥V ∥22 ≤ CK(K − 1) · (d + log(1/δ)).
30

Thus altogether, we have
r

C · (d + log(1/δ))
∥∆∥ΣD +λI .
n
Similar to the pairwise comparison, we can derive that with probability at least 1 − δ,
r
d + log(1/δ)
⋆
+ λB 2 .
∥θ̂MLE2 − θ ∥ΣD +λI ≤ C ·
n
The rest of the proof on the sub-optimality upper bound follows the same argument as Theorem 3.2.
γ∥∆∥2ΣD ≤

B.7

Proof of Lemma 5.1

Recall that the MLE is given by
θ̂MLE ∈ arg min ℓD (θ),
θ∈ΘB
n
X

PH
exp( h=1 rθ (sih , aih ))
where ℓD (θ) = −
log 1(y = 1) ·
PH
PH
i′
exp( h=1 rθ (sih , aih )) + exp( h=1 rθ (si′
h , ah ))
i=1
PH

i′
exp( h=1 rθ (si′
h , ah ))
+ 1(y i = 0) ·
PH
P
H
i′
exp( h=1 rθ (sih , aih )) + exp( h=1 rθ (si′
h , ah ))
n

X
1
=−
log 1(y i = 1) ·
PH
i
i′
exp(− h=1 (rθ (sh , aih ) − rθ (si′
h , ah ))) + 1
i=1

1
+ 1(y i = 0) ·
PH
i′
exp( h=1 (rθ (sih , aih ) − rθ (si′
h , ah ))) + 1
n

X
1
=−
log 1(y i = 1) ·
PH
i
i′
exp(−⟨θ, h=1 (ϕ(sh , aih ) − ϕ(si′
h , ah ))⟩) + 1
i=1

1
+ 1(y i = 0) ·
PH
i′
exp(⟨θ, h=1 (ϕ(sih , aih ) − ϕ(si′
h , ah ))⟩) + 1
PH
i′
To simplify the notation, we let xi = h=1 (ϕ(sih , aih ) − ϕ(si′
h , ah )). Our goal is to bound the estimation
2
⊤
error of the MLE in the squared semi-norm ∥v∥ΣD +λI = v (ΣD + λI)v.


i

Strong convexity of ℓ. We first show that ℓD is strongly convex at θ⋆ with respect to the semi-norm
∥ · ∥ΣD , meaning that there is some constant γ > 0 such that
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≥ γ∥∆∥2ΣD

(7)

for all perturbations ∆ ∈ Rd such that θ⋆ + ∆ ∈ ΘB .
One can directly calculate the Hessian of ℓ as

n 
exp(−⟨θ, xi ⟩)
1X
exp(⟨θ, xi ⟩)
i
1(y i = 1) ·
∇2 ℓD (θ) =
+
1(y
=
0)
·
· xi x⊤
i ,
n i=1
(exp(−⟨θ, xi ⟩) + 1)2
(exp(⟨θ, xi ⟩) + 1)2
Observe that ⟨θ, xi ⟩ ∈ [−2HLB, 2HLB], we have
γ
v ⊤ ∇2 ℓD (θ)v ≥ ∥Xv∥22
n

for all v,

where γ = 1/(2 + exp(−2HLB) + exp(2HLB)), X ∈ Rn×d has the differencing vector xi ∈ Rd as its ith
row.
Thus, if we introduce the error vector ∆ := θ̂MLE − θ⋆ , then we may conclude that
γ
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≥ ∥X∆∥22 = γ∥∆∥2ΣD ,
n
showing that ℓD is strongly convex around θ⋆ with parameter γ.
31

Bounding the estimation error. Now we aim at bounding the estimation error ∥θ̂MLE − θ⋆ ∥ΣD .
Since θ̂MLE is optimal for ℓD , we have ℓD (θ̂MLE ) ≤ ℓD (θ⋆ ). Defining the error vector ∆ = θ̂MLE − θ⋆ ,
adding and subtracting the quantity ⟨∇ℓD (θ⋆ ), ∆⟩ yields the bound
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≤ −⟨∇ℓD (θ⋆ ), ∆⟩.
By the γ-convexity condition, the left-hand side is lower bounded by γ∥∆∥2ΣD . As for the right-hand side,
note that |⟨∇ℓD (θ⋆ ), ∆⟩| ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI for any λ > 0. Altogether we have
γ∥∆∥2ΣD ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI .
Now we further bound the term ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 . Observe that the gradient takes the form
∇ℓD (θ⋆ ) =


n 
−1 X
exp(−⟨θ⋆ , xi ⟩)
1
i
1[y i = 1]
−
1[y
=
0]
xi .
n i=1
1 + exp(−⟨θ⋆ , xi ⟩))
1 + exp(−⟨θ⋆ , xi ⟩))

Define a random vector V ∈ Rn with independent components as
( exp(−⟨θ⋆ , x ⟩)
1
i
w.p.
⋆ , x ⟩))
1+exp(−⟨θ ⋆ , xi ⟩))
i
Vi = 1+exp(−⟨θ
exp(−⟨θ ⋆ , xi ⟩)
−1
w.p.
1+exp(−⟨θ ⋆ , xi ⟩))
1+exp(−⟨θ ⋆ , xi ⟩)) .
With this notation, we have ∇ℓD (θ⋆ ) = − n1 X ⊤ V . One can verify that E[V ] = 0 and |Vi | ≤ 1.
Defining the n-dimensional square matrix M := n12 X(ΣD + λI)−1 X ⊤ , we have ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 =
V ⊤ M V . Let the eigenvalue decomposition of XX ⊤ be XX ⊤ = U ΛU ⊤ . We can bound the trace and
operator norm of M as
1
d
Tr(U (Λ/n + λI)−1 U ⊤ U ΛU ⊤ ) ≤
n2
n
1
∥M ∥op = λmax (M ) ≤ ,
n
Tr(M ) =

Moreover, since the components of V are independent and of zero mean, and |Vi | ≤ 1, the variables are
1-sub-Gaussian, and hence the Bernstein’s inequality for sub-Gaussian random variables in quadratic form
(see e.g. Hsu et al. (2012, Theorem 2.1)) implies that with probability at least 1 − δ,
∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 = V ⊤ M V ≤ C1 ·

d + log(1/δ)
.
n

Here C1 is some universal constant. This gives us
γ∥∆∥2ΣD +λI ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI + 4λγB 2
r
d + log(1/δ)
≤ C1 ·
∥∆∥ΣD +λI + 4λγB 2 .
n
Solving the above inequality gives us that for some constant C2 ,
s
d + log(1/δ)
∥∆∥ΣD +λI ≤ C2 ·
+ λB 2 .
γ2n

B.8

Proof of Theorem 5.2

Proof. From Lemma 5.1, we know that with probability at least 1 − δ,
s
d + log(1/δ)
∥θ̂MLE − θ⋆ ∥ΣD +λI ≤ C ·
+ λB 2 .
γ2n

32

Let J ′ (π) = J(π) − H⟨θ⋆ , v⟩. We have
SubOpt(π̂PE ) = J(π ⋆ ) − J(π̂PE )
= J ′ (π ⋆ ) − J ′ (π̂PE )
ˆ ⋆ )) + (J(π
ˆ ⋆ ) − J(π̂
ˆ PE )) + (J(π̂
ˆ PE ) − J ′ (π̂PE )).
= (J ′ (π ⋆ ) − J(π
ˆ
Since π̂PE is the optimal policy under expected value J(π),
we know that the second difference satisfies
⋆
ˆ
ˆ
J(π ) − J(π̂PE ) ≤ 0. For the third difference, we have
ˆ PE ) − J ′ (π̂PE ) = E π̂PE [r̂(s, π̂PE (s)) − r(s, π̂PE (s))].
J(π̂
s∼d
From Lemma 5.1 we know that θ⋆ ∈ Θ(θ̂MLE , λ) with probability at least 1 − δ. Thus we know that with
ˆ PE ) − J ′ (π̂PE ) ≤ 0. Now combining everything together, we have
probability at least 1 − δ, J(π̂
ˆ ⋆)
SubOpt(π̂PE ) ≤ J ′ (π ⋆ ) − J(π
=

sup

Es∼dπ⋆ [(θ⋆ − θ)⊤ (ϕ(s, π ⋆ (s)) − v)]

θ∈Θ(θ̂MLE ,λ)

=

sup

Es∼dπ⋆ [(θ⋆ − θ̂MLE + θ̂MLE − θ)⊤ (ϕ(s, π ⋆ (s)) − v)]

θ∈Θ(θ̂MLE ,λ)

= Es∼dπ⋆ [(θ⋆ − θ̂MLE )⊤ (ϕ(s, π ⋆ (s)) − v)] +

sup

Es∼dπ⋆ [(θ̂MLE − θ)⊤ (ϕ(s, π ⋆ (s)) − v)].

θ∈Θ(θ̂MLE ,λ)

By the definition
of Θ(θ̂MLE , λ), we know that for any θ ∈ Θ(θ̂MLE , λ), one has Es∼dπ⋆ [(θ̂MLE −θ)⊤ (ϕ(s, π ⋆ (s))−
q

v)] ≤ C ·

d+log(1/δ)
+ λB 2 · ∥(ΣD + λI)−1/2 Es∼dπ⋆ [ϕ(s, π ⋆ (s)) − v]∥2 .
γ2n

Furthermore, we know that

⋆

θ̂ ∈ Θ(θ̂MLE , λ) from Lemma 5.1. Altogether we have with probability 1 − 2δ
s
d + log(1/δ)
SubOpt(π̂PE ) ≤ 2C ·
+ λB 2 · ∥(ΣD + λI)−1/2 Es∼dπ⋆ [ϕ(s, π ⋆ (s)) − v]∥2 .
γ2n

B.9

Proof of Theorem 6.2

Proof. Here We mainly prove Lemma 6.1, since Theorem 6.2 is a direct corollary when combined with the
proof in Theorem 5.2.
Our goal is to bound the estimation error of the MLE in the squared semi-norm ∥v∥2ΣD +λI =
⊤
v (ΣD + λI)v.
Strong convexity of ℓ. We first show that ℓD is strongly convex at θ⋆ with respect to the semi-norm
∥ · ∥ΣD , meaning that there is some constant γ > 0 such that
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≥ γ∥∆∥2ΣD
for all perturbations ∆ ∈ Rd such that θ⋆ + ∆ ∈ ΘB .
The gradient of the negative log likelihood is
PH
n
exp( h=0 ⟨θ, ϕ(s′h , a′h )⟩)
1X X
∇ℓD (θ) = −
·
P
PH
′′ ′′
n i=1 ′
τ ′′ ∈T (si ) exp(
h=0 ⟨θ, ϕ(sh , ah )⟩)
τ ∈T (si )
0

0

H
X

(8)

!
(ϕ(sih , aih ) − ϕ(s′h , a′h )) .

h=0

PH

Let xiτ,τ ′ = h=0 (ϕ(sh , ah ) − ϕ(s′h , a′h )), where τ = {(sh , ah )}h∈[H] , τ ′ = {(s′h , a′h )}h∈[H] . The Hessian of
the negative log likelihood can be written as

=

∇2 ℓD (θ)
n
1X X

PH
exp( h=0 ⟨θ, ϕ(sh , ah ) + ϕ(s′h , a′h )⟩)
· xiτ,τ ′ xi⊤
P
PH
τ,τ ′ .
′′
′′
2
n i=1
2(
⟨θ,
ϕ(s
,
a
)⟩))
′′ ∈T (si ) exp(
i
i
′
τ
h=0
h
h
τ ∈T (s ) τ ∈T (s )
X

0

0

0

33

Since exp(⟨θ, ϕ⟩) ∈ [exp(−LB), exp(LB)], we know that the coefficients satisfy
PH
exp( h=0 ⟨θ, ϕ(sh , ah ) + ϕ(s′h , a′h )⟩)
exp(−4LB)
≥
.
P
PH
′′
′′
2
2
sups |T (s)|2
2( τ ′′ ∈T (si ) exp( h=0 ⟨θ, ϕ(sh , ah )⟩))
0

Set γ = exp(−4LB)/2. We can verify that for any vector v ∈ RK , one has
v ⊤ ∇2 ℓD (θ)v ≥ γv ⊤ ΣD v = γ∥v∥2ΣD .
Thus we know that ℓ is γ-strongly convex with respect to the semi-norm ∥ · ∥ΣD .
Bounding the estimation error. Now we aim at bounding the estimation error ∥θ̂MLE − θ⋆ ∥ΣD+λI .
Since θ̂MLE is optimal for ℓD , we have ℓD (θ̂MLE ) ≤ ℓD (θ⋆ ). Defining the error vector ∆ = θ̂MLE − θ⋆ ,
adding and subtracting the quantity ⟨∇ℓD (θ⋆ ), ∆⟩ yields the bound
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≤ −⟨∇ℓD (θ⋆ ), ∆⟩.
By the γ-convexity condition, the left-hand side is lower bounded by γ∥∆∥2ΣD . As for the right-hand side,
note that |⟨∇ℓD (θ⋆ ), ∆⟩| ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI for any λ > 0. Altogether we have
γ∥∆∥2ΣD ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI .
Now we further bound the term ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 . Observe that the gradient takes the form
PH
n
exp( h=0 ⟨θ⋆ , ϕ(s′h , a′h )⟩)
1X X
∇ℓD (θ ) = −
·
P
PH
⋆ , ϕ(s′′ , a′′ )⟩)
n i=1 ′
⟨θ
′′ ∈T (si ) exp(
i
τ
h=0
h
h
τ ∈T (s )
⋆

0

0

H
X

!

(ϕ(sih , aih ) − ϕ(s′h , a′h ))
h=0

.

(9)

We set X as the concatenated differencing vector xiτ,τ ′ where τ, τ ′ are distinct and ordered. We also define
i
i
Vτ,τ
′ be the random variable of the coefficient of xτ,τ ′ in Equation (9), i.e.
P

⟨θ ⋆ , ϕ(s′h ,a′h )⟩)
exp( H
h=0P

P
,
H

′′ ′′
⋆
exp(

i
′′
 τ ∈T (s0 ) P h=0 ⟨θ , ϕ(sh ,ah )⟩)
H
⋆
i
exp( h=0 ⟨θ , ϕ(sh ,ah )⟩)
Vτ,τ
′ =
P
−P
,
′′ ′′
⋆
exp( H

h=0 ⟨θ , ϕ(sh ,ah )⟩)
τ ′′ ∈T (si

0)


0

if τ = {(sih , aih )}h∈[H] ,
if τ ′ = {(sih , aih )}h∈[H] ,
otherwise.

i
n
Let Ṽi be the concatenated random vector of {Vτ,τ
′ }, V be the concatenated random vector of {Ṽi }i=1 .
We know that Ṽi and Ṽj are independent for each i ̸= j due to the independent sampling procedure. We
can also verify that the mean of Ṽi is 0. We know that Ṽi has almost sups |T (s)| non-zero elements. And
the sum of their absolute value is bounded by 1. we know Ṽi is 1-sub-Gaussian. Now we know that the
term ∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 can be written as

∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 =

1 ⊤
V X(ΣD + λI)−1 X ⊤ V.
n2

2

(s)|
Let M = sups |T
I. One can verify that M ⪰ n12 X(ΣD + λI)−1 X ⊤ almost surely since λmax (X(ΣD +
n
−1 ⊤
2
λI) X /n ) ≤ sups |T (s)|2 /n. Thus we can upper bound the original term as

∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 ≤

sups |T (s)|2
∥V ∥22 .
n

By Bernstein’s inequality for sub-Gaussian random variables in quadratic form (see e.g. Hsu et al. (2012,
Theorem 2.1)), we know that with probability at least 1 − δ,
∥V ∥22 ≤ C · (d + log(1/δ)).
34

Thus altogether, we have
r
γ∥∆∥2ΣD ≤

C sups |T (s)|2 · (d + log(1/δ))
∥∆∥ΣD +λI .
n

Similar to the pairwise comparison analysis in Appendix B.1, we can derive that with probability at least
1 − δ,
r
sups |T (s)|2 (d + log(1/δ))
⋆
∥θ̂MLE − θ ∥ΣD +λI ≤ C ·
+ λB 2 .
n
The rest of the proof on the sub-optimality upper bound follows the same argument as Theorem 5.2.

B.10

Proof of Theorem A.2

To simplify the notation, we let fθi = rθ (si , ai1 ) − rθ (si , ai0 ). We can see that the gradient of ℓ takes the
form

n 
exp(−fθi )
−1 X
1
i
i
1[y = 1]
∇ℓD (θ) =
− 1[y = 0]
∇fθi .
n i=1
1 + exp(−fθi ))
1 + exp(−fθi ))
And the Hessian of ℓ is

n 
exp(fθi )
1(y i = 1) · exp(−fθi )
1(y i = 0) · exp(fθi )
1X
i
i⊤
2 i
2 i
2
· ∇fθ ∇fθ −
· ∇ fθ +
· ∇ fθ .
∇ ℓD (θ) =
n i=1 (exp(fθi ) + 1)2
1 + exp(−fθi )
1 + exp(fθi )
Now from Assumption A.1, we have
n

∇2 ℓD (θ) ⪰

1X
γ∇fθi ∇fθi⊤ − 2α2 I.
n i=1

1
where γ = 2+exp(−2LB)+exp(2LB)
. Now from the Lipschitz gradient assumption we also know that
i
i
⋆
∥∇fθ − ∇fθ⋆ ∥ ≤ 2α2 ∥θ − θ∥. Let u = ∇fθi − ∇fθi⋆ , we have
n

∇2 ℓD (θ) ⪰

1X
γ(∇fθi⋆ + u)(∇fθi⋆ + u)⊤ − 2α2 I
n i=1
n

⪰

1X
i
⊤
γ∇fθi⋆ ∇fθi⊤
+ u∇fθi⊤
⋆ + γ(∇fθ ⋆ u
⋆ ) − 2α2 I.
n i=1

Since u⊤ v ≤ ∥u∥2 ∥v∥2 ≤ 2α2 B∥v∥2 , v ⊤ ∇fθi⋆ ≤ α1 ∥v∥2 , this gives that
v ⊤ ∇2 ℓD (θ)v ≥

γ
∥Xv∥22 − 2α2 (1 + 2γα1 B)∥v∥22
n

for all v,

where X ∈ Rn×d has the vector ∇fθi⋆ ∈ Rd as its ith row. Thus, if we introduce the error vector
∆ := θ̂MLE − θ⋆ , then we may conclude that
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≥

γ
∥X∆∥22 − 2α2 (1 + 2γα1 B)∥∆∥22 = γ∥∆∥2ΣD − 2α2 (1 + 2γα1 B)∥∆∥22 .
n

Bounding the estimation error. Now we aim at bounding the estimation error ∥θ̂MLE − θ⋆ ∥ΣD .
Since θ̂MLE is optimal for ℓD , we have ℓD (θ̂MLE ) ≤ ℓD (θ⋆ ). (When θ̂MLE is approximately optimal, i.e.
ℓD (θ̂MLE ) ≤ minθ ℓD (θ) + ϵ, the same argument also holds up to an extra additive term ϵ.) Defining the
error vector ∆ = θ̂MLE − θ⋆ , adding and subtracting the quantity ⟨∇ℓD (θ⋆ ), ∆⟩ yields the bound
ℓD (θ⋆ + ∆) − ℓD (θ⋆ ) − ⟨∇ℓD (θ⋆ ), ∆⟩ ≤ −⟨∇ℓD (θ⋆ ), ∆⟩.
35

We know the left-hand side is lower bounded by γ∥∆∥2ΣD − 2α2 (1 + 2γα1 B)∥∆∥22 . As for the right-hand
side, note that |⟨∇ℓD (θ⋆ ), ∆⟩| ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI for any λ > 0. Altogether we have
γ∥∆∥2ΣD ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI + β∥∆∥22 ,
where β = 2α2 (1 + 2γα1 B). Now we further bound the term ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 . Observe that the
gradient takes the form

n 
1
−1 X
exp(−fθi⋆ )
i
i
− 1[y = 0]
∇fθi⋆ .
∇ℓD (θ ) =
1[y = 1]
n i=1
1 + exp(−fθi⋆ ))
1 + exp(−fθi⋆ ))
⋆

Define a random vector V ∈ Rn with independent components as

i
1
 exp(−fθ⋆i )
w.p.
1+exp(−fθ⋆ ))
1+exp(−fθi⋆ ))
Vi =
exp(−fθi⋆ )
−1

w.p.
.
1+exp(−f i ))
1+exp(−f i ))
θ⋆

θ⋆

With this notation, we have ∇ℓD (θ⋆ ) = − n1 X ⊤ V . One can verify that E[V ] = 0 and |Vi | ≤ 1.
Defining the n-dimensional square matrix M := n12 X(ΣD + λI)−1 X ⊤ , we have ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 =
V ⊤ M V . Let the eigenvalue decomposition of X ⊤ X be X ⊤ X = U ΛU ⊤ . We can bound the trace and
operator norm of M as
1
d
Tr(U (Λ/n + λI)−1 U ⊤ U ΛU ⊤ ) ≤
n2
n
d
1
Tr(M 2 ) = 4 Tr(U (Λ/n + λI)−1 U ⊤ U ΛU ⊤ U (Λ/n + λI)−1 U ⊤ U ΛU ⊤ ) ≤ 2
n
n
1
∥M ∥op = λmax (M ) ≤ ,
n
Tr(M ) =

Moreover, since the components of V are independent and of zero mean, and |Vi | ≤ 1, the variables are
1-sub-Gaussian, and hence the Bernstein’s inequality for sub-Gaussian random variables in quadratic form
(see e.g. Hsu et al. (2012, Theorem 2.1)) implies that with probability at least 1 − δ,
∥∇ℓD (θ⋆ )∥2(ΣD +λI)−1 = V ⊤ M V ≤ C1 ·

d + log(1/δ)
.
n

Here C1 is some universal constant. This gives us
γ∥∆∥2ΣD +λI ≤ ∥∇ℓD (θ⋆ )∥(ΣD +λI)−1 ∥∆∥ΣD +λI + 4(λγ + 2α2 (1 + 2γα1 B))B 2
r
d + log(1/δ)
≤ C1 ·
∥∆∥ΣD +λI + 4(λγ + 2α2 (1 + 2γα1 B))B 2 .
n
Solving the above inequality gives us that for some constant C2 ,
s
d + log(1/δ)
∥∆∥ΣD +λI ≤ C2 ·
+ (λ + α2 /γ + α1 α2 B)B 2 .
γ2n

36

